{% extends 'base.html' %}

{% block title %}Incoming Applications{% endblock %}
{% block page_heading %}Incoming Applications{% endblock %}

{% block content %}
<div class="content-wrapper">
    <h1 class="page-heading">Incoming Applications</h1>

    {% if emails %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="input-group search-box" style="max-width: 300px;">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" id="searchInput" class="form-control" placeholder="Search applications...">
        </div>

        <div class="d-flex align-items-center">
            <div class="btn-group me-3" role="group" aria-label="Application filters">
                <button id="allApplicationsBtn" type="button" class="btn btn-outline-primary active">All</button>
                <button id="todaysApplicationsBtn" type="button" class="btn btn-outline-primary">Today</button>
            </div>
            <button id="exportCsvBtn" class="btn btn-success export-btn"><i class="fas fa-file-csv me-2"></i>Export</button>
        </div>
    </div>

    <div class="card p-4 shadow-subtle rounded-3">
        <div class="table-responsive">
            <table id="incomingApplicationsTable" class="table universal-table">
                <thead class="table-header">
                    <tr>
                        <th scope="col" class="id-col">Id</th>
                        <th scope="col" class="name-col">Candidate Name</th>
                        <th scope="col" class="date-col">Date Received</th>
                        <th scope="col" class="exp-col">Experience</th>
                        <th scope="col" class="mobile-col">Mobile Number</th>
                        <th scope="col" class="location-col">Location</th>
                        <th scope="col" class="email-col">Email</th>
                        <th scope="col" class="resume-col text-center">Resume</th>
                        <th scope="col" class="jd-col">Job Description</th>
                        <th scope="col" class="action-col text-center">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for email in emails %}
                    <tr data-delivery-date="{{ email.delivery_date|date:'Y-m-d' }}">
                        <td>{{ forloop.counter }}</td>
                        <td class="candidate-name-cell text-truncate">{{ email.candidate_name }}</td>
                        <td class="text-truncate">{{ email.delivery_date|date:"Y-m-d" }}</td>
                        <td class="text-truncate">{{ email.experience }}</td>
                        <td class="text-truncate">{{ email.mobile_number }}</td>
                        <td class="text-truncate">{{ email.location }}</td>
                        <td class="text-truncate">{{ email.email_address }}</td>
                        <td class="text-center">
                            {% if email.resume_url %}
                                <a href="{{ email.resume_url }}" target="_blank" class="btn btn-sm btn-outline-secondary btn-view-resume">View</a>
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            <select class="form-select job-description-select">
                                <option value="" selected>Select JD</option>
                                {% for jd in job_descriptions %}
                                    <option value="{{ jd.id }}" data-file-url="{{ jd.file.url }}">{{ jd.title }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class="text-center">
                            <button type="button" class="btn btn-sm btn-primary btn-analyze" data-bs-toggle="modal" data-bs-target="#atsOptionsModal" data-email-id="{{ email.id }}">
                                Analyze
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div id="noApplicationsMessage" class="text-center p-5 text-muted" style="display: none;">
            <p><i class="fas fa-inbox fa-3x mb-3"></i></p>
            <h4 class="fw-light">No applications found for this filter.</h4>
        </div>

        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center" id="pagination-controls"></ul>
        </nav>
    </div>
    {% else %}
    <div class="text-center card p-5 mt-5 shadow-lg custom-card">
        <h3 class="text-muted">No incoming applications found.</h3>
        <p>This section will display emails with attached resumes for processing.</p>
        <p>Please ensure that Outlook is open and configured correctly on your local system.</p>
    </div>
    {% endif %}
</div>

<div class="modal fade" id="atsOptionsModal" tabindex="-1" aria-labelledby="atsOptionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg rounded-3">
            <div class="modal-header bg-primary text-white border-0 rounded-top-3">
                <h5 class="modal-title" id="atsOptionsModalLabel">Choose ATS Analysis</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <p class="text-muted fw-light">Select the type of ATS analysis to perform:</p>
                <div id="atsOptionsButtons" class="d-flex flex-column align-items-center mt-4">
                <a href="#" id="basicAtsBtn" class="btn btn-outline-primary btn-lg w-75 mb-3" data-dismiss="modal">
                    <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
                    <span class="button-text">Basic</span>
                </a>
                <a href="#" id="premiumAtsBtn" class="btn btn-primary btn-lg w-75" data-dismiss="modal">
                    <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
                    <span class="button-text">Advanced</span>
                </a>
                </div>
            </div>
            <div class="modal-footer justify-content-center border-0 bg-light-subtle rounded-bottom-3">
                <button type="button" class="btn btn-secondary universal-btn" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    :root {
        --primary-color: #0d6efd;
        --secondary-color: #6c757d;
        --light-bg-color: #f8f9fa;
        --table-bg-odd: #f8faff;
        --table-bg-even: #ffffff;
    }
    body {
        font-family: 'Inter', sans-serif;
        background-color: var(--light-bg-color);
        color: #343a40;
    }
    .page-heading {
        font-size: 2.5rem;
        color: var(--primary-color);
        margin-bottom: 2rem;
        text-align: center;
        font-weight: 700;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
    }
    .card {
        border: 1px solid #e9ecef;
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.05) !important;
        background-color: white;
    }
    .shadow-subtle {
        box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.08) !important;
    }
    /* Filter Buttons & Search Input */
    .search-box .input-group-text {
        background-color: #e9ecef;
        border-color: #dee2e6;
        color: var(--secondary-color);
    }
    .search-box .form-control {
        border-color: #dee2e6;
    }
    .search-box .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    .btn-group .btn {
        font-weight: 500;
    }
    .btn-group .btn-outline-primary {
        border-color: #ced4da;
    }
    .btn-group .btn-outline-primary.active {
        background-color: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .export-btn {
        font-weight: 500;
        transition: transform 0.2s;
    }
    .export-btn:hover {
        transform: translateY(-2px);
    }
    /* Table Styling */
    .universal-table {
        border-collapse: separate;
        border-spacing: 0;
        width: 100%;
    }
    .universal-table thead th {
        background-color: var(--primary-color);
        color: white;
        text-transform: uppercase;
        font-size: 0.85rem;
        padding: 1rem;
        border: none;
    }
    .universal-table tbody tr {
        transition: background-color 0.2s;
    }
    .universal-table tbody tr:nth-child(odd) {
        background-color: var(--table-bg-odd);
    }
    .universal-table tbody tr:nth-child(even) {
        background-color: var(--table-bg-even);
    }
    .universal-table tbody tr:hover {
        background-color: #e0f2ff;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    .universal-table td {
        padding: 1rem;
        border-top: 1px solid #e9ecef;
        vertical-align: middle;
        font-size: 0.95rem;
    }
    .id-col { width: 5%; }
    .name-col { width: 15%; }
    .date-col { width: 10%; }
    .exp-col { width: 8%; }
    .mobile-col { width: 10%; }
    .location-col { width: 10%; }
    .email-col { width: 15%; }
    .resume-col { width: 7%; }
    .jd-col { width: 10%; }
    .action-col { width: 10%; }
    
    .table-responsive {
        border-radius: 0.5rem;
        overflow: hidden;
    }

    /* Resume URL and Action Buttons */
    .btn-view-resume {
        padding: 0.25rem 0.75rem;
        font-size: 0.8rem;
    }
    .btn-analyze {
        font-size: 0.8rem;
        padding: 0.25rem 0.75rem;
    }
    .job-description-select {
        font-size: 0.85rem;
        padding: 0.375rem 0.75rem;
        height: auto;
    }

    /* Modal Styling */
    .modal-header {
        border-bottom: none;
    }
    .modal-body p {
        font-size: 1.1rem;
    }
    .modal-body .btn-lg {
        font-size: 1.25rem;
        font-weight: 600;
        transition: transform 0.2s;
    }
    .modal-body .btn-lg:hover {
        transform: translateY(-3px);
    }
    .modal-footer {
        border-top: none;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function() {
        const rows = $("#incomingApplicationsTable tbody tr");
        const paginationControls = $("#pagination-controls");
        const rowsPerPage = 10;
        let currentPage = 1;

        function displayRows(page) {
            rows.hide();
            let start = (page - 1) * rowsPerPage;
            let end = start + rowsPerPage;
            rows.slice(start, end).show();
        }

        function setupPagination() {
            const numRows = $("#incomingApplicationsTable tbody tr:visible").length;
            const numPages = Math.ceil(numRows / rowsPerPage);
            paginationControls.empty();

            for (let i = 1; i <= numPages; i++) {
                const li = $('<li>').addClass('page-item');
                const a = $('<a>').addClass('page-link').attr('href', '#').text(i);
                if (i === currentPage) {
                    li.addClass('active');
                }
                a.on('click', function(e) {
                    e.preventDefault();
                    currentPage = i;
                    displayRows(currentPage);
                    $('.page-item').removeClass('active');
                    li.addClass('active');
                    window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top
                });
                li.append(a);
                paginationControls.append(li);
            }

            if (numPages <= 1) {
                paginationControls.hide();
            } else {
                paginationControls.show();
            }
        }

        function filterAndPaginate() {
            const filter = $('#searchInput').val().toLowerCase();
            const isToday = $('#todaysApplicationsBtn').hasClass('active');
            const todayDate = new Date().toISOString().slice(0, 10);

            let hasVisibleRows = false;
            rows.each(function() {
                const row = $(this);
                const text = row.text().toLowerCase();
                const deliveryDate = row.data('delivery-date');
                const dateMatch = isToday ? (deliveryDate === todayDate) : true;
                const textMatch = text.includes(filter);

                if (textMatch && dateMatch) {
                    row.show();
                    hasVisibleRows = true;
                } else {
                    row.hide();
                }
            });

            if (hasVisibleRows) {
                $('#noApplicationsMessage').hide();
                displayRows(currentPage);
                setupPagination();
            } else {
                $('#noApplicationsMessage').show();
                paginationControls.empty();
            }
        }

        // Event listeners for search and filters
        $('#searchInput').on('keyup', function() {
            currentPage = 1;
            filterAndPaginate();
        });

        $('#allApplicationsBtn').on('click', function() {
            $(this).addClass('active').siblings().removeClass('active');
            currentPage = 1;
            filterAndPaginate();
        });

        $('#todaysApplicationsBtn').on('click', function() {
            $(this).addClass('active').siblings().removeClass('active');
            currentPage = 1;
            filterAndPaginate();
        });

        // Event listener for the "Analyze" button to set up modal links
        let currentEmailId;
        $('#incomingApplicationsTable').on('click', '.btn-analyze', function() {
            currentEmailId = $(this).data('email-id');
        });

        // Event listener for the "Advanced" button in the modal
        $('#premiumAtsBtn').on('click', function(e) {
            e.preventDefault();
            const $currentRow = $(`[data-email-id="${currentEmailId}"]`).closest('tr');
            const selectedJdId = $currentRow.find('.job-description-select').val();

            if (!selectedJdId) {
                alert("Please select a job description before proceeding.");
                return;
            }

            const url = `/advance_resume_analysis/?application_id=${currentEmailId}&job_description_id=${selectedJdId}`;
            
            const $button = $(this);
            $button.prop('disabled', true);
            $button.find('.button-text').text('Loading...');
            $button.find('.spinner-border').removeClass('d-none');
            
            setTimeout(() => {
                window.location.href = url;
            }, 500);
        });

        // Event listener for the "Basic" button in the modal
        $('#basicAtsBtn').on('click', function(e) {
            e.preventDefault();
            const url = `/basic_resume_analysis/?application_id=${currentEmailId}`;
            
            const $button = $(this);
            $button.prop('disabled', true);
            $button.find('.button-text').text('Loading...');
            $button.find('.spinner-border').removeClass('d-none');
            
            setTimeout(() => {
                window.location.href = url;
            }, 500);
        });

        // Initial display of rows
        filterAndPaginate();
    });
</script>
{% endblock %}