{% extends 'base.html' %}
{% load static %}

{% block title %}Incoming Applications{% endblock %}

{% block content %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
<style>
    /* ------------------------------------------- */
    /* === CUSTOM COLOR PALETTE IMPLEMENTATION === */
    /* ------------------------------------------- */
    :root {
        --color-primary: #3e4f47; /* Dark Slate/Green */
        --color-accent: orangered; /* Action/Danger */
        --color-neutral: #bab3a9; /* Muted Tan */
        --color-dark-text: #333333; /* Dark Gray for general text/outline */
    }

    /* Override Bootstrap primary color for table header and other components */
    .bg-primary {
        background-color: var(--color-primary) !important;
    }
    .text-primary {
        color: var(--color-primary) !important;
    }
    
    /* ------------------------------------------- */
    /* === TABLE FORMAT IMPROVEMENTS === */
    /* ------------------------------------------- */
    
    /* Ensure outer container has rounded corners */
    .rounded-3 {
        border-radius: 0.5rem !important;
        overflow: hidden; /* Crucial for rounded corners on inner table elements */
    }

    /* Table Header Styling */
    .table thead th {
        vertical-align: middle;
        white-space: nowrap; 
        background-color: var(--color-primary); 
        color: white;
        /* Added vertical padding for a cleaner header bar */
        padding-top: 0.75rem; 
        padding-bottom: 0.75rem;
    }
    
    /* Add a subtle border to separate rows more clearly for a cleaner look */
    /* This overrides the default minimal striped look */
    .table-striped tbody tr {
        border-top: 1px solid #e9ecef; /* Light gray border */
    }

    .table-hover tbody tr:hover {
        background-color: #f5f5f5;
    }

    /* Center text in key score/action columns for better visual balance */
    .table thead th:nth-child(5), /* Aggregate Score Header */
    .table tbody td:nth-child(5), /* Aggregate Score Data */
    .table tbody td:nth-child(8), /* Basic ATS Score */
    .table tbody td:nth-child(9), /* Advanced ATS */
    .table tbody td:nth-child(10), /* View Profile */
    .table tbody td:nth-child(11), /* Resume */
    .table tbody td:nth-child(12) { /* Actions */
        text-align: center;
    }

    /* Score Badge Styling (VISUALLY IMPLEMENTED) */
    .badge {
        font-size: 0.85em;
        padding: 0.4em 0.6em;
        min-width: 80px; /* Reduced min-width slightly for tighter columns */
        display: inline-flex; 
        align-items: center;
        justify-content: center;
        font-weight: 600;
        border-radius: 0.35rem; 
    }
    .score-badge-high { background-color: #28a745; color: white; } /* Green */
    .score-badge-medium { background-color: #ffc107; color: #343a40; } /* Yellow/Orange */
    .score-badge-low { background-color: var(--color-accent); color: white; } /* Orangered/Red */


    /* Filter Button Styles (Unchanged) */
    .btn-filter-date, .btn-filter-source, .btn-filter-ats {
        background-color: var(--color-neutral); /* Muted Tan for inactive */
        color: var(--color-dark-text); /* Dark text */
        border: 1px solid var(--color-neutral);
        font-weight: 500;
        padding: 0.25rem 0.6rem;
    }
    .btn-filter-date.active, .btn-filter-source.active, .btn-filter-ats.active {
        background-color: var(--color-primary); /* Dark Slate/Green for active */
        color: white;
        border-color: var(--color-primary);
    }
    .filter-group {
        display: flex;
        align-items: center;
        margin-right: 1.5rem !important;
    }
    .filter-label {
        font-weight: 600; 
        margin-right: 8px;
        white-space: nowrap;
    }

    /* Action Button Customization: Run ATS Button */
    .btn-outline-dark, .btn-outline-secondary, .btn-outline-primary {
        border-color: var(--color-primary);
        color: var(--color-primary);
        transition: all 0.2s;
        /* Ensure Run ATS buttons are small and compact */
        padding: 0.25rem 0.5rem;
        font-size: 0.85rem;
    }
    .btn-outline-dark:hover, .btn-outline-secondary:hover, .btn-outline-primary:hover {
        background-color: var(--color-primary);
        color: white;
        border-color: var(--color-primary);
    }
    
    /* Style for the View ATS Links (for when analysis exists) */
    .btn-ats-view {
        color: var(--color-primary) !important; 
        font-weight: 600; /* Made slightly bolder */
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        padding: 0.5rem;
        font-size: 0.9rem; /* Slightly smaller text */
    }
    .btn-ats-view:hover {
        text-decoration: underline;
    }


    /* Icon-Only Buttons (View Profile, Resume, Delete) */
    .btn-icon-action {
        width: 35px; /* Fixed width for better alignment */
        height: 35px; /* Fixed height for better alignment */
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem; /* Larger icon size */
        border-radius: 0.25rem;
    }
    .btn-info {
        background-color: #17a2b8 !important; /* Standard info blue */
        border-color: #17a2b8 !important;
    }
    .btn-danger {
        background-color: var(--color-accent) !important; 
        border-color: var(--color-accent) !important;
        color: white !important;
    }
    
    /* Loader/Modal styles (Unchanged) */
    .loader-content h4 {
        color: var(--color-primary); 
    }
    
    #fullPageLoader {
        display: none; 
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.95); 
        z-index: 1050; 
        justify-content: center;
        align-items: center;
        flex-direction: column;
        text-align: center;
        padding: 20px;
    }

    .loader-content {
        max-width: 400px;
        padding: 30px;
        background: #ffffff;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    @keyframes robot-float {
        0% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0); }
    }
    .robot-floating {
        animation: robot-float 2s ease-in-out infinite; 
    }

</style>

<div id="fullPageLoader">
    <div class="loader-content">
        <i class="fas fa-robot fa-3x text-primary mb-3 robot-floating"></i>
        <h4>Running ATS Analysis...</h4>
        <p class="text-muted">This may take a moment while the AI analyzes the resume against the job description.</p>
        <div class="progress">
            <div id="loaderProgressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                <strong id="progressPercentage">0%</strong>
            </div>
        </div>
        <small class="text-secondary mt-2" id="progressStatus">Starting analysis...</small>
    </div>
</div>
<div class="content-wrapper">
    <div id="alertMessageContainer" class="position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index: 2000; min-width: 400px;">
        </div>

    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {% if emails %}
    <div class="card p-3 mb-4 shadow-subtle rounded-3">
        <div class="row align-items-center g-3">
            <div class="col-lg-4 col-md-6 col-12">
                <div class="input-group search-box">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" id="searchInput" class="form-control" placeholder="Search by name, email, phone...">
                </div>
            </div>

            <div class="col-lg-8 col-md-6 col-12 d-flex flex-wrap justify-content-md-end align-items-center">
                <div class="filter-group me-3 mb-2 mb-md-0">
                    <span class="filter-label">Date:</span>
                    <div class="btn-group" role="group" id="dateFilterGroup">
                        <button id="allApplicationsBtn" type="button" class="btn btn-filter-date active" data-filter="all">All</button>
                        <button id="todaysApplicationsBtn" type="button" class="btn btn-filter-date" data-filter="today">Today</button>
                    </div>
                </div>

                <div class="filter-group me-3 mb-2 mb-md-0">
                    <span class="filter-label">Source:</span>
                    <div class="btn-group" role="group" id="sourceFilterGroup">
                        <button type="button" class="btn btn-filter-source active" data-filter="all">All</button>
                        <button type="button" class="btn btn-filter-source" data-filter="web">Web</button>
                        <button type="button" class="btn btn-filter-source" data-filter="referral">Referral</button>
                    </div>
                </div>
                
                <div class="filter-group mb-2 mb-md-0">
                    <span class="filter-label">ATS Score:</span>
                    <div class="btn-group" role="group" id="atsFilterGroup">
                        <button type="button" class="btn btn-filter-ats active" data-filter="all">All</button>
                        <button type="button" class="btn btn-filter-ats" data-filter="high">High (> 70%)</button>
                        <button type="button" class="btn btn-filter-ats" data-filter="medium">Medium (40%-70%)</button>
                        <button type="button" class="btn btn-filter-ats" data-filter="low">Low (< 40%)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card shadow-subtle rounded-3">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped table-sm rounded-3 overflow-hidden" id="applicationsTable">
                    <thead class="bg-primary text-white">
                        <tr class="text-center">
                            <th scope="col">Id</th>
                            <th scope="col">Applicant Name</th>
                            <th scope="col">Email</th>
                            <th scope="col">Phone No.</th>
                            <th scope="col" class="text-center">Aggregate Score</th> 
                            <th scope="col">Job Role</th>
                            <th scope="col">Applied Date</th>
                            <th scope="col">Interview Status</th>
                            <th scope="col" class="text-center">Basic ATS Score</th>
                            <th scope="col" class="text-center">Advanced ATS</th>
                            <th scope="col" class="text-center">Profile</th>
                            <th scope="col" class="text-center">Resume</th>
                            <th scope="col" class="text-center">Actions</th> </tr>
                    </thead>
                    <tbody>
                        {% for email in emails %}
                        <tr class="text-center" data-date="{{ email.date_applied|date:'Y-m-d' }}" data-source="{{ email.source|lower|default:'web' }}" data-ats="{{ email.basic_ats_score|default:'0' }}" id="application-row-{{ email.pk }}">
                            <td>
                                <strong>{{forloop.counter}}</strong>
                            </td>
                            <td>
                                <strong>{{ email.first_name }} {{ email.last_name }}</strong>
                            </td>
                            <td>
                                {{ email.email }}
                            </td>
                            <td>
                                {{email.phone}}
                            </td>
                            <td class="text-center">      
                                <span class="badge score-badge-high">{{ email.aggregate_score }}%</span>
                            </td>
                            <td>{{ email.career.title }}</td>
                            <td>{{ email.date_applied|date:"Y-m-d H:i" }}</td>
                            <!-- <td>{{ email.final_decision }}</td> -->
                            <td class="text-center">
                                {% if "Interview" in email.final_decision %}
                                    <span class="badge bg-success">{{ email.final_decision }}</span>
                                {% elif "Review" in email.final_decision %}
                                    <span class="badge bg-warning text-dark">{{ email.final_decision }}</span>
                                {% elif "Pending" in email.final_decision %}
                                    <span class="badge bg-secondary">{{ email.final_decision }}</span>
                                {% else %}
                                    <span class="badge bg-danger">{{ email.final_decision }}</span>
                                {% endif %}
                            </td>


                            <td class="text-center">
                                {% if email.basic_analysis_exists and not email.basic_ats_in_progress %}
                                    <a href="{% url 'candidate_profile' email.basic_analysis_id %}" class="btn-ats-view" title="View Basic Analysis Details"> 
                                        <i class="fas fa-eye me-1"></i>&nbsp;View Basic ATS
                                    </a>
                                {% elif email.basic_ats_in_progress %}
                                    <span class="text-warning d-flex align-items-center justify-content-center">
                                        <div class="spinner-border spinner-border-sm me-2" role="status">
                                            <span class="visually-hidden">Processing...</span>
                                        </div>
                                        Processing...
                                    </span>
                                {% elif email.selected_job_desc_id %}
                                    <a href="{% url 'resume_analysis' %}?app_id={{ email.pk }}&jd_id={{ email.selected_job_desc_id }}&analysis_mode=basic_ats" class="btn btn-sm btn-outline-dark run-ats-btn" data-type="Basic" title="Run Basic ATS Analysis">
                                        <i class="fas fa-robot btn-icon"></i> <span class="btn-text">Run Basic ATS</span>
                                    </a>
                                {% else %}
                                    <span class="text-muted" data-bs-toggle="tooltip" title="No matching Job Description found.">N/A</span>
                                {% endif %}
                            </td>

                            <td class="text-center">
                                {% if email.advanced_analysis_exists and not email.advanced_ats_in_progress %}
                                    <a href="{% url 'candidate_profile' email.advanced_analysis_id %}" class="btn-ats-view" title="View Advanced AI Analysis Details"> 
                                        <i class="fas fa-eye me-1"></i>&nbsp;View Advance ATS
                                    </a>
                                {% elif email.advanced_ats_in_progress %}
                                    <span class="text-warning d-flex align-items-center justify-content-center">
                                        <div class="spinner-border spinner-border-sm me-2" role="status">
                                            <span class="visually-hidden">Processing...</span>
                                        </div>
                                        Processing...
                                    </span>
                                {% elif email.selected_job_desc_id %}
                                    <a href="{% url 'resume_analysis' %}?app_id={{ email.pk }}&jd_id={{ email.selected_job_desc_id }}&analysis_mode=advanced_ai" class="btn btn-sm btn-outline-dark run-ats-btn" data-type="Advance" title="Run Advanced AI Analysis">
                                        <i class="fas fa-robot btn-icon"></i> <span class="btn-text">Run Advance ATS</span>
                                    </a>
                                {% else %}
                                    <span class="text-muted" data-bs-toggle="tooltip" title="No matching Job Description found.">N/A</span>
                                {% endif %}
                            </td>
                            <td class="text-center" >
                                <a href="{{ email.linkedin_url}}" target="_blank" class="btn btn-icon-action" title="View Candidate Profile"> 
                                    <i class="fas fa-eye"></i>
                                </a>
                            </td>

                            <td class="text-center">
                                <a href="{{ email.resume.url }}" target="_blank" class="btn btn-icon-action" title="Download/View Resume" style="color: red;">
                                    <i class="fas fa-file-pdf"></i>
                                </a>
                            </td>
                            
                            <td class="text-center">
                                <button class="btn btn-icon-action" data-app-id="{{ email.pk }}" data-app-name="{{ email.first_name }} {{ email.last_name }}" title="Delete Application" data-bs-toggle="modal" data-bs-target="#deleteConfirmationModal">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div id="noResults" class="text-center p-5" style="display:none;">
                <p class="lead">No applications match your current filters.</p>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info">
        No applications found.
    </div>
    {% endif %}

    
    <div class="modal fade" id="analysisModal" tabindex="-1" aria-labelledby="analysisModalLabel" aria-hidden="true" >
        </div>
    
    <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteConfirmationModalLabel"><i class="fas fa-exclamation-triangle"></i> Confirm Permanent Deletion</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>You are about to permanently delete the application for: <strong><span id="appNamePlaceholder"></span></strong>.</p>
                    <p class="text-danger">This action cannot be undone. All associated data (including analysis scores) will be lost.</p>
                    <p>Are you sure you want to proceed?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn" data-app-id="">Delete Permanently</button>
                </div>
            </div>
        </div>
    </div>
    </div>

{% endblock %}


{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // Helper function to get Django's CSRF token for secure POST/DELETE requests
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    
    // === NEW FUNCTION: Replaces the disruptive alert() with a Bootstrap alert ===
    function displayAlert(message, type = 'success') {
        const icon = type === 'success' ? 'fas fa-check-circle' : 'fas fa-times-circle';
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                <i class="${icon} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        
        const $container = $('#alertMessageContainer');
        $container.html(alertHtml);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            $container.find('.alert').alert('close');
        }, 5000);
    }


    $(document).ready(function() {
        
        // Function to handle the actual AJAX deletion
        function executeDelete(appId, appName) {
            
            // Disable button during process
            const $btn = $('#confirmDeleteBtn');
            $btn.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Deleting...');
            $btn.prop('disabled', true);

            $.ajax({
                url: `/api/delete-application/${appId}/`, // Assuming your Django URL is here
                method: 'POST', 
                headers: {
                    'X-CSRFToken': csrftoken, 
                },
                data: {
                    '_method': 'DELETE' 
                },
                success: function(response) {
                    $('#deleteConfirmationModal').modal('hide');
                    if (response.success) {
                        // Use custom function instead of alert()
                        displayAlert(`Application for ${appName} successfully deleted.`, 'success');
                        
                        // Remove the row from the table on success with a fade out effect
                        $(`#application-row-${appId}`).fadeOut(500, function() {
                            $(this).remove();
                            // Re-run filterAndPaginate to update counts if necessary
                            filterAndPaginate(); 
                        });
                    } else {
                        // Use custom function instead of alert()
                        displayAlert(`Error deleting application: ${response.message || 'Unknown error.'}`, 'danger');
                    }
                },
                error: function(xhr) {
                    $('#deleteConfirmationModal').modal('hide');
                    let message = "An error occurred during the deletion process. Please check your server logs.";
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        message = xhr.responseJSON.message;
                    } else if (xhr.status === 404) {
                        message = `Application not found (ID: ${appId}).`;
                    }
                    // Use custom function instead of alert()
                    displayAlert(`Deletion Error: ${message}`, 'danger');
                },
                complete: function() {
                    // Reset button state
                    $btn.html('Delete Permanently');
                    $btn.prop('disabled', false);
                    $btn.removeData('app-id'); // Clear data
                    $btn.removeData('app-name');
                }
            });
        }


        // === 1. FULL PAGE LOADER LOGIC (For 'Run ATS' buttons) ===
        $('.run-ats-btn').on('click', function(e) {
            e.preventDefault(); 
            
            const targetUrl = $(this).attr('href');
            const $loader = $('#fullPageLoader');
            const $progressBar = $('#loaderProgressBar');
            const $percentageText = $('#progressPercentage');
            const $statusText = $('#progressStatus');
            const $robotIcon = $('.robot-floating');
            
            // Add the floating class if it's missing (it was removed from the html class attribute)
            if (!$robotIcon.hasClass('robot-floating')) {
                $robotIcon.addClass('robot-floating');
            }

            // Reset and show the loader immediately
            $progressBar.css('width', '0%').attr('aria-valuenow', 0).removeClass('bg-success');
            $percentageText.text('0%');
            $statusText.text('Starting analysis...');
            $loader.css('display', 'flex'); 
            
            // Configuration for time-based progress
            const MIN_DURATION = 5000; 
            const startTime = Date.now();
            let progress = 0;
            
            // Status updates linked to time milestones
            const statusSteps = [
                { time: 500, status: 'Initializing AI model...' },
                { time: 1500, status: 'Parsing resume and job description...' },
                { time: 3000, status: 'Performing skills and experience matching...' },
                { time: 4500, status: 'Generating fitment score and recommendations...' }
            ];
            let nextStatusIndex = 0;

            function updateProgress() {
                const elapsedTime = Date.now() - startTime;
                let linearProgress = (elapsedTime / MIN_DURATION) * 100;
                
                let visualProgress;
                let isComplete = false;
                
                if (elapsedTime >= MIN_DURATION) {
                    visualProgress = 100;
                    isComplete = true;
                } else {
                    visualProgress = Math.min(99, Math.floor(linearProgress));
                }

                if (visualProgress > progress) {
                    progress = visualProgress;
                    $progressBar.css('width', progress + '%').attr('aria-valuenow', progress);
                    $percentageText.text(progress + '%');
                }

                if (nextStatusIndex < statusSteps.length && elapsedTime >= statusSteps[nextStatusIndex].time) {
                    $statusText.text(statusSteps[nextStatusIndex].status);
                    nextStatusIndex++;
                } else if (progress === 100) {
                    $statusText.text('Analysis complete! Redirecting...');
                }

                if (isComplete) {
                    clearInterval(interval);
                    
                    $progressBar.css('width', '100%').attr('aria-valuenow', 100).addClass('bg-success');
                    $percentageText.text('100%');
                    
                    setTimeout(() => {
                        window.location.href = targetUrl;
                    }, 500); 
                }
            }

            const interval = setInterval(updateProgress, 50); 
        });


        // === 2. DELETE APPLICATION MODAL HANDLERS ===
        
        // 2a. Handle the click on the table's delete button (to open modal)
        $(document).on('click', '.btn-icon-action.btn-danger', function() {
            const appId = $(this).data('app-id');
            const appName = $(this).data('app-name');
            
            // Set data attributes on the confirmation button and text in the modal
            $('#appNamePlaceholder').text(appName);
            $('#confirmDeleteBtn').data('app-id', appId);
            $('#confirmDeleteBtn').data('app-name', appName);
        });

        // 2b. Handle the click on the modal's confirmation button (to execute delete)
        $('#confirmDeleteBtn').on('click', function() {
            const appId = $(this).data('app-id');
            const appName = $(this).data('app-name');
            
            if (appId) {
                executeDelete(appId, appName);
            } else {
                displayAlert("Error: Application ID not found for deletion.", 'danger');
                $('#deleteConfirmationModal').modal('hide');
            }
        });


        // --- 3. Filter and Pagination Logic ---

        const applicationsTable = $('#applicationsTable tbody');
        let rows = applicationsTable.find('tr').toArray(); 
        const today = new Date().toISOString().slice(0, 10);

        function filterAndPaginate() {
            // Re-select rows to include/exclude recently deleted rows
            rows = applicationsTable.find('tr').toArray();

            const searchText = $('#searchInput').val().toLowerCase();
            const dateFilter = $('#dateFilterGroup .btn.active').data('filter');
            const sourceFilter = $('#sourceFilterGroup .btn.active').data('filter');
            const atsFilter = $('#atsFilterGroup .btn.active').data('filter');
            
            let visibleRowsCount = 0;

            rows.forEach(row => {
                const $row = $(row);
                const rowText = $row.text().toLowerCase();
                const rowDate = $row.data('date');
                const rowSource = $row.data('source');
                const rowAts = parseFloat($row.data('ats'));

                let isVisible = true;

                // Search Filter
                if (searchText && rowText.indexOf(searchText) === -1) {
                    isVisible = false;
                }
                
                // Date Filter
                if (isVisible && dateFilter === 'today' && rowDate !== today) {
                    isVisible = false;
                }

                // Source Filter
                if (isVisible && sourceFilter !== 'all' && rowSource !== sourceFilter) {
                    isVisible = false;
                }

                // ATS Score Filter
                if (isVisible && atsFilter !== 'all') {
                    if (atsFilter === 'high' && rowAts < 70) {
                        isVisible = false;
                    } else if (atsFilter === 'medium' && (rowAts < 40 || rowAts >= 70)) {
                        isVisible = false;
                    } else if (atsFilter === 'low' && rowAts >= 40) {
                        isVisible = false;
                    }
                }
                
                $row.toggle(isVisible);
                if (isVisible) {
                    visibleRowsCount++;
                }
            });

            $('#noResults').toggle(visibleRowsCount === 0);
        }

        // --- 4. Advanced Analysis Modal Logic (Unchanged) ---
        // (If there was logic here, it remains unchanged)

        // --- 5. Filter Event Listeners ---

        $('#searchInput').on('keyup', filterAndPaginate);
        $('#dateFilterGroup .btn').on('click', function() {
            $('#dateFilterGroup .btn').removeClass('active');
            $(this).addClass('active');
            filterAndPaginate();
        });
        $('#sourceFilterGroup .btn').on('click', function() {
            $('#sourceFilterGroup .btn').removeClass('active');
            $(this).addClass('active');
            filterAndPaginate();
        });
        $('#atsFilterGroup .btn').on('click', function() {
            $('#atsFilterGroup .btn').removeClass('active');
            $(this).addClass('active');
            filterAndPaginate();
        });
        
        // Initial display
        filterAndPaginate();
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHzI" crossorigin="anonymous"></script>
{% endblock %}