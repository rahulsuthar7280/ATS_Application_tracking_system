{% extends 'base.html' %}

{% block title %}Career Portal Dashboard{% endblock %}

{% block content %}
{% load static %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complex Career Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<style>
    :root {
    /* Updated Light Mode Palette */
    --background-color-light: #f0f4f8; /* A very light, soft gray */
    --surface-color-light: #ffffff;
    --primary-color: #4a90e2;    /* A softer, more inviting blue */
    --secondary-color: #1a4a75;   /* Darker blue for contrast */
    --accent-color: #ff7f50;     /* Vibrant coral for highlights */
    --text-color-light: #334e68; /* Dark, legible gray */
    --text-color-secondary-light: #829ab1; /* Lighter gray for secondary text */
    --border-color-light: #e3e8ee;
    --shadow-color-light: rgba(51, 78, 104, 0.1);

    /* Shared Styles - Keep as is, but these colors will pop more with the new palette */
    --success-color: #2ecc71;
    --info-color: #3498db;
    --error-color: #e74c3c;
    --warning-color: #f39c12;
    --font-primary: 'Poppins', sans-serif;
    --font-secondary: 'Montserrat', sans-serif;
    --transition-speed: 0.3s ease;
    --border-radius: 12px; /* Slightly smaller for a modern look */
}

/* Base Styles */
body.light-mode {
    background-color: var(--background-color-light);
    color: var(--text-color-light);
    transition: background-color var(--transition-speed), color var(--transition-speed);
}

body {
    font-family: var(--font-primary);
    display: flex;
    flex-direction: column;
}

.container {
    max-width: 1300px;
    margin: 0 auto;
    padding: 0 30px;
}

a {
    color: var(--primary-color);
    text-decoration: none;
    transition: color var(--transition-speed);
}

a:hover {
    color: var(--secondary-color);
}

/* Header */
header {
    background-color: var(--surface-color-light);
    border-bottom: 1px solid var(--border-color-light);
    position: sticky;
    top: 0;
    z-index: 100;
    transition: background-color var(--transition-speed), border-color var(--transition-speed);
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-title {
    font-family: var(--font-secondary);
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
    color: var(--primary-color);
}

.header-actions {
    display: flex;
    gap: 15px;
}

.create-job-btn {
    background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); /* Add a subtle gradient */
    color: #fff;
    border: none;
    padding: 12px 25px;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease; /* Transition all properties for a smoother effect */
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    background-size: 200% auto; /* For the animated gradient effect */
    margin-left: auto;
}

.create-job-btn:hover {
    background-position: right center; /* Animate the gradient on hover */
    transform: translateY(-3px) scale(1.02); /* Lift and slightly enlarge */
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
}

.create-job-btn i {
    margin-right: 8px;
}

/* Main Dashboard Layout */
main {
    flex: 1;
}

.main-dashboard-container {
    display: flex;
    flex-direction: column;
    gap: 30px;
}

.grid-item {
    background-color: var(--surface-color-light);
    padding: 30px;
    border-radius: var(--border-radius);
    box-shadow: 0 6px 16px var(--shadow-color-light);
    transition: background-color var(--transition-speed), box-shadow var(--transition-speed);
}

/* Hero Section */
.hero-section {
    position: relative;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color), var(--accent-color));
    background-size: 400% 400%;
    animation: gradient-animation 15s ease infinite;
    color: #fff;
    padding: 30px 40px;
    text-align: center;
    overflow: hidden;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
}

@keyframes gradient-animation {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

.hero-content {
    position: relative;
    z-index: 2;
}

.hero-title {
    font-family: var(--font-secondary);
    font-size: 2.8rem;
    font-weight: 700;
    margin-bottom: 15px;
}

.hero-subtitle {
    font-size: 1.2rem;
    margin: 0;
    font-weight: 300;
}

.highlight-text {
    font-weight: 700;
    color: #ffeb3b;
}

/* Filter Bar */
.filter-bar {
    background-color: var(--surface-color-light);
    border-radius: 0; /* Remove border radius */
    /* box-shadow: none; Remove shadow */
    box-shadow: 0 6px 6px rgba(0,0,0,.1);
    border-bottom: 1px solid var(--border-color-light); /* Add a subtle bottom border */
    padding: 25px 20px; /* Slightly more vertical padding */
    display: flex;
    flex-wrap: wrap;
    align-items: center; /* Center align all items */
    gap: 20px;
}

.filter-bar .filter-group {
    display: flex;
    flex-direction: column;
    flex: 1;
    min-width: 180px;
    gap: 8px;
}

.filter-bar label {
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 0;
}

.filter-bar input, .filter-bar select {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid var(--border-color-light);
    background-color: var(--background-color-light);
    transition: border-color var(--transition-speed), background-color var(--transition-speed), box-shadow 0.2s;
    font-size: 1rem;
    color: var(--text-color-light);
}

.filter-bar input:focus, .filter-bar select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(93, 93, 255, 0.1);
}

.reset-btn {
    background-color: var(--border-color-light);
    color: var(--text-color-secondary-light);
    border: none;
    padding: 12px 25px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    transition: background-color 0.2s, color 0.2s;
}

.reset-btn:hover {
    background-color: var(--text-color-secondary-light);
    color: #fff;
}

/* Main Content & Job Listings */
.job-listings-section {
    flex-direction: column;
    gap: 20px;
    border-bottom: 1px solid var(--border-color-light); /* Add a subtle bottom border */
    background-color: var(--surface-color-light);
    padding: 20px;
    box-shadow: 0 10px 12px var(--shadow-color-light);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 50px;
}

.section-title {
    font-family: var(--font-secondary);
    font-size: 1.8rem;
    margin: 0;
    color: var(--primary-color);
}

.job-listings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 25px;
}

.job-card {
    background-color: var(--background-color-light);
    border-radius: var(--border-radius);
    padding: 25px;
    box-shadow: 0 4px 6px rgba(0,0,0,.1);
    /* box-shadow: 5px 5px 5px 5px #aaaaaa; */
    /* max-width: 400px; */
    height: 350px;
    /* box-shadow: 0 4px 12px var(--shadow-color-light); */
    border: 1px solid var(--border-color-light);
    display: flex;
    flex-direction: column;
    transition: transform 0.2s, box-shadow 0.2s, background-color var(--transition-speed), border-color var(--transition-speed);
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.job-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 8px;
    height: 100%;
    background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
    transition: width 0.3s ease;
    opacity: 0.8;
}

.job-card:hover {
    transform: translateY(-8px); /* More pronounced lift */
    box-shadow: 0 10px 25px var(--shadow-color-light); /* Stronger, but still soft shadow */
}

.job-card:hover::before {
    width: 12px;
}

.job-card-header {
    display: flex;
    align-items: flex-start;
    gap: 15px;
    position: relative;
}

.company-logo {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    object-fit: cover;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.job-title-group {
    flex-grow: 1;
}

.job-title-group h3 {
    margin: 0;
    font-size: 1.2rem;
    font-weight: 600;
}

.job-title-group .company {
    font-size: 0.9rem;
    color: var(--text-color-secondary-light);
    margin: 5px 0 0;
}

.meta-info {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin: 15px 0;
    font-size: 0.9rem;
    color: var(--text-color-secondary-light);
}

.meta-info span {
    display: flex;
    align-items: center;
    gap: 5px;
}

.icon {
    font-size: 1rem;
    color: var(--primary-color);
}

.job-card-description {
    font-size: 0.95rem;
    line-height: 1.5;
    color: var(--text-color-secondary-light);
    margin-bottom: 15px;
}

.skills-list {
    list-style: none;
    padding: 0;
    margin: 0 0 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.skills-list li {
    background-color: var(--secondary-color);
    color: #fff;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 500;
    transition: background-color 0.2s;
}

.action-bar-bottom {
    display: flex;
    justify-content: flex-end;
    margin-top: auto;
}

#no-results-message {
    text-align: center;
    font-style: italic;
    color: var(--text-color-secondary-light);
    margin-top: 50px;
    display: none;
    font-size: 1.2rem;
}

/* Dropdown Menu */
.dropdown-menu-container {
    position: relative;
    margin-left: auto;
}

.dropdown-toggle {
    background: none;
    border: none;
    color: var(--text-color-secondary-light);
    font-size: 1.2rem;
    cursor: pointer;
    padding: 5px;
    border-radius: 50%;
    transition: background-color 0.2s, color 0.2s;
}

.dropdown-toggle:hover {
    background-color: var(--border-color-light);
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    right: 0;
    background-color: var(--surface-color-light);
    border: 1px solid var(--border-color-light);
    border-radius: 8px;
    box-shadow: 0 4px 12px var(--shadow-color-light);
    padding: 10px 0;
    min-width: 150px;
    z-index: 50;
    display: none;
    transform: translateY(10px);
    opacity: 0;
    transition: transform 0.2s, opacity 0.2s;
}

.dropdown-menu.show {
    display: block;
    transform: translateY(0);
    opacity: 1;
}

.menu-item {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
    background: none;
    border: none;
    text-align: left;
    padding: 10px 15px;
    font-size: 0.9rem;
    color: var(--text-color-light);
    cursor: pointer;
    transition: background-color 0.2s, color 0.2s;
}

.menu-item:hover {
    background-color: var(--background-color-light);
}

.view-details-btn {
    color: var(--info-color);
}

.edit-btn {
    color: var(--warning-color);
}

.delete-btn {
    color: var(--error-color);
}

/* Modals */
.modal {
    display: none;
    position: fixed;
    z-index: 200;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(5px);
    padding-top: 50px;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background-color: var(--surface-color-light);
    padding: 50px; /* More padding for a spacious feel */
    border-radius: var(--border-radius);
    box-shadow: 0 8px 25px var(--shadow-color-light);
    width: 100%;
    margin-left: 200px;
    max-width: 1100px; /* Make it a bit wider for larger screens */
    position: relative;
    display: flex;
    gap: 50px; /* Increase the gap between main content and sidebar */
    animation: fadeIn 0.3s;
    max-height: 85vh;
    overflow-y: auto;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.close-btn {
    position: absolute;
    top: 15px;
    right: 25px;
    color: var(--text-color-secondary-light);
    font-size: 30px;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.2s;
}

.close-btn:hover, .close-btn:focus {
    color: var(--primary-color);
}

.modal-form-header {
    margin-bottom: 25px;
    border-bottom: 1px solid var(--border-color-light);
    padding-bottom: 15px;
}

.modal-form-header h2 {
    font-size: 1.8rem;
    margin: 0;
    color: var(--primary-color);
}

/* Job Details Modal */
.details-main-content {
    flex: 2;
}

.details-sidebar {
    flex: 1;
    background-color: var(--background-color-light); /* Lighter background color */
    border-radius: 8px;
    padding: 30px;
    border-left: none; /* Remove the vertical border */
}

.job-header {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 20px;
}

.modal-company-logo {
    width: 80px;
    height: 80px;
    border-radius: var(--border-radius);
    object-fit: cover;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}

.details-title {
    font-family: var(--font-secondary);
    font-size: 2.2rem;
    margin: 0;
    color: var(--primary-color);
}

.details-company {
    font-size: 1.1rem;
    color: var(--text-color-secondary-light);
}

.details-section {
    margin-bottom: 25px;
}

.details-section h3 {
    font-size: 1.2rem;
    border-bottom: 2px solid var(--primary-color);
    display: inline-block;
    padding-bottom: 5px;
    margin-bottom: 15px;
    color: var(--primary-color);
}

.details-section h3 i {
    margin-right: 8px;
}

.details-pre-formatted {
    white-space: pre-wrap;
    font-family: var(--font-primary);
    font-size: 0.95rem;
    line-height: 1.6;
    color: var(--text-color-secondary-light);
    margin: 0;
    text-align: justify; /* Justified text for a cleaner look */
}

.details-bullet-list {
    list-style-type: '• ';
    padding-left: 20px;
    font-size: 0.95rem;
    line-height: 1.6;
}

.details-item {
    display: flex;
    align-items: flex-start;
    gap: 15px;
    margin-bottom: 15px;
}

.details-item span {
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
}

.details-item p {
    margin: 0;
    flex-grow: 1;
}

.details-apply-btn {
    display: block;
    width: 100%;
    text-align: center;
    background-color: var(--primary-color);
    color: #fff;
    padding: 15px 0;
    border-radius: 8px;
    font-weight: 600;
    font-size: 1.1rem;
    transition: background-color 0.2s, transform 0.2s;
    margin-top: 30px;
}

.details-apply-btn:hover {
    background-color: var(--secondary-color);
    transform: translateY(-2px);
}

/* Job Creation Modal */
.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group.span-full {
    grid-column: 1 / -1;
}

.form-group label {
    font-weight: 500;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.form-group input:not([type="checkbox"]), .form-group textarea, .form-group select {
    padding: 12px;
    border-radius: 8px;
    border: 1px solid var(--border-color-light);
    background-color: var(--background-color-light);
    transition: border-color 0.2s, box-shadow 0.2s;
    color: var(--text-color-light);
}

.form-group input:focus, .form-group textarea:focus, .form-group select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(93, 93, 255, 0.1);
}

.form-group textarea {
    min-height: 100px;
    resize: vertical;
}

.job-type-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.job-type-buttons input[type="radio"] {
    display: none;
}

.job-type-buttons label {
    padding: 10px 15px;
    border: 1px solid var(--border-color-light);
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s, color 0.2s;
    font-weight: normal;
}

.job-type-buttons input[type="radio"]:checked + label {
    background-color: var(--primary-color);
    color: #fff;
    border-color: var(--primary-color);
}

#skills-input-container {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 8px;
    border: 1px solid var(--border-color-light);
    border-radius: 8px;
    padding: 8px;
    background-color: var(--background-color-light);
}

#skills-input {
    flex-grow: 1;
    border: none;
    padding: 5px;
    background-color: transparent;
    font-size: 1rem;
    outline: none;
    width: auto;
    color: var(--text-color-light);
}

.skill-tag {
    background-color: var(--primary-color);
    color: #fff;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 5px;
}

.remove-skill-btn {
    background: none;
    border: none;
    color: #fff;
    font-weight: bold;
    font-size: 1rem;
    cursor: pointer;
}

/* New Skill Tag Style for Modal */
.colorful-skill-tag {
    background-color: var(--secondary-color);
    color: #fff;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 500;
    transition: background-color 0.2s, transform 0.2s; /* Add a transition */
}

.colorful-skill-tag:hover {
    transform: scale(1.05); /* Slight scale on hover */
    background-color: var(--secondary-color);
}

.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 15px;
    margin-top: 30px;
}

.submit-btn, .cancel-btn, .edit-submit-btn {
    padding: 12px 25px;
    border-radius: 8px;
    border: none;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s, transform 0.2s;
}

.submit-btn, .edit-submit-btn {
    background-color: var(--primary-color);
    color: #fff;
}

.submit-btn:hover, .edit-submit-btn:hover {
    background-color: var(--secondary-color);
    transform: translateY(-2px);
}

.cancel-btn {
    background-color: var(--border-color-light);
    color: var(--text-color-secondary-light);
}

.cancel-btn:hover {
    background-color: #c0c0c0;
}

/* Toggle Switch */
.switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 28px;
    flex-shrink: 0;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--error-color);
    transition: .4s;
    border-radius: 34px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: var(--success-color);
}

input:checked + .slider:before {
    transform: translateX(22px);
}

.toggle-label {
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-color-secondary-light);
}

/* Footer */
footer {
    background-color: var(--surface-color-light);
    color: var(--text-color-secondary-light);
    text-align: center;
    padding: 20px;
    margin-top: 30px;
    border-top: 1px solid var(--border-color-light);
    transition: background-color var(--transition-speed), color var(--transition-speed), border-color var(--transition-speed);
}

/* Toast Notification */
#toast-notification {
    visibility: hidden;
    min-width: 250px;
    margin-left: -125px;
    background-color: var(--success-color);
    color: #fff;
    text-align: center;
    border-radius: 8px;
    padding: 16px;
    position: fixed;
    z-index: 999;
    left: 50%;
    bottom: 30px;
    font-size: 1rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    transition: visibility 0s, opacity 0.5s linear;
}

#toast-notification.show {
    visibility: visible;
    -webkit-animation: fadeInToast 0.5s, fadeOutToast 0.5s 2.5s;
    animation: fadeInToast 0.5s, fadeOutToast 0.5s 2.5s;
}

@-webkit-keyframes fadeInToast {
    from {
        bottom: 0;
        opacity: 0;
    }
    to {
        bottom: 30px;
        opacity: 1;
    }
}

@keyframes fadeInToast {
    from {
        bottom: 0;
        opacity: 0;
    }
    to {
        bottom: 30px;
        opacity: 1;
    }
}

@-webkit-keyframes fadeOutToast {
    from {
        bottom: 30px;
        opacity: 1;
    }
    to {
        bottom: 0;
        opacity: 0;
    }
}

@keyframes fadeOutToast {
    from {
        bottom: 30px;
        opacity: 1;
    }
    to {
        bottom: 0;
        opacity: 0;
    }
}

/* Responsive Styles */
@media (max-width: 1024px) {
    #job-details-modal .modal-content {
        flex-direction: column;
    }

    .details-sidebar {
        width: 100%;
        border-left: none;
        border-top: 1px solid var(--border-color-light);
        padding-top: 30px;
        margin-top: 30px;
        padding-left: 0;
    }

    .job-header {
        flex-direction: column;
        text-align: center;
        margin-bottom: 30px;
    }
}

@media (max-width: 768px) {
    .container {
        padding: 0 15px;
    }

    .header-title {
        font-size: 1.5rem;
    }

    .create-job-btn {
        padding: 10px 20px;
        font-size: 0.9rem;
    }

    .hero-title {
        font-size: 2rem;
    }
}
</style>
<body class="light-mode">
    <main>
        <div class="main-dashboard-container">
            <section class="hero-section">
                <div class="hero-content">
                    <h2 class="hero-title">Find Your Next Great Opportunity</h2>
                    <p class="hero-subtitle">Explore <span class="highlight-text" id="hero-total-jobs">0</span> available jobs from leading companies.</p>
                </div>
            </section>

            <section class="filter-bar">
                <div class="filter-group">
                    <label for="keyword-search"><i class="fas fa-search"></i> Keyword Search</label>
                    <input type="text" id="keyword-search" placeholder="Title, company, or skills...">
                </div>
                <div class="filter-group">
                    <label for="location-filter"><i class="fas fa-map-marker-alt"></i> Location</label>
                    <select id="location-filter">
                        <option value="">All Locations</option>
                        {% for location in locations %}
                            <option value="{{ location }}">{{ location }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label for="job-type-filter"><i class="fas fa-briefcase"></i> Job Type</label>
                    <select id="job-type-filter">
                        <option value="">All Types</option>
                        {% for job_type in job_types %}
                            <option value="{{ job_type }}">{{ job_type }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label for="experience-filter"><i class="fas fa-medal"></i> Experience</label>
                    <select id="experience-filter">
                        <option value="">All Levels</option>
                        <option value="Entry-Level">Entry-Level</option>
                        <option value="Mid-Level">Mid-Level</option>
                        <option value="Senior-Level">Senior-Level</option>
                        <option value="Director-Level">Director-Level</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="status-filter"><i class="fas fa-toggle-on"></i> Status</label>
                    <select id="status-filter">
                        <option value="">All</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="sort-by"><i class="fas fa-sort"></i> Sort By</label>
                    <select id="sort-by">
                        <option value="newest" selected>Newest First</option>
                        <option value="salary-desc">Salary (High to Low)</option>
                        <option value="salary-asc">Salary (Low to High)</option>
                    </select>
                </div>
                <button id="reset-filters-btn" class="reset-btn">Reset Filters</button>
                <button id="create-job-btn" class="create-job-btn" aria-label="Create a new job posting">
                    <i class="fas fa-plus"></i> Create Posting
                </button>
            </section>

            <section class="job-listings-section">
                <div class="section-header">
                    <h2 class="section-title">Current Opportunities</h2>
                </div>
                <div class="job-listings-grid" id="job-listings" role="region" aria-live="polite">
                    <div class="loading-spinner"></div>
                </div>
                <p id="no-results-message">No jobs found matching your criteria. Try a different search!</p>
            </section>
        </div>
    </main>

    <div id="job-details-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-job-title">
        <div class="modal-content">
            <span class="close-btn details-close-btn" role="button" aria-label="Close modal">&times;</span>
            <div class="details-main-content">
                <div class="job-header">
                    <img id="modal-company-logo" src="" alt="Company Logo" class="modal-company-logo">
                    <h2 id="modal-job-title" class="details-title"></h2>
                    <p id="modal-company-name" class="details-company"></p>
                </div>
                <div class="details-section" id="details-description">
                    <h3><i class="fas fa-book-open"></i> Job Description</h3>
                    <pre id="modal-job-description" class="details-pre-formatted"></pre>
                </div>
                <div class="details-section" id="details-responsibilities">
                    <h3><i class="fas fa-tasks"></i> Key Responsibilities</h3>
                    <ul id="modal-responsibilities-list" class="details-bullet-list"></ul>
                </div>
                <div class="details-section" id="details-qualifications">
                    <h3><i class="fas fa-user-tie"></i> Qualifications</h3>
                    <ul id="modal-qualifications-list" class="details-bullet-list"></ul>
                </div>
                <div class="details-section" id="details-company-info">
                    <h3><i class="fas fa-building"></i> About the Company</h3>
                    <pre id="modal-about-company" class="details-pre-formatted"></pre>
                </div>
            </div>
            <div class="details-sidebar">
                <div class="details-section" id="details-overview">
                    <h3><i class="fas fa-info-circle"></i> Key Details</h3>
                    <div class="details-section-content">
                        <div class="details-item" data-field="location">
                            <span><i class="fas fa-map-marker-alt icon"></i> Location:</span>
                            <p id="modal-location"></p>
                        </div>
                        <div class="details-item" data-field="job-type">
                            <span><i class="fas fa-briefcase icon"></i> Job Type:</span>
                            <p id="modal-job-type"></p>
                        </div>
                        <div class="details-item" data-field="experience">
                            <span><i class="fas fa-medal icon"></i> Experience Level:</span>
                            <p id="modal-experience"></p>
                        </div>
                        <div class="details-item" data-field="salary">
                            <span><i class="fas fa-dollar-sign icon"></i> Salary/Compensation:</span>
                            <p id="modal-salary"></p>
                        </div>
                        <div class="details-item" data-field="benefits">
                            <span><i class="fas fa-heartbeat icon"></i> Benefits:</span>
                            <ul id="modal-benefits-list" class="details-bullet-list"></ul>
                        </div>
                        <div class="details-item" data-field="posted-date">
                            <span><i class="fas fa-calendar-alt icon"></i> Posted On:</span>
                            <p id="modal-posted-date"></p>
                        </div>
                    </div>
                </div>
                <div class="details-section" id="details-skills">
                    <h3><i class="fas fa-tools"></i> Skills Required</h3>
                    <ul id="modal-skills-list" class="skills-list"></ul>
                </div>
                <button class="details-apply-btn" id="open-application-modal-btn">Apply Now</button>
            </div>
        </div>
    </div>

    <div id="job-creation-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="creation-form-title">
        <div class="modal-content">
            <span class="close-btn creation-close-btn" role="button" aria-label="Close modal">&times;</span>
            <div class="modal-form-header">
                <h2 id="creation-form-title">Create a New Job Posting</h2>
                <h2 id="edit-form-title">Edit Job Posting</h2>
            </div>
            <form id="job-creation-form" novalidate>
                <input type="hidden" id="job-id-input" name="job-id">
                <div class="form-grid">
                    <div class="form-group span-full">
                        <label for="job-title"><i class="fas fa-briefcase"></i> Job Title</label>
                        <input type="text" id="job-title" name="job-title" placeholder="e.g., Senior Software Engineer" required>
                    </div>
                    <div class="form-group span-full">
                        <label for="company-name"><i class="fas fa-building"></i> Company Name</label>
                        <input type="text" id="company-name" name="company-name" placeholder="e.g., Tech Solutions Inc." required>
                    </div>
                    <div class="form-group span-full">
                        <label for="company-logo"><i class="fas fa-image"></i> Company Logo (Upload)</label>
                        <input type="file" id="company-logo" name="company-logo" accept="image/*">
                    </div>
                    <div class="form-group">
                        <label for="location-type"><i class="fas fa-map-marker-alt"></i> Location Type</label>
                        <select id="location-type" name="location-type" required>
                            <option value="">Select Type...</option>
                            <option value="Remote">Remote</option>
                            <option value="On-site">On-site</option>
                            <option value="Hybrid">Hybrid</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="specific-location"><i class="fas fa-map-pin"></i> Specific Location</label>
                        <input type="text" id="specific-location" name="specific-location" placeholder="e.g., San Francisco, CA" required>
                    </div>
                    <div class="form-group">
                        <label for="job-id"><i class="fas fa-hashtag"></i> Job ID (Optional)</label>
                        <input type="text" id="job-id" name="job-id" placeholder="e.g., TS-SWE-001">
                    </div>
                    <div class="form-group">
                        <label for="application-link"><i class="fas fa-link"></i> Application Link/Email</label>
                        <input type="url" id="application-link" name="application-link" placeholder="URL or Email Address" required>
                    </div>
                    <div class="form-group span-full" id="job-description-group">
                        <label for="job-description"><i class="fas fa-file-alt"></i> Job Description</label>
                        <textarea id="job-description" name="job-description" placeholder="Provide a detailed description of the role. Use line breaks for bullet points."></textarea>
                    </div>
                    <div class="form-group span-full" id="responsibilities-group">
                        <label for="responsibilities"><i class="fas fa-tasks"></i> Key Responsibilities</label>
                        <textarea id="responsibilities" name="responsibilities" placeholder="List key responsibilities using line breaks or bullet points."></textarea>
                    </div>
                    <div class="form-group span-full" id="qualifications-group">
                        <label for="qualifications"><i class="fas fa-user-tie"></i> Qualifications</label>
                        <textarea id="qualifications" name="qualifications" placeholder="List required qualifications and skills."></textarea>
                    </div>
                    <div class="form-group span-full">
                        <label><i class="fas fa-briefcase"></i> Job Type</label>
                        <div class="job-type-buttons" id="job-type-buttons">
                            <input type="radio" id="type-full-time" name="job-type" value="Full-Time" checked required>
                            <label for="type-full-time">Full-Time</label>
                            <input type="radio" id="type-part-time" name="job-type" value="Part-Time">
                            <label for="type-part-time">Part-Time</label>
                            <input type="radio" id="type-contract" name="job-type" value="Contract">
                            <label for="type-contract">Contract</label>
                            <input type="radio" id="type-internship" name="job-type" value="Internship">
                            <label for="type-internship">Internship</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="experience-level"><i class="fas fa-medal"></i> Experience Level</label>
                        <select id="experience-level" name="experience-level" required>
                            <option value="">Select Level...</option>
                            <option value="Entry-Level">Entry-Level</option>
                            <option value="Mid-Level">Mid-Level</option>
                            <option value="Senior-Level">Senior-Level</option>
                            <option value="Director-Level">Director-Level</option>
                        </select>
                    </div>
                    <div class="form-group" id="salary-fields">
                        <label for="min-salary"><i class="fas fa-money-bill-wave"></i> Min. Salary (Annual)</label>
                        <input type="number" id="min-salary" name="min-salary" placeholder="e.g., 90000">
                        <label for="max-salary" style="margin-top: 10px;"><i class="fas fa-chart-line"></i> Max. Salary (Annual)</label>
                        <input type="number" id="max-salary" name="max-salary" placeholder="e.g., 120000">
                    </div>
                    <div class="form-group" id="stipend-fields" style="display: none;">
                        <label for="stipend-amount"><i class="fas fa-money-bill-wave"></i> Stipend Amount</label>
                        <input type="text" id="stipend-amount" name="stipend-amount" placeholder="e.g., $1500/month">
                    </div>
                    <div class="form-group span-full" id="skills-group">
                        <label for="skills-input"><i class="fas fa-tools"></i> Skills (Press Enter to add)</label>
                        <div id="skills-input-container">
                            <input type="text" id="skills-input" placeholder="e.g., JavaScript">
                        </div>
                        <input type="hidden" id="skills-final-input" name="skills">
                    </div>
                    <div class="form-group span-full" id="about-company-group">
                        <label for="about-company"><i class="fas fa-building"></i> About the Company (Optional)</label>
                        <textarea id="about-company" name="about-company" placeholder="Tell candidates about your company culture, mission, and benefits."></textarea>
                    </div>
                    <div class="form-group span-full" id="benefits-group">
                        <label for="benefits"><i class="fas fa-heartbeat"></i> Benefits (Optional)</label>
                        <textarea id="benefits" name="benefits" placeholder="e.g., Medical, Dental, 401(k), Paid Time Off"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="is-new"><i class="fas fa-star"></i> Mark as New?</label>
                        <input type="checkbox" id="is-new" name="is-new">
                    </div>
                    <div class="form-group">
                        <label for="is-enabled"><i class="fas fa-toggle-on"></i> Enable Job Posting?</label>
                        <label class="switch">
                            <input type="checkbox" id="is-enabled" name="is-enabled" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="cancel-btn creation-close-btn">Cancel</button>
                    <button type="submit" class="submit-btn" id="create-submit-btn">Post Job</button>
                    <button type="submit" class="edit-submit-btn" id="edit-submit-btn" style="display: none;">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="application-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="application-form-title">
        <div class="modal-content">
            <span class="close-btn application-close-btn" role="button" aria-label="Close modal">&times;</span>
            <div class="modal-form-header">
                <h2 id="application-form-title">Apply for Job</h2>
            </div>
            <form id="application-form" action="" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" id="career-id" name="career_id">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="first-name"><i class="fas fa-user"></i> First Name</label>
                        <input type="text" id="first-name" name="first_name" placeholder="Enter your first name" required>
                    </div>
                    <div class="form-group">
                        <label for="last-name"><i class="fas fa-user"></i> Last Name</label>
                        <input type="text" id="last-name" name="last_name" placeholder="Enter your last name" required>
                    </div>
                    <div class="form-group">
                        <label for="email"><i class="fas fa-envelope"></i> Email</label>
                        <input type="email" id="email" name="email" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="phone"><i class="fas fa-phone"></i> Phone</label>
                        <input type="tel" id="phone" name="phone" placeholder="Enter your phone number">
                    </div>

                    <div class="form-group">
                        <label for="experience"><i class="fas fa-chart-line"></i> Total Experience (Years)</label>
                        <input type="number" id="experience" name="experience" placeholder="e.g., 5" min="0">
                    </div>
                    <div class="form-group">
                        <label for="current-ctc"><i class="fas fa-dollar-sign"></i> Current CTC</label>
                        <input type="text" id="current-ctc" name="current_ctc" placeholder="e.g., 10 LPA">
                    </div>
                    <div class="form-group">
                        <label for="expected-ctc"><i class="fas fa-dollar-sign"></i> Expected CTC</label>
                        <input type="text" id="expected-ctc" name="expected_ctc" placeholder="e.g., 12 LPA">
                    </div>
                    <div class="form-group">
                        <label for="qualification"><i class="fas fa-graduation-cap"></i> Highest Qualification</label>
                        <input type="text" id="qualification" name="qualification" placeholder="e.g., B.Tech in CSE">
                    </div>
                    <div class="form-group">
                        <label for="notice-period"><i class="fas fa-clock"></i> Notice Period</label>
                        <input type="text" id="notice-period" name="notice_period" placeholder="e.g., 30 days or Immediately">
                    </div>
                    <div class="form-group">
                        <label for="resume"><i class="fas fa-file-pdf"></i> Resume (PDF, DOC)</label>
                        <input type="file" id="resume" name="resume" accept=".pdf,.doc,.docx" required>
                    </div>
                    <div class="form-group">
                        <label for="cover-letter"><i class="fas fa-file-alt"></i> Cover Letter (Optional)</label>
                        <input type="file" id="cover-letter" name="cover_letter" accept=".pdf,.doc,.docx">
                    </div>
                    <div class="form-group span-full">
                        <label for="linkedin-url"><i class="fab fa-linkedin"></i> LinkedIn Profile URL (Optional)</label>
                        <input type="url" id="linkedin-url" name="linkedin_url" placeholder="https://www.linkedin.com/in/yourprofile">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="cancel-btn application-close-btn">Cancel</button>
                    <button type="submit" class="submit-btn">Submit Application</button>
                </div>
            </form>
        </div>
    </div>
    <div id="toast-notification"></div>

    <script>
        // Use the dynamic jobs data from the Django context
        let jobsData = JSON.parse('{{ jobs_data_json|escapejs }}');

        // Adjust data structure to match what the JavaScript expects
        jobsData = jobsData.map(job => {
            const newJob = {
                ...job,
                id: job.id,
                job_title: job.title,
                company_name: job.company,
                company_logo: job.company_logo ? `/media/${job.company_logo}` : 'https://via.placeholder.com/50',
                location_type: '', // This field is not in the model, so we can leave it empty or map from somewhere else
                specific_location: job.location,
                job_type: job.job_type,
                experience_level: job.experience,
                salary: job.salary,
                min_salary: null,
                max_salary: null,
                stipend: job.job_type === 'Internship' ? job.salary : null,
                job_description: job.description,
                responsibilities: job.responsibilities ? job.responsibilities.split('\\n').map(item => item.trim()).filter(item => item) : [],
                qualifications: job.qualifications ? job.qualifications.split('\\n').map(item => item.trim()).filter(item => item) : [],
                skills: JSON.parse(job.skills || '[]'),
                about_company: job.about_company,
                benefits: job.benefits ? job.benefits.split('\\n').map(item => item.trim()).filter(item => item) : [],
                application_link: job.application_link,
                is_new: false, // The model doesn't have an is_new field
                is_enabled: job.is_active,
                is_saved: false, // This is a front-end state, not in the model
                posted_date: job.date_posted,
            };

            const salaryRegex = /^\$(\d+)(?: - \$(\d+))?/;
            const match = newJob.salary.match(salaryRegex);
            if (match) {
                newJob.min_salary = parseInt(match[1]);
                if (match[2]) {
                    newJob.max_salary = parseInt(match[2]);
                }
            }

            return newJob;
        });

        const jobListingsContainer = document.getElementById('job-listings');
        const jobDetailsModal = document.getElementById('job-details-modal');
        const jobCreationModal = document.getElementById('job-creation-modal');
        const applicationModal = document.getElementById('application-modal'); // New modal
        const detailsCloseBtn = document.querySelector('.details-close-btn');
        const creationCloseBtns = document.querySelectorAll('.creation-close-btn');
        const applicationCloseBtns = document.querySelectorAll('.application-close-btn'); // New close button
        const createJobBtn = document.getElementById('create-job-btn');
        const jobCreationForm = document.getElementById('job-creation-form');
        const applicationForm = document.getElementById('application-form'); // New form
        const createSubmitBtn = document.getElementById('create-submit-btn');
        const editSubmitBtn = document.getElementById('edit-submit-btn');
        const creationFormTitle = document.getElementById('creation-form-title');
        const editFormTitle = document.getElementById('edit-form-title');
        const jobIdInput = document.getElementById('job-id-input');
        const noResultsMessage = document.getElementById('no-results-message');
        const heroTotalJobs = document.getElementById('hero-total-jobs');
        const keywordSearch = document.getElementById('keyword-search');
        const locationFilter = document.getElementById('location-filter');
        const jobTypeFilter = document.getElementById('job-type-filter');
        const experienceFilter = document.getElementById('experience-filter');
        const statusFilter = document.getElementById('status-filter');
        const sortBy = document.getElementById('sort-by');
        const resetFiltersBtn = document.getElementById('reset-filters-btn');
        const toastNotification = document.getElementById('toast-notification');
        const openApplicationModalBtn = document.getElementById('open-application-modal-btn'); // New button

        let currentJobId = null; // Store the ID of the job being applied for

        const getCsrfToken = () => {
            const token = document.querySelector('[name=csrfmiddlewaretoken]');
            return token ? token.value : '';
        };

        const displayToast = (message, type) => {
            if (toastNotification) {
                toastNotification.textContent = message;
                toastNotification.className = 'show';
                toastNotification.style.backgroundColor = type === 'success' ? 'var(--success-color)' : 'var(--error-color)';
                setTimeout(() => {
                    toastNotification.className = '';
                }, 3000);
            }
        };

        const updateMetrics = (jobs) => {
            if (heroTotalJobs) {
                heroTotalJobs.textContent = jobs.length;
            }
        };

        const populateFilters = () => {
            // Filters are now populated by Django template tags
        };

        const renderJobListings = (jobs) => {
            if (!jobListingsContainer) return;

            jobListingsContainer.innerHTML = '';

            if (jobs.length === 0) {
                noResultsMessage.style.display = 'block';
                return;
            }
            noResultsMessage.style.display = 'none';

            jobs.forEach(job => {
                const jobCard = document.createElement('div');
                jobCard.className = 'job-card';
                jobCard.dataset.id = job.id;

                const skillsHtml = job.skills.map(skill => `<li class="colorful-skill-tag">${skill}</li>`).join('');

                jobCard.innerHTML = `
                    <div class="job-card-header">
                        <img src="${job.company_logo}" alt="${job.company_name} logo" class="company-logo">
                        <div class="job-title-group">
                            <h3>${job.job_title}</h3>
                            <p class="company">${job.company_name}</p>
                        </div>
                        <div class="header-right-actions">
                            <label class="switch">
                                <input type="checkbox" class="enable-toggle" data-id="${job.id}" ${job.is_enabled ? 'checked' : ''}>
                                <span class="slider"></span>
                            </label>
                            <div class="dropdown-menu-container">
                                <button class="dropdown-toggle" aria-label="Job actions menu" aria-haspopup="true" aria-expanded="false">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <div class="dropdown-menu">
                                    <button class="menu-item view-details-btn" data-id="${job.id}">
                                        <i class="fas fa-eye"></i> View Details
                                    </button>
                                    <button class="menu-item edit-btn" data-id="${job.id}">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="menu-item delete-btn" data-id="${job.id}">
                                        <i class="fas fa-trash-alt"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="meta-info">
                        <span class="location"><i class="fas fa-map-marker-alt icon"></i> ${job.specific_location}</span>
                        <span class="type"><i class="fas fa-briefcase icon"></i> ${job.job_type}</span>
                        <span class="experience"><i class="fas fa-medal icon"></i> ${job.experience_level}</span>
                    </div>
                    <p class="job-card-description">${job.job_description.substring(0, 100)}...</p>
                    <ul class="skills-list">
                        ${skillsHtml}
                    </ul>
                    <div class="action-bar-bottom">
                        <p class="posted-date">Posted: ${new Date(job.posted_date).toLocaleDateString()}</p>
                    </div>
                `;
                jobListingsContainer.appendChild(jobCard);
            });
        };

        const filterAndSortJobs = () => {
            const keyword = keywordSearch.value.toLowerCase();
            const location = locationFilter.value;
            const jobType = jobTypeFilter.value;
            const experience = experienceFilter.value;
            const status = statusFilter.value;
            const sortValue = sortBy.value;

            let filteredJobs = jobsData.filter(job => {
                const matchesKeyword = keyword === '' ||
                                       job.job_title.toLowerCase().includes(keyword) ||
                                       job.company_name.toLowerCase().includes(keyword) ||
                                       job.skills.some(skill => skill.toLowerCase().includes(keyword));
                const matchesLocation = location === '' || job.specific_location === location;
                const matchesJobType = jobType === '' || job.job_type === jobType;
                const matchesExperience = experience === '' || job.experience_level === experience;
                const matchesStatus = status === '' || (status === 'active' && job.is_enabled) || (status === 'inactive' && !job.is_enabled);

                return matchesKeyword && matchesLocation && matchesJobType && matchesExperience && matchesStatus;
            });

            if (sortValue === 'salary-desc') {
                filteredJobs.sort((a, b) => (b.min_salary || 0) - (a.min_salary || 0));
            } else if (sortValue === 'salary-asc') {
                filteredJobs.sort((a, b) => (a.min_salary || 0) - (b.min_salary || 0));
            } else {
                filteredJobs.sort((a, b) => new Date(b.posted_date) - new Date(a.posted_date));
            }
            updateMetrics(filteredJobs);
            renderJobListings(filteredJobs);
        };

        const openDetailsModal = (job) => {
            if (!jobDetailsModal) return;

            document.getElementById('modal-company-logo').src = job.company_logo;
            document.getElementById('modal-job-title').textContent = job.job_title;
            document.getElementById('modal-company-name').textContent = job.company_name;
            document.getElementById('modal-location').textContent = job.specific_location;
            document.getElementById('modal-job-type').textContent = job.job_type;
            document.getElementById('modal-experience').textContent = job.experience_level;
            document.getElementById('modal-salary').textContent = job.salary || 'Not Specified';
            document.getElementById('modal-posted-date').textContent = new Date(job.posted_date).toLocaleDateString();
            
            // Set the career_id for the application form
            currentJobId = job.id;

            document.getElementById('modal-job-description').textContent = job.job_description;
            document.getElementById('modal-about-company').textContent = job.about_company;

            const renderList = (id, items) => {
                const list = document.getElementById(id);
                if (list) {
                    list.innerHTML = items ? items.map(item => `<li>${item}</li>`).join('') : '';
                }
            };

            renderList('modal-responsibilities-list', job.responsibilities);
            renderList('modal-qualifications-list', job.qualifications);
            renderList('modal-benefits-list', job.benefits);

            const modalSkillsList = document.getElementById('modal-skills-list');
            modalSkillsList.innerHTML = job.skills.map(skill => `<li class="colorful-skill-tag">${skill}</li>`).join('');

            jobDetailsModal.style.display = 'flex';
        };

        const openCreationModal = (job = null) => {
            if (!jobCreationModal || !jobCreationForm) return;

            jobCreationForm.reset();
            // Clear existing skill tags
            const skillsInputContainer = document.getElementById('skills-input-container');
            skillsInputContainer.querySelectorAll('.skill-tag').forEach(tag => tag.remove());
            document.getElementById('job-id-input').value = '';

            if (job) {
                creationFormTitle.style.display = 'none';
                editFormTitle.style.display = 'block';
                createSubmitBtn.style.display = 'none';
                editSubmitBtn.style.display = 'block';
                jobIdInput.value = job.id;

                document.getElementById('job-title').value = job.job_title;
                document.getElementById('company-name').value = job.company_name;
                document.getElementById('location-type').value = job.location_type;
                document.getElementById('specific-location').value = job.specific_location;
                document.getElementById('application-link').value = job.application_link;
                document.getElementById('job-description').value = job.job_description;
                document.getElementById('responsibilities').value = (job.responsibilities || []).join('\n');
                document.getElementById('qualifications').value = (job.qualifications || []).join('\n');
                document.getElementById('about-company').value = job.about_company;
                document.getElementById('benefits').value = (job.benefits || []).join('\n');
                // The model doesn't have an is_new field, so we'll just set it to false
                document.getElementById('is-new').checked = false;
                document.getElementById('is-enabled').checked = job.is_enabled;

                document.querySelector(`input[name="job-type"][value="${job.job_type}"]`).checked = true;
                document.getElementById('experience-level').value = job.experience_level;

                const salaryFields = document.getElementById('salary-fields');
                const stipendFields = document.getElementById('stipend-fields');

                if (job.job_type === 'Internship') {
                    stipendFields.style.display = 'flex';
                    salaryFields.style.display = 'none';
                    document.getElementById('stipend-amount').value = job.salary;
                } else {
                    salaryFields.style.display = 'flex';
                    stipendFields.style.display = 'none';

                    const salaryRegex = /^\$(\d+)(?: - \$(\d+))?/;
                    const match = job.salary.match(salaryRegex);
                    if (match) {
                        document.getElementById('min-salary').value = match[1] || '';
                        document.getElementById('max-salary').value = match[2] || '';
                    } else {
                        document.getElementById('min-salary').value = '';
                        document.getElementById('max-salary').value = '';
                    }
                }

                job.skills.forEach(skill => createSkillTag(skill));

            } else {
                creationFormTitle.style.display = 'block';
                editFormTitle.style.display = 'none';
                createSubmitBtn.style.display = 'block';
                editSubmitBtn.style.display = 'none';
                document.getElementById('is-enabled').checked = true;
            }

            jobCreationModal.style.display = 'flex';
        };

        const openApplicationModal = () => {
            if (!applicationModal) return;
            // Hide the details modal and show the application modal
            jobDetailsModal.style.display = 'none';
            applicationModal.style.display = 'flex';
            // Set the career_id in the form
            document.getElementById('career-id').value = currentJobId;
            // Set the form action URL
            applicationForm.action = `/apply_for_job/${currentJobId}/`;
        };

        const createSkillTag = (text) => {
            const skillsInputContainer = document.getElementById('skills-input-container');
            if (!skillsInputContainer) return;

            const skillTag = document.createElement('span');
            skillTag.className = 'skill-tag';
            skillTag.textContent = text;
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-skill-btn';
            removeBtn.innerHTML = '&times;';
            removeBtn.addEventListener('click', () => {
                skillTag.remove();
                updateSkillsInput();
            });
            skillTag.appendChild(removeBtn);
            skillsInputContainer.appendChild(skillTag);
            updateSkillsInput();
        };

        const updateSkillsInput = () => {
            const skills = Array.from(document.querySelectorAll('.skill-tag')).map(tag => tag.textContent.replace('×', '').trim());
            const skillsFinalInput = document.getElementById('skills-final-input');
            if (skillsFinalInput) {
                skillsFinalInput.value = JSON.stringify(skills);
            }
        };

        const setupBulletPointFunctionality = (textareaId) => {
            const textarea = document.getElementById(textareaId);
            if (textarea) {
                textarea.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        const start = textarea.selectionStart;
                        const end = textarea.selectionEnd;
                        const currentText = textarea.value;
                        const newText = currentText.substring(0, start) + '\n• ' + currentText.substring(end);
                        textarea.value = newText;
                        textarea.selectionStart = textarea.selectionEnd = start + 3;
                    }
                });
            }
        };

        // Event Listeners
        window.addEventListener('click', (e) => {
            if (e.target === jobDetailsModal) {
                jobDetailsModal.style.display = 'none';
            }
            if (e.target === jobCreationModal) {
                jobCreationModal.style.display = 'none';
            }
            if (e.target === applicationModal) {
                applicationModal.style.display = 'none';
            }

            const isDropdownToggle = e.target.closest('.dropdown-toggle');
            if (isDropdownToggle) {
                const dropdownMenu = isDropdownToggle.nextElementSibling;
                dropdownMenu.classList.toggle('show');
            } else {
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    if (menu.classList.contains('show')) {
                        menu.classList.remove('show');
                    }
                });
            }
        });

        if (jobListingsContainer) {
            jobListingsContainer.addEventListener('click', (e) => {
                const viewBtn = e.target.closest('.view-details-btn');
                const editBtn = e.target.closest('.edit-btn');
                const deleteBtn = e.target.closest('.delete-btn');
                const enableToggle = e.target.closest('.enable-toggle');

                if (viewBtn) {
                    const jobId = parseInt(viewBtn.dataset.id);
                    const job = jobsData.find(j => j.id === jobId);
                    if (job) openDetailsModal(job);
                }
                if (editBtn) {
                    const jobId = parseInt(editBtn.dataset.id);
                    const job = jobsData.find(j => j.id === jobId);
                    if (job) openCreationModal(job);
                }
                if (deleteBtn) {
                    const jobId = parseInt(deleteBtn.dataset.id);
                    const job = jobsData.find(j => j.id === jobId);
                    if (confirm(`Are you sure you want to delete the job posting for "${job.job_title}"?`)) {
                        fetch(`/delete_job/${jobId}/`, {
                            method: 'DELETE',
                            headers: {
                                'X-CSRFToken': getCsrfToken(),
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                jobsData = jobsData.filter(j => j.id !== jobId);
                                filterAndSortJobs();
                                updateMetrics(jobsData);
                                displayToast('Job posting deleted successfully!', 'success');
                            } else {
                                displayToast(data.message || 'Failed to delete job posting.', 'error');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            displayToast('An error occurred while deleting the job.', 'error');
                        });
                    }
                }
                if (enableToggle) {
                    const jobId = parseInt(enableToggle.dataset.id);
                    const is_active = enableToggle.checked;

                    fetch(`/toggle_job_status/${jobId}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        body: JSON.stringify({ is_active: is_active })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const job = jobsData.find(j => j.id === jobId);
                            if (job) {
                                job.is_enabled = data.is_active;
                                const message = data.is_active ? 'Job posting enabled!' : 'Job posting disabled!';
                                displayToast(message, 'success');
                                filterAndSortJobs();
                            }
                        } else {
                            displayToast('Failed to change job status.', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        displayToast('An error occurred.', 'error');
                    });
                }
            });
        }

        if (detailsCloseBtn) detailsCloseBtn.addEventListener('click', () => jobDetailsModal.style.display = 'none');
        creationCloseBtns.forEach(btn => btn.addEventListener('click', () => jobCreationModal.style.display = 'none'));
        applicationCloseBtns.forEach(btn => btn.addEventListener('click', () => applicationModal.style.display = 'none'));
        if (createJobBtn) createJobBtn.addEventListener('click', () => openCreationModal());
        if (openApplicationModalBtn) openApplicationModalBtn.addEventListener('click', () => openApplicationModal());

        if (jobCreationForm) {
            jobCreationForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);
                const jobId = document.getElementById('job-id-input').value;

                let payload = {
                    title: formData.get('job-title'),
                    company: formData.get('company-name'),
                    location: formData.get('specific-location'),
                    jobType: formData.get('job-type'),
                    experienceLevel: formData.get('experience-level'),
                    description: formData.get('job-description'),
                    responsibilities: formData.get('responsibilities'),
                    qualifications: formData.get('qualifications'),
                    benefits: formData.get('benefits'),
                    skills: JSON.parse(formData.get('skills-final-input') || '[]'),
                    is_active: document.getElementById('is-enabled').checked,
                };

                const isInternship = payload.jobType === 'Internship';
                if (isInternship) {
                    payload.salary = formData.get('stipend-amount');
                } else {
                    const minSalary = formData.get('min-salary');
                    const maxSalary = formData.get('max-salary');
                    if (minSalary && maxSalary) {
                        payload.salary = `$${minSalary} - $${maxSalary}`;
                    } else if (minSalary) {
                        payload.salary = `$${minSalary}`;
                    } else {
                        payload.salary = 'Not Specified';
                    }
                }
                
                const url = jobId ? `/update_job/${jobId}/` : `/create_job/`;
                const method = jobId ? 'PUT' : 'POST';

                fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify(payload)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw err; });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        displayToast(`Job posting ${jobId ? 'updated' : 'created'} successfully!`, 'success');
                        jobCreationModal.style.display = 'none';
                        // Refresh the page or update the local jobsData array to reflect the changes
                        location.reload(); 
                    } else {
                        displayToast(data.message || 'An error occurred.', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    displayToast('An error occurred during job submission.', 'error');
                });
            });
        }

        // This function will toggle between salary and stipend fields in the creation form
        document.getElementById('job-type-buttons').addEventListener('change', (e) => {
            const salaryFields = document.getElementById('salary-fields');
            const stipendFields = document.getElementById('stipend-fields');
            if (e.target.value === 'Internship') {
                salaryFields.style.display = 'none';
                stipendFields.style.display = 'flex';
            } else {
                salaryFields.style.display = 'flex';
                stipendFields.style.display = 'none';
            }
        });

        if (keywordSearch) keywordSearch.addEventListener('input', filterAndSortJobs);
        if (locationFilter) locationFilter.addEventListener('change', filterAndSortJobs);
        if (jobTypeFilter) jobTypeFilter.addEventListener('change', filterAndSortJobs);
        if (experienceFilter) experienceFilter.addEventListener('change', filterAndSortJobs);
        if (statusFilter) statusFilter.addEventListener('change', filterAndSortJobs);
        if (sortBy) sortBy.addEventListener('change', filterAndSortJobs);
        if (resetFiltersBtn) {
            resetFiltersBtn.addEventListener('click', () => {
                keywordSearch.value = '';
                locationFilter.value = '';
                jobTypeFilter.value = '';
                experienceFilter.value = '';
                statusFilter.value = '';
                sortBy.value = 'newest';
                filterAndSortJobs();
            });
        }

        const skillsInput = document.getElementById('skills-input');
        if (skillsInput) {
            skillsInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && skillsInput.value.trim() !== '') {
                    e.preventDefault();
                    createSkillTag(skillsInput.value.trim());
                    skillsInput.value = '';
                }
            });
        }

        const init = () => {
            updateMetrics(jobsData);
            populateFilters();
            filterAndSortJobs();
            setupBulletPointFunctionality('job-description');
            setupBulletPointFunctionality('responsibilities');
            setupBulletPointFunctionality('qualifications');
            setupBulletPointFunctionality('benefits');
        };

        window.addEventListener('load', init);
    </script>
</body>
{% endblock %}