{% extends 'base.html' %}

{% block title %}Incoming Applications{% endblock %}
{% block page_heading %}Incoming Applications{% endblock %}

{% block content %}
<div class="content-wrapper">
    {% if emails %}
    <div class="card p-3 mb-4 shadow-subtle rounded-3">
        <div class="row align-items-center g-3">
            <div class="col-lg-4 col-md-6 col-12">
                <div class="input-group search-box">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" id="searchInput" class="form-control" placeholder="Search by name, location, email...">
                </div>
            </div>

            <div class="col-lg-8 col-md-6 col-12 d-flex flex-wrap justify-content-md-end align-items-center">
                <div class="filter-group me-3 mb-2 mb-md-0">
                    <span class="filter-label">Date:</span>
                    <div class="btn-group" role="group">
                        <button id="allApplicationsBtn" type="button" class="btn btn-filter-date active">All</button>
                        <button id="todaysApplicationsBtn" type="button" class="btn btn-filter-date">Today</button>
                    </div>
                </div>

                <div class="filter-group me-3 mb-2 mb-md-0">
                    <span class="filter-label">Source:</span>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-filter-source active" data-source="">
                            <i class="fas fa-filter"></i>
                        </button>
                        <button type="button" class="btn btn-filter-source" data-source="Gmail">
                            <i class="fas fa-envelope icon-gmail"></i>
                        </button>
                        <button type="button" class="btn btn-filter-source" data-source="Naukri">
                            <i class="fas fa-briefcase icon-naukri"></i>
                        </button>
                        <button type="button" class="btn btn-filter-source" data-source="LinkedIn">
                            <i class="fab fa-linkedin-in icon-linkedin"></i>
                        </button>
                        <button type="button" class="btn btn-filter-source" data-source="Glassdoor">
                            <i class="fas fa-building icon-glassdoor"></i>
                        </button>
                        <button type="button" class="btn btn-filter-source" data-source="Indeed">
                            <i class="fas fa-file-alt icon-indeed"></i>
                        </button>
                    </div>
                </div>

                <div class="filter-group mb-2 mb-md-0">
                    <span class="filter-label">ATS Analysis:</span>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-filter-ats active" data-ats-type="">All</button>
                        <button type="button" class="btn btn-filter-ats" data-ats-type="Basic">Basic</button>
                        <button type="button" class="btn btn-filter-ats" data-ats-type="Advance">Advanced</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card p-4 shadow-subtle rounded-3">
        <div class="table-responsive">
            <table id="incomingApplicationsTable" class="table universal-table">
                <thead>
                    <tr>
                        <th scope="col">Id</th>
                        <th scope="col">Candidate Name</th>
                        <th scope="col">Date Received</th>
                        <th scope="col">Experience</th>
                        <th scope="col">Mobile Number</th>
                        <th scope="col">Location</th>
                        <th scope="col">Email</th>
                        <th scope="col">Resume</th>
                        <th scope="col">Job Description</th>
                        <th scope="col">Remark</th>
                        <th scope="col">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for email in emails %}
                    <tr data-delivery-date="{{ email.delivery_date|date:'Y-m-d' }}" data-email-id="{{ email.id }}" data-analysis-type="{{ email.candidateanalysis_set.first.analysis_type|default:'' }}" data-source="{{ email.source|default:'' }}">
                        <td>{{ forloop.counter }}</td>
                        <td class="candidate-name">{{ email.candidate_name }}</td>
                        <td>{{ email.delivery_date|date:"Y-m-d" }}</td>
                        <td>{{ email.experience }}</td>
                        <td>{{ email.mobile_number }}</td>
                        <td>{{ email.location }}</td>
                        <td>{{ email.email_address }}</td>
                        <td class="text-center">
                            {% if email.resume_url %}
                                <a href="{{ email.resume_url }}" target="_blank" class="btn btn-sm btn-outline-secondary btn-view-resume">View</a>
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            <select class="form-select job-description-select">
                                <option value="">Select JD</option>
                                {% for jd in job_descriptions %}
                                    <option value="{{ jd.id }}" data-file-url="" {% if email.job_description and email.job_description.id == jd.id %}selected{% endif %}>{{ jd.title }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <div class="input-group">
                                <input type="text" class="form-control remark-input" value="{{ email.remark|default:'' }}" placeholder="Add remark..." readonly>
                            </div>
                        </td>
                        <td class="text-center">
                            <button type="button" class="btn btn-sm btn-primary btn-analyze" data-bs-toggle="modal" data-bs-target="#atsOptionsModal" data-email-id="{{ email.id }}">
                                Analyze
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div id="noApplicationsMessage" class="text-center p-5 text-muted" style="display: none;">
            <p><i class="fas fa-inbox fa-3x mb-3"></i></p>
            <h4 class="fw-light">No applications found for this filter.</h4>
        </div>

        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center" id="pagination-controls"></ul>
        </nav>
    </div>
    {% else %}
    <div class="text-center card p-5 mt-5 shadow-lg custom-card">
        <h3 class="text-muted">No incoming applications found.</h3>
        <p>This section will display emails with attached resumes for processing.</p>
        <p>Please ensure that Outlook is open and configured correctly on your local system.</p>
    </div>
    {% endif %}
</div>

<div class="modal fade" id="remarkModal" tabindex="-1" aria-labelledby="remarkModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="remarkModalLabel">Add/Edit Remark</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="remarkApplicationId">
                <div class="mb-3">
                    <label for="remarkTextArea" class="form-label">Remark</label>
                    <textarea class="form-control" id="remarkTextArea" rows="3" placeholder="Enter your remark here..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveRemarkBtn">Save</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="atsOptionsModal" tabindex="-1" aria-labelledby="atsOptionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-white" id="atsOptionsModalLabel">Choose an ATS Analysis Type</h5>
            </div>
            <div class="modal-body text-center">
                <p>Please select the type of analysis you would like to run on the resume.</p>
                <div class="d-grid gap-3">
                    <a href="#" id="basicAtsBtn" class="btn btn-outline-secondary btn-lg">
                        <span class="button-text">Basic ATS Analysis</span>
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    </a>
                    <a href="#" id="premiumAtsBtn" class="btn btn-primary btn-lg">
                        <span class="button-text">Advanced ATS Analysis</span>
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    :root {
        --primary-color: #174D8C;
        --secondary-color: #6c757d;
        --light-bg-color: #f4f7f9;
        --card-bg: #ffffff;
        --input-border: #d4d8de;
        --table-header-bg: var(--primary-color);
        --table-row-hover: #eaf1f7;

        /* Custom Colors for Filters */
        --date-filter-bg: #e0f2f7; /* Light blue */
        --date-filter-border: #b3e0ed;
        --date-filter-active-bg: #007bff; /* Bootstrap primary blue */
        --date-filter-active-color: white;

        --source-filter-bg: #e6e6e6; /* Light grey */
        --source-filter-border: #d4d4d4;
        --source-filter-active-bg: #6c757d; /* Bootstrap secondary grey */
        --source-filter-active-color: white;

        --ats-filter-bg: #e0e0e0; /* Light grey */
        --ats-filter-border: #cccccc;
        --ats-filter-active-bg: #28a745; /* Bootstrap success green */
        --ats-filter-active-color: white;

        /* Individual Source Icon Colors */
        --icon-gmail-color: #EA4335; /* Red */
        --icon-naukri-color: #FF7B00; /* Orange */
        --icon-linkedin-color: #0A66C2; /* LinkedIn Blue */
        --icon-glassdoor-color: #0CCE8D; /* Glassdoor Green */
        --icon-indeed-color: #00305E; /* Indeed Dark Blue */
        --icon-filter-color: #6c757d; /* Default filter icon grey */
    }
    body {
        font-family: 'Inter', sans-serif;
        background-color: var(--light-bg-color);
        color: #343a40;
    }
    .page-heading {
        font-size: 2.5rem;
        color: var(--primary-color);
        margin-bottom: 2rem;
        text-align: center;
        font-weight: 700;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
    }
    .card {
        border: none;
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.05) !important;
        background-color: var(--card-bg);
    }
    .shadow-subtle {
        box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.08) !important;
    }

    /* Filter & Search Layout */
    .filter-group {
        display: flex;
        align-items: center;
        white-space: nowrap;
    }
    .filter-label {
        font-weight: 600;
        color: #495057;
        margin-right: 0.5rem;
    }

    /* Search Input */
    .search-box .input-group-text {
        background-color: #f8f9fa;
        border: 1px solid var(--input-border);
        border-right: none;
        color: var(--secondary-color);
    }
    .search-box .form-control {
        border: 1px solid var(--input-border);
    }
    .search-box .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem rgba(23, 77, 140, 0.1);
    }

    /* General Button Group Styling */
    .btn-group .btn {
        font-weight: 500;
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        transition: all 0.2s ease-in-out;
        margin-right: -1px; /* To prevent double borders */
    }
    .btn-group .btn:first-child { border-top-left-radius: 0.375rem; border-bottom-left-radius: 0.375rem; }
    .btn-group .btn:last-child { border-top-right-radius: 0.375rem; border-bottom-right-radius: 0.375rem; margin-right: 0; }
    .btn-group .btn + .btn { margin-left: -1px; } /* Correct spacing */

    /* Date Filter Buttons */
    .btn-filter-date {
        border: 1px solid var(--date-filter-border);
        color: #333;
        background-color: var(--date-filter-bg);
    }
    .btn-filter-date.active, .btn-filter-date:hover {
        background-color: var(--date-filter-active-bg);
        color: var(--date-filter-active-color);
        border-color: var(--date-filter-active-bg);
        z-index: 1; /* Bring active/hovered button to front to show full border */
    }
    .btn-filter-date:hover:not(.active) {
        background-color: var(--date-filter-bg);
        filter: brightness(95%);
    }

    /* Source Filter Buttons (Icons) */
    .btn-filter-source {
        border: 1px solid var(--source-filter-border);
        color: #333;
        background-color: var(--source-filter-bg);
        min-width: 45px; /* Ensure consistent width for icons */
        text-align: center;
    }
    .btn-filter-source.active, .btn-filter-source:hover {
        background-color: var(--source-filter-active-bg);
        border-color: var(--source-filter-active-bg);
        color: var(--source-filter-active-color);
        z-index: 1;
    }
    .btn-filter-source:hover:not(.active) {
        background-color: var(--source-filter-bg);
        filter: brightness(95%);
    }
    .btn-filter-source i {
        font-size: 1.1rem; /* Adjust icon size */
    }

    /* Individual Source Icon Colors */
    .btn-filter-source[data-source=""] i { color: var(--icon-filter-color); }
    .btn-filter-source[data-source="Gmail"] i { color: var(--icon-gmail-color); }
    .btn-filter-source[data-source="Naukri"] i { color: var(--icon-naukri-color); }
    .btn-filter-source[data-source="LinkedIn"] i { color: var(--icon-linkedin-color); }
    .btn-filter-source[data-source="Glassdoor"] i { color: var(--icon-glassdoor-color); }
    .btn-filter-source[data-source="Indeed"] i { color: var(--icon-indeed-color); }

    /* Source Icon Colors when Active or Hovered */
    .btn-filter-source.active i,
    .btn-filter-source:hover i {
        color: white !important; /* Force white color when button is active or hovered */
    }

    /* ATS Analysis Filter Buttons */
    .btn-filter-ats {
        border: 1px solid var(--ats-filter-border);
        color: #333;
        background-color: var(--ats-filter-bg);
    }
    .btn-filter-ats.active, .btn-filter-ats:hover {
        background-color: var(--ats-filter-active-bg);
        color: var(--ats-filter-active-color);
        border-color: var(--ats-filter-active-bg);
        z-index: 1;
    }
    .btn-filter-ats:hover:not(.active) {
        background-color: var(--ats-filter-bg);
        filter: brightness(95%);
    }

    /* Table Styling */
    .universal-table {
        border-collapse: separate;
        border-spacing: 0;
        width: 100%;
        table-layout: fixed;
    }
    .universal-table thead th {
        background-color: var(--table-header-bg);
        color: white;
        text-transform: uppercase;
        font-size: 0.8rem;
        padding: 1rem 0.75rem;
        border: none;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .universal-table thead th:first-child { border-top-left-radius: 0.5rem; }
    .universal-table thead th:last-child { border-top-right-radius: 0.5rem; }
    .universal-table tbody tr {
        transition: background-color 0.2s;
        border-bottom: 1px solid #e9ecef;
    }
    .universal-table tbody tr:hover {
        background-color: var(--table-row-hover);
    }
    .universal-table td {
        padding: 1rem 0.75rem;
        vertical-align: middle;
        font-size: 0.9rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .universal-table tbody tr:last-child {
        border-bottom: none;
    }
    .table-responsive {
        border-radius: 0.5rem;
        overflow-x: auto;
    }
    .candidate-name {
        font-weight: 600;
        color: var(--primary-color);
    }

    /* Resume URL and Action Buttons */
    .btn-view-resume {
        padding: 0.25rem 0.75rem;
        font-size: 0.8rem;
    }
    .btn-analyze {
        font-size: 0.8rem;
        padding: 0.25rem 0.75rem;
    }
    .job-description-select {
        font-size: 0.85rem;
        padding: 0.375rem 0.75rem;
        height: auto;
        width: 100%;
        border-color: var(--input-border);
    }
    .remark-input {
        background-color: #f8f9fa;
        border-color: var(--input-border);
        cursor: pointer;
    }
    
    /* Modal Styling */
    .modal-header {
        background-color: var(--primary-color) !important;
    }
    .modal-body p {
        font-size: 1rem;
    }
    .modal-body .btn-lg {
        font-size: 1.1rem;
        font-weight: 600;
        transition: transform 0.2s;
    }
    .modal-body .btn-lg:hover {
        transform: translateY(-2px);
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function() {
        const rows = $("#incomingApplicationsTable tbody tr");
        const paginationControls = $("#pagination-controls");
        const rowsPerPage = 10;
        let currentPage = 1;

        // Ensure "All" buttons are active on page load
        $('#allApplicationsBtn').addClass('active');
        $('button.btn-filter-source[data-source=""]').addClass('active');
        $('button.btn-filter-ats[data-ats-type=""]').addClass('active');

        function displayRows(page) {
            const visibleRows = $("#incomingApplicationsTable tbody tr:visible");
            visibleRows.hide();
            let start = (page - 1) * rowsPerPage;
            let end = start + rowsPerPage;
            visibleRows.slice(start, end).show();
        }

        function setupPagination() {
            const numRows = $("#incomingApplicationsTable tbody tr:visible").length;
            const numPages = Math.ceil(numRows / rowsPerPage);
            paginationControls.empty();

            if (numPages > 1) {
                for (let i = 1; i <= numPages; i++) {
                    const li = $('<li>').addClass('page-item');
                    const a = $('<a>').addClass('page-link').attr('href', '#').text(i);
                    if (i === currentPage) {
                        li.addClass('active');
                    }
                    a.on('click', function(e) {
                        e.preventDefault();
                        currentPage = i;
                        displayRows(currentPage);
                        $('.page-item').removeClass('active');
                        li.addClass('active');
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    });
                    li.append(a);
                    paginationControls.append(li);
                }
                paginationControls.show();
            } else {
                paginationControls.hide();
            }
        }

        function filterAndPaginate() {
            const filter = $('#searchInput').val().toLowerCase();
            const isToday = $('#todaysApplicationsBtn').hasClass('active');
            
            const activeSourceFilter = $('button.btn-filter-source.active').data('source') || '';
            const activeAtsFilter = $('button.btn-filter-ats.active').data('ats-type') || '';
            
            const todayDate = new Date().toISOString().slice(0, 10);
            
            let hasVisibleRows = false;
            rows.each(function() {
                const row = $(this);
                const rowText = row.text().toLowerCase();
                const deliveryDate = row.data('delivery-date');
                const analysisType = String(row.data('analysis-type') || '');
                const source = String(row.data('source') || '');
                
                const dateMatch = isToday ? (deliveryDate === todayDate) : true;
                const textMatch = rowText.includes(filter);
                const sourceMatch = (activeSourceFilter === '') ? true : (source === activeSourceFilter);
                const typeMatch = (activeAtsFilter === '') ? true : (analysisType === activeAtsFilter);

                if (textMatch && dateMatch && typeMatch && sourceMatch) {
                    row.show();
                    hasVisibleRows = true;
                } else {
                    row.hide();
                }
            });

            if (hasVisibleRows) {
                $('#noApplicationsMessage').hide();
                currentPage = 1;
                displayRows(currentPage);
                setupPagination();
            } else {
                $('#noApplicationsMessage').show();
                paginationControls.empty();
            }
        }

        // Handle opening the modal on click of the readonly input
        $('#incomingApplicationsTable').on('click', '.remark-input', function() {
            const applicationId = $(this).closest('tr').data('email-id');
            const currentRemark = $(this).val();
            
            $('#remarkApplicationId').val(applicationId);
            $('#remarkTextArea').val(currentRemark);
            
            const remarkModal = new bootstrap.Modal(document.getElementById('remarkModal'));
            remarkModal.show();
        });

        // Function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Event listener for the "Save" button inside the modal
        $('#saveRemarkBtn').on('click', function(e) {
            e.preventDefault();
            const applicationId = $('#remarkApplicationId').val();
            const remark = $('#remarkTextArea').val();
            const $row = $(`tr[data-email-id="${applicationId}"]`);
            const jobDescriptionId = $row.find('.job-description-select').val();

            if (!remark && !jobDescriptionId) {
                alert('Please enter a remark or select a job description.');
                return;
            }

            const $button = $(this);
            $button.prop('disabled', true).text('Saving...');

            $.ajax({
                url: '/update_application_data/',
                type: 'POST',
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                data: JSON.stringify({
                    application_id: applicationId,
                    remark: remark,
                    job_description_id: jobDescriptionId
                }),
                success: function(response) {
                    if (response.success) {
                        $row.find('.remark-input').val(remark);
                        $button.text('Saved!');
                        
                        setTimeout(() => {
                            const remarkModal = bootstrap.Modal.getInstance(document.getElementById('remarkModal'));
                            if (remarkModal) {
                                remarkModal.hide();
                            }
                            $button.text('Save').prop('disabled', false);
                        }, 1000);
                    } else {
                        alert('Error saving data: ' + response.message);
                        $button.text('Save').prop('disabled', false);
                    }
                },
                error: function(xhr, status, error) {
                    console.error("AJAX Error:", status, error);
                    alert('An error occurred. Please try again.');
                    $button.text('Save').prop('disabled', false);
                }
            });
        });

        // Event listener for select change to automatically update the Job Description
        $('#incomingApplicationsTable').on('change', '.job-description-select', function() {
            const $select = $(this);
            const applicationId = $select.closest('tr').data('email-id');
            const jobDescriptionId = $select.val();
            const remark = $select.closest('tr').find('.remark-input').val();

            $.ajax({
                url: '/update_application_data/',
                type: 'POST',
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                data: JSON.stringify({
                    application_id: applicationId,
                    remark: remark,
                    job_description_id: jobDescriptionId
                }),
                success: function(response) {
                    if (response.success) {
                        console.log("Job Description updated successfully.");
                    } else {
                        alert('Error updating Job Description: ' + response.message);
                    }
                },
                error: function() {
                    alert('An error occurred while updating the Job Description. Please try again.');
                }
            });
        });

        // Event listeners for search and date filters
        $('#searchInput').on('keyup', filterAndPaginate);
        
        $('.filter-group .btn-group button').on('click', function() {
            // Remove active from all buttons in the same group
            $(this).closest('.btn-group').find('button').removeClass('active');
            // Add active to the clicked button
            $(this).addClass('active');
            filterAndPaginate();
        });

        let currentEmailId;
        $('#incomingApplicationsTable').on('click', '.btn-analyze', function() {
            currentEmailId = $(this).data('email-id');
        });

        $('#premiumAtsBtn').on('click', function(e) {
            e.preventDefault();
            const $currentRow = $(`[data-email-id="${currentEmailId}"]`);
            const selectedJdId = $currentRow.find('.job-description-select').val();

            if (!selectedJdId) {
                alert("Please select a job description before proceeding with advanced analysis.");
                return;
            }

            const url = `/advance_resume_analysis/?application_id=${currentEmailId}&job_description_id=${selectedJdId}`;
            
            const $button = $(this);
            $button.prop('disabled', true);
            $button.find('.button-text').text('Loading...');
            $button.find('.spinner-border').removeClass('d-none');
            
            window.location.href = url;
        });

        $('#basicAtsBtn').on('click', function(e) {
            e.preventDefault();
            const $currentRow = $(`[data-email-id="${currentEmailId}"]`);
            const selectedJdId = $currentRow.find('.job-description-select').val();

            if (!selectedJdId) {
                alert("Please select a job description before proceeding with basic analysis.");
                return;
            }

            const url = `/basic_resume_analysis/?application_id=${currentEmailId}&job_description_id=${selectedJdId}`;
            
            const $button = $(this);
            $button.prop('disabled', true);
            $button.find('.button-text').text('Loading...');
            $button.find('.spinner-border').removeClass('d-none');
            
            window.location.href = url;
        });

        // Initial display of rows
        filterAndPaginate();
    });
</script>
{% endblock %}