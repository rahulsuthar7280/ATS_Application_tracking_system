{% extends 'base.html' %}

{% block title %}Resume Analysis{% endblock %}
{% block page_heading %}AI Agent-Based Resume Screening and Evaluation{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap">
<link rel="stylesheet" href="../static/css/style_ats.css">



<div class="container container-main">
    <!-- <h1 class="page-heading">AI Agent-Based Resume Screening and Evaluation</h1> -->
    
    <!-- Main Content Area: Form on left, PDF Preview on right -->
    <div class="row g-4 mb-4">
        <!-- Input Form Section (Left Column) -->
<div class="col-md-6">
    <div class="content-section-card">
        <h2 class="section-title">Candidate Details</h2>
        <form method="post" enctype="multipart/form-data" id="resumeForm">
            {% csrf_token %}
            <div class="row g-4">
                <div class="col-12">
                    <label for="resumeInput" class="form-label">Upload Candidate Resume</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="resumeInput" name="{{ form.resume_pdf.name }}" accept="application/pdf" required>
                        <div class="btn-file-upload">
                            <i class="fas fa-file-pdf"></i>
                            <span id="resumeFileName">No file chosen</span>
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <label for="jobDescriptionSource" class="form-label">Job Description Source</label>
                    <div class="d-flex align-items-center mb-3">
                        <div class="form-check me-4">
                            <input class="form-check-input" type="radio" name="jdSource" id="selectJdRadio" value="select" checked>
                            <label class="form-check-label" for="selectJdRadio">Select Existing</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="jdSource" id="uploadJdRadio" value="upload">
                            <label class="form-check-label" for="uploadJdRadio">Upload New</label>
                        </div>
                    </div>
                    <div id="selectJdSection">
                        <div class="form-group-floating">
                            <select class="form-select-custom" id="jobDescriptionSelect" name="job_description_id">
                                <option value="">-- Select an Existing Job Description --</option>
                                {% for doc in job_description_documents %}
                                <option value="{{ doc.id }}">{{ doc.title }}</option>
                                {% endfor %}
                            </select>
                            <label for="jobDescriptionSelect">Select Existing JD</label>
                        </div>
                    </div>
                    <div id="uploadJdSection" style="display: none;">
                        <div class="file-input-wrapper">
                            <input type="file" id="jobDescriptionInput" name="{{ form.job_description.name }}" accept=".pdf,.doc,.docx,.txt">
                            <div class="btn-file-upload">
                                <i class="fas fa-file-word"></i>
                                <span id="jobDescriptionFileName">No file chosen</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-group-floating">
                        <input type="text" class="form-control-custom" id="{{ form.job_role.id_for_label }}" name="{{ form.job_role.name }}" value="{{ form.job_role.value|default:'' }}" {% if form.job_role.field.required %}required{% endif %}>
                        <label for="{{ form.job_role.id_for_label }}">
                            <i class="fas fa-briefcase me-2"></i> Job Role
                        </label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group-floating">
                        <select class="form-select-custom" id="{{ form.target_experience_type.id_for_label }}" name="{{ form.target_experience_type.name }}" {% if form.target_experience_type.field.required %}required{% endif %}>
                            {% for value, label in form.target_experience_type.field.choices %}
                            <option value="{{ value }}" {% if form.target_experience_type.value == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                        <label for="{{ form.target_experience_type.id_for_label }}">
                            <i class="fas fa-chart-line me-2"></i> Experience Level
                        </label>
                    </div>
                </div>
            </div>
            
            <div id="experience_fields" class="row g-3 px-3 w-100 mt-2" style="display: none;">
                <div class="col-sm-6">
                    <div class="form-group-floating">
                        <input type="number" class="form-control-custom" id="{{ form.min_years_required.id_for_label }}" name="{{ form.min_years_required.name }}" value="{{ form.min_years_required.value|default:'' }}" min="0" step="1">
                        <label for="{{ form.min_years_required.id_for_label }}">
                            <i class="fas fa-sort-numeric-up me-2"></i> Min. Years
                        </label>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="form-group-floating">
                        <input type="number" class="form-control-custom" id="{{ form.max_years_required.id_for_label }}" name="{{ form.max_years_required.name }}" value="{{ form.max_years_required.value|default:'' }}" min="0" step="1">
                        <label for="{{ form.max_years_required.id_for_label }}">
                            <i class="fas fa-sort-numeric-down me-2"></i> Max. Years
                        </label>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-end mt-4">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-magic me-2"></i> Analyse Resume
                </button>
            </div>
        </form>
    </div>
</div>

        <!-- PDF Preview Section (Right Column) -->
        <div class="col-md-6">
            <div class="content-section-card pdf-preview-section h-100">
                <!-- <h2 class="section-title">Resume Preview</h2> -->
                <embed id="pdfEmbed"
                    class="pdf-embed"
                    type="application/pdf"
                    style="display: {% if resume_url %}block{% else %}none{% endif %};"
                    {% if resume_url %}src="{{ resume_url }}#toolbar=0&navpanes=0"{% endif %}>

                <div class="pdf-placeholder" id="pdfPlaceholder"
                        style="display: {% if resume_url %}none{% else %}flex{% endif %};">
                    <i class="fas fa-file-pdf"></i>
                    <p class="message">Upload a PDF Resume to Preview</p>
                    <p class="sub-message">The AI analysis will begin shortly after.</p>
                    <p class="error-message" id="pdfErrorMessage" style="display: none;"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section (Initially hidden or shown based on analysis_result) -->
    {% if analysis_result %}
        <div class="content-section-card results-section show" data-analysis-loaded="true">
        <!-- <div class="results-section show" data-analysis-loaded="true"> -->
            <h2 class="section-title">AI Analysis for <span class="text-primary">{{ analysis_result.full_name|default:"Candidate" }}</span></h2>
            
            <ul class="nav nav-tabs" id="analysisTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab" aria-controls="summary" aria-selected="true">
                        <i class="fas fa-chart-pie me-2"></i> Summary
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact" type="button" role="tab" aria-controls="contact" aria-selected="false">
                        <i class="fas fa-address-book me-2"></i> Contact Info
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab" aria-controls="details" aria-selected="false">
                        <i class="fas fa-info-circle me-2"></i> Detailed Analysis
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="skills-projects-tab" data-bs-toggle="tab" data-bs-target="#skills-projects" type="button" role="tab" aria-controls="skills-projects" aria-selected="false">
                        <i class="fas fa-code me-2"></i> Skills & Projects
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="recommendations-tab" data-bs-toggle="tab" data-bs-target="#recommendations" type="button" role="tab" aria-controls="recommendations" aria-selected="false">
                        <i class="fas fa-lightbulb me-2"></i> Recommendations
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="questions-tab" data-bs-toggle="tab" data-bs-target="#questions" type="button" role="tab" aria-controls="questions" aria-selected="false">
                        <i class="fas fa-question-circle me-2"></i> Interview Questions
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="analysisTabContent">
                <!-- Summary Tab Pane -->
                <div class="tab-pane fade show active" id="summary" role="tabpanel" aria-labelledby="summary-tab">
                    <div class="row g-4 mb-4">
                        <div class="col-md-3 col-sm-6">
                            <div class="summary-tile fade-in-item">
                                <h6><i class="fas fa-briefcase me-2"></i> Job Role</h6>
                                <p>{{ form.job_role.value|default:"N/A" }}</p>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="summary-tile fade-in-item">
                                <h6><i class="fas fa-chart-line me-2"></i> Overall Experience</h6>
                                <p>{{ analysis_result.overall_experience|default:"N/A" }}</p>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="summary-tile fade-in-item">
                                <h6><i class="fas fa-thumbs-up me-2"></i> Hiring Recommendation</h6>
                                <p class="
                                    {% if analysis_result.hiring_recommendation == 'Hire' or analysis_result.hiring_recommendation == 'Strong Hire' %}text-success
                                    {% elif analysis_result.hiring_recommendation == 'Reject' %}text-danger
                                    {% else %}text-warning{% endif %}">
                                    {{ analysis_result.hiring_recommendation|default:"N/A" }}
                                </p>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="summary-tile fade-in-item">
                                <h6><i class="fas fa-percentage me-2"></i> Experience Match</h6>
                                <p class="text-success">{{ analysis_result.experience_match|default:"N/A" }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="row g-4 mb-4">
                        <div class="col-md-6">
                            <div class="fitment-verdict-box fade-in-item">
                                <h5 class="text-primary"><i class="fas fa-shield-alt me-2"></i> Candidate Fitment Verdict</h5>
                                <p class="fitment-verdict mt-3 
                                        {% if analysis_result.fitment_verdict == 'SELECTED' %}selected
                                        {% elif analysis_result.fitment_verdict == 'MARGINALLY FIT' %}marginal
                                        {% else %}rejected{% endif %}">
                                    {{ analysis_result.fitment_verdict|default:"N/A" }}
                                </p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="content-box fade-in-item">
                                <h6><i class="fas fa-sitemap me-2"></i> Strategic Alignment</h6>
                                <p>{{ analysis_result.candidate_fitment_analysis.strategic_alignment|default:"N/A" }}</p>
                            </div>
                        </div>
                    </div>
                    <h4 class="section-title mt-5">Core Competency Assessment</h4>
                    <div class="row g-4 mb-4">
                        {% if analysis_result.core_competencies_assessment %}
                            {% for competency in analysis_result.core_competencies_assessment %}
                                <div class="col-md-3 col-sm-6">
                                    <div class="summary-tile fade-in-item">
                                        <h6><i class="fas fa-star me-2"></i> {{ competency.competency|default:"N/A" }}</h6>
                                        <p class="
                                            {% if competency.level == 'Excellent' or competency.level == 'Advanced' %}text-success
                                            {% elif competency.level == 'Proficient' %}text-primary
                                            {% elif competency.level == 'Intermediate' %}text-warning
                                            {% else %}text-muted{% endif %}
                                        ">
                                            {{ competency.level|default:"N/A" }}
                                        </p>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="col-12">
                                <div class="content-box text-center text-muted fade-in-item">
                                    <p>No core competency assessment data available.</p>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Contact Info Tab Pane -->
                <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">
                    <h4 class="section-title">Candidate Contact Information</h4>
                    <div class="row g-4 mb-4">
                        <div class="col-md-4 col-sm-6">
                            <div class="summary-tile fade-in-item">
                                <h6><i class="fas fa-user me-2"></i> Full Name</h6>
                                <p>{{ analysis_result.full_name|default:"N/A" }}</p>
                            </div>
                        </div>
                        <div class="col-md-4 col-sm-6">
                            <div class="summary-tile fade-in-item">
                                <h6><i class="fas fa-phone me-2"></i> Phone Number</h6>
                                <p>{{ analysis_result.phone_no|default:"N/A" }}</p>
                            </div>
                        </div>
                        <div class="col-md-4 col-sm-6">
                            <div class="summary-tile fade-in-item">
                                <h6><i class="fas fa-envelope me-2"></i> Email Address</h6>
                                <p>{{ analysis_result.email|default:"N/A" }}</p>
                            </div>
                        </div>
                        <div class="col-md-4 col-sm-6">
                            <div class="summary-tile fade-in-item">
                                <h6><i class="fab fa-linkedin me-2"></i> LinkedIn Profile</h6>
                                {% if analysis_result.linkedin_url %}
                                    <p><a href="{{ analysis_result.linkedin_url }}" target="_blank" class="text-primary">{{ analysis_result.linkedin_url|truncatechars:30 }}</a></p>
                                {% else %}
                                    <p>N/A</p>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4 col-sm-6">
                            <div class="summary-tile fade-in-item">
                                <h6><i class="fab fa-github me-2"></i> GitHub Profile</h6>
                                {% if analysis_result.github_url %}
                                    <p><a href="{{ analysis_result.github_url }}" target="_blank" class="text-primary">{{ analysis_result.github_url|truncatechars:30 }}</a></p>
                                {% else %}
                                    <p>N/A</p>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4 col-sm-6">
                            <div class="summary-tile fade-in-item">
                                <h6><i class="fas fa-map-marker-alt me-2"></i> Current Company Address</h6>
                                <p>{{ analysis_result.current_company_address|default:"N/A" }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Analysis Tab Pane -->
                <div class="tab-pane fade" id="details" role="tabpanel" aria-labelledby="details-tab">
                    <h4 class="section-title">Deep-Dive Scoring Matrix</h4>
                    <div class="table-responsive fade-in-item">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Evaluation Dimension</th>
                                    <th>Weight</th>
                                    <th>Score</th>
                                    <th>Evidence-Based Justification</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in analysis_result.scoring_matrix %}
                                    <tr>
                                        <td class="fw-bold">{{ item.dimension|default:"N/A" }}</td>
                                        <td>{{ item.weight|default:"N/A" }}</td>
                                        <td>{{ item.score|default:"N/A" }}</td>
                                        <td>{{ item.justification|default:"N/A" }}</td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">No scoring matrix data available.</td>
                                    </tr>
                                {% endfor %}
                                <tr>
                                    <td class="fw-bold">âž¤ Aggregate Score</td>
                                    <td>100%</td>
                                    <td class="fw-bold">{{ analysis_result.aggregate_score|default:"N/A" }}</td>
                                    <td></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h4 class="section-title mt-5">Detailed Analysis Summary</h4>
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="content-box fade-in-item">
                                <h6><i class="fas fa-user-circle me-2 text-primary"></i> Candidate Overview</h6>
                                <p>{{ analysis_result.analysis_summary.candidate_overview|default:"No candidate overview provided." }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="content-box fade-in-item">
                                <h6><i class="fas fa-chart-line me-2 text-success"></i> Quantifiable Impact</h6>
                                <p>{{ analysis_result.candidate_fitment_analysis.quantifiable_impact|default:"N/A" }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="content-box fade-in-item">
                                <h6><i class="fas fa-exclamation-triangle me-2 text-danger"></i> Potential Gaps & Risks</h6>
                                <p>{{ analysis_result.candidate_fitment_analysis.potential_gaps_risks|default:"N/A" }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="content-box fade-in-item">
                                <h6><i class="fas fa-briefcase me-2 text-info"></i> Comparable Experience</h6>
                                <p>{{ analysis_result.candidate_fitment_analysis.comparable_experience_analysis|default:"N/A" }}</p>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="content-box fade-in-item">
                                <h6><i class="fas fa-check-circle me-2 text-secondary"></i> Conclusion</h6>
                                <p>{{ analysis_result.analysis_summary.conclusion|default:"No conclusion provided." }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Skills & Projects Tab Pane -->
                <div class="tab-pane fade" id="skills-projects" role="tabpanel" aria-labelledby="skills-projects-tab">
                    <h4 class="section-title">Technical Skills & Education</h4>
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="content-box fade-in-item">
                                <h6><i class="fas fa-laptop-code me-2 text-primary"></i> Technical Prowess</h6>
                                <ul>
                                    {% for skill_category, skills in analysis_result.analysis_summary.technical_prowess.items %}
                                        <li><strong>{{ skill_category }}:</strong> {{ skills|join:", " }}</li>
                                    {% empty %}
                                        <li>No technical skills identified.</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="content-box fade-in-item">
                                <h6><i class="fas fa-graduation-cap me-2 text-primary"></i> Education & Certifications</h6>
                                <ul>
                                    {% for edu in analysis_result.analysis_summary.education_certifications.education %}
                                        <li>{{ edu }}</li>
                                    {% empty %}
                                        <li>No education details provided.</li>
                                    {% endfor %}
                                    {% for cert in analysis_result.analysis_summary.education_certifications.certifications %}
                                        <li>{{ cert }}</li>
                                    {% empty %}
                                        <li>No certifications provided.</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <h4 class="section-title mt-5">Project Impact & Achievements</h4>
                    <div class="row g-4">
                        {% for project in analysis_result.analysis_summary.project_impact %}
                            <div class="col-12">
                                <div class="content-box fade-in-item">
                                    <h6><i class="fas fa-project-diagram me-2 text-warning"></i> {{ project.title|default:"Project Title N/A" }}</h6>
                                    <p><strong>Company:</strong> {{ project.company|default:"N/A" }}</p>
                                    <p><strong>Role:</strong> {{ project.role|default:"N/A" }}</p>
                                    <p><strong>Achievements:</strong></p>
                                    <ul>
                                        {% for achievement in project.achievements %}
                                            <li>{{ achievement }}</li>
                                        {% empty %}
                                            <li>No specific achievements listed.</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        {% empty %}
                            <div class="col-12">
                                <div class="content-box text-muted fade-in-item">
                                    <p>No project impact or achievements found.</p>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Recommendations Tab Pane -->
                <div class="tab-pane fade" id="recommendations" role="tabpanel" aria-labelledby="recommendations-tab">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="content-box fade-in-item">
                                <h6><i class="fas fa-tasks me-2 text-primary"></i> Bench & Alternative Roles</h6>
                                <p><strong>Retain for future consideration?</strong> {{ analysis_result.bench_recommendation.retain|default:"N/A" }}</p>
                                <p><strong>Ideal Future Role(s):</strong> {{ analysis_result.bench_recommendation.ideal_future_roles|join:", "|default:"N/A" }}</p>
                                <p><strong>Justification:</strong> {{ analysis_result.bench_recommendation.justification|default:"N/A" }}</p>
                                <h6 class="mt-4"><i class="fas fa-exchange-alt me-2 text-info"></i> Alternative Role Recommendations</h6>
                                <ul>
                                    {% for role in analysis_result.alternative_role_recommendations %}
                                        <li><strong>{{ role.role|default:"N/A" }}:</strong> {{ role.explanation|default:"N/A" }}</li>
                                    {% empty %}
                                        <li>No alternative roles suggested.</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="content-box fade-in-item">
                                <h6><i class="fas fa-lightbulb me-2 text-warning"></i> Automated Recruiter Insights</h6>
                                <p><strong>Red Flag Detection:</strong> {{ analysis_result.automated_recruiter_insights.red_flag_detection|default:"None" }}</p>
                                <p><strong>Growth Indicators:</strong> {{ analysis_result.automated_recruiter_insights.growth_indicators|default:"None" }}</p>
                                <p><strong>Cross-Industry Potential:</strong> {{ analysis_result.automated_recruiter_insights.cross_industry_potential|default:"None" }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Interview Questions Tab Pane -->
                <div class="tab-pane fade" id="questions" role="tabpanel" aria-labelledby="questions-tab">
                    <h4 class="section-title">Suggested Interview Questions for <span class="text-primary">{{ analysis_result.full_name|default:"the Candidate" }}</span></h4>
                    <ul class="questions-list">
                        {% for question in analysis_result.interview_questions %}
                            <li class="fade-in-item">{{ question }}</li>
                        {% empty %}
                            <li class="text-muted fade-in-item">No specific questions were generated.</li>
                        {% endfor %}
                    </ul>
                    <div class="d-flex justify-content-end mt-4 pt-3 border-top fade-in-item">
                        {% if analysis_result.id %}
                            <a href="{% url 'interview_status' candidate_id=analysis_result.id %}" class="btn btn-primary-custom btn-lg">
                                Proceed to Call Interview <i class="fas fa-arrow-right btn-icon-right"></i>
                            </a>
                        {% else %}
                            <button type="button" class="btn btn-secondary btn-lg" disabled>
                                Proceed to Call Interview (No Candidate ID) <i class="fas fa-arrow-right btn-icon-right"></i>
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <!-- <div class="content-section-card no-results-message fade-in-item">
            <i class="fas fa-robot"></i>
            <p>Upload a resume and job details to see AI-powered analysis here!</p>
            <p class="text-muted">The results will appear after a successful analysis.</p>
        </div> -->
    {% endif %}
</div>

<!-- Preloader HTML -->
<div id="preloader">
    <div class="preloader-overlay"></div>
    <div class="preloader-content">
        <h3 class="preloader-title">Analyzing Resume...</h3>
        <p class="preloader-text" id="preloaderMessage">Initializing AI agents...</p>
        <div class="progress-container">
            <div id="progressBar" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                <span id="progressText">0%</span>
            </div>
        </div>
    </div>
</div>



{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const experienceTypeSelect = document.getElementById('{{ form.target_experience_type.id_for_label }}');
        const experienceFieldsDiv = document.getElementById('experience_fields');
        const minYearsInput = document.getElementById('{{ form.min_years_required.id_for_label }}');
        const maxYearsDiv = document.getElementById('max_years_div');
        const maxYearsInput = document.getElementById('{{ form.max_years_required.id_for_label }}');

        function toggleExperienceFields() {
            if (!experienceTypeSelect || !experienceFieldsDiv || !minYearsInput || !maxYearsDiv || !maxYearsInput) {
                return;
            }

            const selectedValue = experienceTypeSelect.value;
            experienceFieldsDiv.style.display = 'none';

            minYearsInput.setAttribute('disabled', 'disabled');
            minYearsInput.value = '';
            maxYearsInput.setAttribute('disabled', 'disabled');
            maxYearsInput.value = '';

            if (selectedValue === 'Specific Range (Years)' || selectedValue === 'Minimum Years Required') {
                experienceFieldsDiv.style.display = 'flex';
                minYearsInput.removeAttribute('disabled');

                if (selectedValue === 'Specific Range (Years)') {
                    maxYearsDiv.style.display = 'block';
                    maxYearsInput.removeAttribute('disabled');
                } else {
                    maxYearsDiv.style.display = 'none';
                }
            }
            // Trigger update for floating label on change
            updateFloatingLabel(experienceTypeSelect);
        }

        if (experienceTypeSelect) {
            toggleExperienceFields();
            experienceTypeSelect.addEventListener('change', toggleExperienceFields);
        }

        const resumeFileInput = document.getElementById('resumeInput');
        const resumeFileNameSpan = document.getElementById('resumeFileName');
        const jobDescriptionFileInput = document.getElementById('jobDescriptionInput');
        const jobDescriptionFileNameSpan = document.getElementById('jobDescriptionFileName');
        const pdfEmbed = document.getElementById('pdfEmbed');
        const pdfPlaceholder = document.getElementById('pdfPlaceholder');
        const pdfErrorMessage = document.getElementById('pdfErrorMessage');

        // Initialize PDF viewer state
        if (pdfEmbed && pdfEmbed.src && pdfEmbed.src !== window.location.href + '#toolbar=0&navpanes=0') { // Check if src is actually set
            pdfEmbed.style.display = 'block';
            if (pdfPlaceholder) pdfPlaceholder.style.display = 'none';
        } else {
            if (pdfEmbed) pdfEmbed.style.display = 'none';
            if (pdfPlaceholder) pdfPlaceholder.style.display = 'flex';
        }

        // Handle resume file input change
        if (resumeFileInput) {
            resumeFileInput.addEventListener('change', function () {
                const file = this.files[0];
                if (file) {
                    resumeFileNameSpan.textContent = file.name;
                    if (file.type === 'application/pdf') {
                        const fileURL = URL.createObjectURL(file);
                        pdfEmbed.src = fileURL + '#toolbar=0&navpanes=0';
                        pdfEmbed.style.display = 'block';
                        pdfPlaceholder.style.display = 'none';
                        pdfErrorMessage.style.display = 'none'; // Hide error message
                    } else {
                        pdfEmbed.src = '';
                        pdfEmbed.style.display = 'none';
                        pdfPlaceholder.style.display = 'flex';
                        pdfErrorMessage.textContent = "Please upload a valid PDF file for resume preview.";
                        pdfErrorMessage.style.display = 'block'; // Show error message
                    }
                } else {
                    resumeFileNameSpan.textContent = 'No file chosen';
                    pdfEmbed.src = '';
                    pdfEmbed.style.display = 'none';
                    pdfPlaceholder.style.display = 'flex';
                    pdfErrorMessage.style.display = 'none';
                }
            });
        }

        // Handle job description file input change
        if (jobDescriptionFileInput) {
            jobDescriptionFileInput.addEventListener('change', function () {
                const file = this.files[0];
                if (file) {
                    jobDescriptionFileNameSpan.textContent = file.name;
                } else {
                    jobDescriptionFileNameSpan.textContent = 'No file chosen';
                }
            });
        }


        // Preloader Logic
        const resumeForm = document.getElementById('resumeForm');
        const preloader = document.getElementById('preloader');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const preloaderMessage = document.getElementById('preloaderMessage');
        const resultsSection = document.querySelector('.results-section');

        const preloaderMessages = [
            "Initializing AI agents...",
            "Extracting key information from your resume...",
            "Analyzing skills and experience...",
            "Comparing with job description requirements...",
            "Generating comprehensive fitment analysis...",
            "Calculating strategic alignment...",
            "Detecting potential red flags and growth indicators...",
            "Crafting personalized interview questions...",
            "Finalizing report for presentation..."
        ];
        let messageIndex = 0;
        let messageInterval;

        function startMessageCycle() {
            messageIndex = 0;
            preloaderMessage.textContent = preloaderMessages[messageIndex];
            messageInterval = setInterval(() => {
                messageIndex = (messageIndex + 1) % preloaderMessages.length;
                preloaderMessage.textContent = preloaderMessages[messageIndex];
            }, 2000); // Change message every 2 seconds
        }

        function stopMessageCycle() {
            clearInterval(messageInterval);
        }

        if (resumeForm) {
            resumeForm.addEventListener('submit', function(event) {
                // Check if a PDF is selected for resume, otherwise let the form validation handle it
                if (!resumeFileInput.files.length || resumeFileInput.files[0].type !== 'application/pdf') {
                    // Form validation for required fields will prevent submission if resume is not selected
                    // The custom error message for PDF type is already handled by the change listener
                    return; 
                }
                
                // Prevent the form from submitting immediately
                event.preventDefault();
                
                // Show the preloader with animation
                preloader.classList.add('show');
                startMessageCycle();
                
                let currentProgress = 0;
                const form = this;

                // Simulate progress
                const progressInterval = setInterval(function() {
                    currentProgress += 10;
                    if (currentProgress <= 90) { 
                        progressBar.style.width = currentProgress + '%';
                        progressText.textContent = currentProgress + '%';
                    } else {
                        clearInterval(progressInterval);
                        stopMessageCycle();
                        // Once the simulated progress is done, submit the form
                        form.submit(); 
                    }
                }, 500); // Update progress every 500ms
            });
        }

        // Fade in results section on load if analysis_result exists
        if (resultsSection && resultsSection.dataset.analysisLoaded) {
            resultsSection.classList.add('show');
            // Staggered fade-in for results section items
            const fadeInItems = document.querySelectorAll('.results-section .fade-in-item');
            fadeInItems.forEach((item, index) => {
                item.style.animationDelay = `${index * 0.1}s`; // Stagger by 100ms
                item.classList.add('show-animation'); /* Use the new class to trigger animation */
            });
        }

        // Function to update floating label state
        function updateFloatingLabel(input) {
            const isSelectAndHasValue = input.tagName === 'SELECT' && input.value !== '';
            if (input.value || input === document.activeElement || isSelectAndHasValue) {
                input.classList.add('has-value');
            } else {
                input.classList.remove('has-value');
            }
        }

        // Add 'has-value' class to form-group-floating when input is focused or has value
        document.querySelectorAll('.form-group-floating .form-control-custom, .form-group-floating .form-select-custom').forEach(input => {
            input.addEventListener('focus', () => updateFloatingLabel(input));
            input.addEventListener('blur', () => updateFloatingLabel(input));
            input.addEventListener('change', () => updateFloatingLabel(input)); // For select elements
            updateFloatingLabel(input); // Initial check on load
        });
    });
</script>

{% endblock %}
