{% extends 'base.html' %}

{% block title %}Advanced Resume Analysis{% endblock %}
{% block page_heading %}Advanced AI Agent-Based Resume Screening and Evaluation{% endblock %}

{% block content %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap">
<link rel="stylesheet" href="../static/css/style_ats.css">

<style>
    /* Custom CSS to improve layout and design */

    :root {
        --primary-color: #3e4f47; /* Dark Teal/Green - Primary Action Color */
        --secondary-color: #6c757d; /* Gray */
        --background-color: #f8f9fa; /* Light Gray */
        --card-bg-color: #ffffff; /* White */
        --border-color: #e0e0e0; /* Light Gray Border */
        --shadow-color: rgba(0, 0, 0, 0.08); /* Soft Shadow */
        --text-color-primary: #343a40; /* Dark Gray */
        --text-color-secondary: #6c757d; /* Gray */
        --success-color: #28a745;
        --danger-color: #dc3545;
        --warning-color: #ffc107;
        --info-color: #3e4f47; /* Using primary color for info */
        --primary-light: #5a736a; /* Lighter shade of primary for hover/focus */
    }

    /* General containers and cards */
    .container-main {
        max-width: 1700px;
        /* margin-top: 2rem; */
    }
     .plan-comparison-bar {
        background-color: var(--card-bg-color);
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    .plan-block {
        text-align: center;
        padding: 1.5rem;
        border-radius: 0.5rem;
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }
    .basic-plan {
        background-color: #e6f4ea; /* Light Green background */
        border-color: var(--success-color);
    }
    .advanced-plan {
        background-color: #f7f7f7; /* Light Gray background */
        border-color: var(--border-color);
    }
    .advanced-plan.upgrade-needed {
        border-color: var(--danger-color);
        background-color: #fbebeb; /* Light Red/Danger background */
    }
    .plan-block h5 {
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    .plan-block .feature-list li {
        list-style: none;
        padding: 0.2rem 0;
        font-size: 0.9rem;
    }
    .feature-check {
        color: var(--success-color);
    }
    .feature-limit {
        color: var(--danger-color);
    }
    .pdf-embed {
        width: 100%;
        height: 80%;
        border: none;
    }
    .current-badge {
        position: absolute;
        top: -15px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.75rem;
        padding: 0.3em 0.8em;
        border-radius: 50px;
        background-color: var(--primary-color);
        color: white;
        font-weight: 700;
    }
    .mode-btn {
        font-weight: 600;
        transition: all 0.3s ease-in-out;
    }
    .content-section-card {
        background-color: var(--card-bg-color);
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 4px 20px var(--shadow-color);
        border: 1px solid var(--border-color);
        min-height: 400px;
    }
    .section-title {
        color: #3e4f47;
        font-weight: 700;
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }
    .section-description {
        color: var(--text-color-secondary);
        font-size: 0.95rem;
    }
    .section-sub-title {
        color: var(--primary-color);
        font-weight: 600;
        font-size: 1.25rem;
    }

    /* Mode Selector Improvement */
    .mode-btn {
        font-weight: 600;
        /* padding: 0.85rem 1rem; Slightly more padding */
        border-radius: 8px !important; /* Ensure rounded corners */
        transition: all 0.3s ease-in-out;
        border-width: 5px; /* Thicker border for better contrast */
        border-color: var(--border-color);
    }
    /* Default inactive style */
    .mode-btn {
        
        color: var(--text-color-secondary);
        background-color: var(--card-bg-color);
    }
    /* Active style for Advanced AI (Use primary color) */
    #advanced-ai-btn.active {
        background-color: var(--primary-color) !important;
        border-color: var(--primary-color) !important;
        color: #fff !important;
        box-shadow: 0 4px 10px rgba(62, 79, 71, 0.3); /* Subtle shadow for active */
    }
    #advanced-ai-btn {
    height: 120px; /* adjust as needed */
    display: flex;
    /* color: orangered; */
    flex-direction: column;
    justify-content: center;
    }
    #basic-ats-btn {
    height: 120px;
    display: flex;
    /* color: orangered; */
    flex-direction: column;
    justify: center;
    }
    /* Active style for Basic ATS (Use secondary color) */
    #basic-ats-btn.active {
        background-color: var(--secondary-color) !important;
        border-color: var(--secondary-color) !important;
        color: #fff !important;
        box-shadow: 0 4px 10px rgba(108, 117, 125, 0.3); /* Subtle shadow for active */
    }

    /* File Input Wrapper Improvement - Dropzone style */
    .file-input-wrapper {
        position: relative;
        border: 2px dashed var(--border-color);
        border-radius: 12px;
        padding: 2.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        background-color: var(--background-color);
    }
    .file-input-wrapper:hover {
        border-color: var(--primary-light);
        background-color: #f0f3f6;
    }
    .file-input-wrapper input[type="file"] {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }
    .btn-file-upload {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        color: var(--text-color-secondary);
    }
    .btn-file-upload i {
        color: var(--primary-color);
    }

    /* Floating Form Control Improvement */
    .form-group-floating {
        position: relative;
        margin-bottom: 1.5rem;
    }

    .form-control-custom, .form-select-custom {
        display: block;
        width: 100%;
        padding: 1rem 1rem;
        font-size: 1rem;
        line-height: 1.5;
        color: var(--text-color-primary);
        background-color: var(--card-bg-color);
        background-clip: padding-box;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    .form-control-custom:focus, .form-select-custom:focus {
        color: var(--text-color-primary);
        background-color: var(--card-bg-color);
        border-color: var(--primary-color);
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(62, 79, 71, 0.25);
    }

    .form-group-floating label {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        padding: 1rem 1rem;
        pointer-events: none;
        border: 1px solid transparent;
        border-color: transparent;
        transition: all 0.1s ease-in-out;
        color: var(--text-color-secondary);
        display: flex;
        align-items: center;
    }

    /* Move label up when input is focused or has content */
    .form-control-custom:focus ~ label, 
    .form-control-custom.has-value ~ label,
    .form-select-custom:focus ~ label,
    .form-select-custom.has-value ~ label {
        transform: translateY(-50%) scale(0.85);
        top: 0;
        left: 0.5rem;
        padding: 0 0.5rem;
        background-color: var(--card-bg-color);
        color: var(--primary-color);
        height: auto;
        width: auto;
        border-radius: 4px;
        font-weight: 500;
        line-height: 1;
    }
    
    /* Job Description Source Toggle (Active State) */
    .btn-check:checked + .btn-outline-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
        box-shadow: 0 4px 10px rgba(62, 79, 71, 0.2);
    }
    .btn-outline-primary {
        border-color: var(--border-color);
        color: var(--primary-color);
        transition: all 0.3s ease;
    }

    /* Custom Primary Button */
    .btn-primary-custom {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        transition: background-color 0.2s, box-shadow 0.2s;
    }
    .btn-primary-custom:hover {
        background-color: var(--primary-light);
        border-color: var(--primary-light);
        box-shadow: 0 4px 10px rgba(62, 79, 71, 0.2);
    }
    .btn-lg {
        font-size: 1.15rem;
    }

    /* Preloader Enhancement */
    #preloader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95); /* Slightly darker overlay */
        display: none; /* Hidden by default */
        justify-content: center;
        align-items: center;
        flex-direction: column;
        z-index: 9999;
    }
    #preloader.show {
        display: flex;
    }
    .spinner {
        border: 8px solid rgba(0, 0, 0, 0.1);
        border-top: 8px solid var(--primary-color); /* Use primary color */
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1.2s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .preloader-progress {
        width: 300px;
        max-width: 80%;
        height: 8px;
        background-color: #e9ecef;
        border-radius: 4px;
        margin: 20px 0 10px;
        overflow: hidden;
    }
    .progress-bar {
        height: 100%;
        width: 0%;
        background-color: var(--success-color);
        transition: width 0.4s ease-in-out;
        border-radius: 4px;
    }
    .preloader-text {
        color: var(--text-color-primary);
        font-weight: 500;
    }

    /* --- New CSS for Detailed Status --- */
    .preloader-steps-container {
        width: 90%;
        max-width: 600px;
        margin-top: 30px;
        text-align: left;
    }
    .file-status-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 15px;
        margin-bottom: 8px;
        border-radius: 6px;
        background-color: var(--card-bg-color);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        border-left: 5px solid var(--border-color); /* Neutral state */
    }
    .file-status-item.pending {
        border-left-color: var(--secondary-color);
    }
    .file-status-item.processing {
        border-left-color: var(--warning-color);
        box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);
    }
    .file-status-item.completed {
        border-left-color: var(--success-color);
    }
    .file-status-item.error {
        border-left-color: var(--danger-color);
    }
    .file-name {
        font-weight: 500;
        color: var(--text-color-primary);
        flex-grow: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        padding-right: 15px;
    }
    .status-badge {
        font-size: 0.8rem;
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: 600;
    }
    .status-badge i {
        width: 15px; /* Fixed width for icon alignment */
    }
    .spinner-sm {
        width: 1rem;
        height: 1rem;
        margin-right: 5px;
    }
    /* Ensure the spinner is visible in the status badge */
    .status-badge.bg-warning {
        color: var(--text-color-primary) !important;
    }
    
</style>

<div class="card mb-4 shadow-sm" style="">

    <div class="card-body">
        <div class="row g-3">
            <div class="col-4" >
                <div class=" p-4 text-center h-70" 
                     data-mode="advanced_ai" id="advanced-ai-btn">
                    <strong class="form-text text-muted mt-6 d-block text-center" style="font-size: 25px;">
                        <i class="fas fa-microchip me-2 "></i>
                        <span style="color: orangered;">S</span>elect 
                        <span style="color: orangered;">A</span>nalysis
                        <span style="color: orangered;">M</span>ode
                    </strong>
                    <small class="form-text text-muted mt-3 d-block text-center">
            Pick an option to continue: <strong>Basic ATS</strong> for speed, 
            or <strong>Advanced AI</strong> for detailed analysis.
        </small>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="option-card p-4 text-center border rounded-4 mode-btn" 
                     data-mode="basic_ats" id="basic-ats-btn">
                    <i class="fas fa-file-invoice fa-2x  mb-3"></i>
                    <h6 class="fw-bold mb-1">Basic ATS (Entry-Level Scan)</h6>
                    <p class="mb-1">
                        Fast, keyword-based resume screening
                    </p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="option-card p-4 text-center border rounded-4 mode-btn" 
                     data-mode="advanced_ai" id="advanced-ai-btn">
                    <i class="fas fa-brain fa-2x  mb-3"></i>
                    <h6 class="fw-bold mb-1">Advanced ATS (AI Model)</h6>
                    <p class="mb-1">
                        In-depth, LLM-powered smart analysis
                    </p>
                </div>
            </div>
        </div>
        
    </div>
</div>

<style>
    .option-card {
        cursor: pointer;
        transition: all 0.25s ease-in-out;
    }
    .option-card:hover {
        background: #f8f9fa;
        transform: translateY(-4px);
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
    }
    .option-card.active {
        /* border: 2px solid #3e4f47; */
        background: #e9f2ff;
        box-shadow: 0 8px 20px rgba(13,110,253,0.2);
    }
</style>


    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="content-section-card h-100">
                <h2 class="section-title mb-1">Resume & Job Analysis</h2>
                <p class="section-description mb-4">
                    Follow these steps to upload candidate details and get a comprehensive AI analysis.
                </p>

                <form method="post" enctype="multipart/form-data" id="resumeForm" novalidate>
                    {% csrf_token %}
                    
                    <input type="hidden" id="analysis_mode" name="analysis_mode" value="{{ analysis_mode|default:'advanced_ai' }}">
                    

                    <ul class="nav nav-pills nav-fill mb-4" id="formStepsTab" role="tablist">
                        <li class="nav-item" role="presentation" >
                            <button class="nav-link active" id="step1-tab" data-bs-toggle="pill" data-bs-target="#step1" type="button" role="tab" aria-controls="step1" aria-selected="true">
                                <i class="fas fa-1 me-2"></i> Resume(s)
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="step2-tab" data-bs-toggle="pill" data-bs-target="#step2" type="button" role="tab" aria-controls="step2" aria-selected="false" disabled>
                                <i class="fas fa-2 me-2"></i> Job Details
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="formStepsTabContent">
                        <div class="tab-pane fade show active" id="step1" role="tabpanel" aria-labelledby="step1-tab">
                            <h5 class="section-sub-title mb-3"><i class="fas fa-file-pdf me-2"></i> Upload Candidate Resume(s)</h5>
                            <div class="file-input-wrapper file-input-lg">
                                <input type="file" id="resumeInput" name="{{ form.resume_pdf.name }}" accept="application/pdf" multiple required>
                                <div class="btn-file-upload">
                                    <i class="fas fa-cloud-upload-alt fa-3x"></i>
                                    <span id="resumeFileName" class="ms-3">Click to upload 1-5 PDF resumes</span>
                                </div>
                                <div class="error-message mt-2" id="pdfErrorMessage" style="display: none;"></div>
                            </div>
                            <div class="d-flex justify-content-end mt-4">
                                <button class="btn btn-secondary" type="button" id="nextStepBtn">
                                    Next Step <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="step2" role="tabpanel" aria-labelledby="step2-tab">
                            <h5 class="section-sub-title mb-3"><i class="fas fa-briefcase me-2"></i> Job Requirements</h5>

                            <div class="mb-4">
                                <label class="form-label">Job Description Source</label>
                                <div class="btn-group w-100" role="group" aria-label="Job Description Source">
                                    <input type="radio" class="btn-check" name="jdSource" id="selectJdRadio" value="select" autocomplete="off" checked>
                                    <label class="btn btn-outline-primary" for="selectJdRadio">Select Existing (Single)</label>
                                    <input type="radio" class="btn-check" name="jdSource" id="uploadJdRadio" value="upload" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="uploadJdRadio">Upload New (Single)</label>
                                </div>
                            </div>
                            <div id="jdSourceFields">
                                <div id="selectJdSection">
                                    <div class="form-group-floating mb-4">
                                        <select class="form-select-custom" id="jobDescriptionSelect" name="job_description_id">
                                            <option value="">-- Select an Existing Job Description --</option>
                                            {% for doc in job_description_documents %}
                                            <option value="{{ doc.id }}">{{ doc.title }}</option>
                                            {% endfor %}
                                        </select>
                                        </div>
                                </div>
                                <div id="uploadJdSection" style="display: none;">
                                    <div class="file-input-wrapper mb-4">
                                        <input type="file" id="jobDescriptionInput" name="{{ form.job_description.name }}" accept=".pdf,.doc,.docx,.txt">
                                        <div class="btn-file-upload">
                                            <i class="fas fa-file-word fa-2x"></i>
                                            <span id="jobDescriptionFileName" class="ms-3">No file chosen</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group-floating mb-4">
                                <input type="text" class="form-control-custom" id="{{ form.job_role.id_for_label }}" name="{{ form.job_role.name }}" value="{{ form.job_role.value|default:'' }}" required>
                                <label for="{{ form.job_role.id_for_label }}">
                                    <i class="fas fa-tag me-2"></i> Please Enter Job Role
                                </label>
                            </div>

                            <div class="form-group-floating mb-4">
                                <select class="form-select-custom" id="{{ form.target_experience_type.id_for_label }}" name="{{ form.target_experience_type.name }}" required>
                                    {% for value, label in form.target_experience_type.field.choices %}
                                    <option value="{{ value }}" {% if form.target_experience_type.value == value %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                                <label for="{{ form.target_experience_type.id_for_label }}">
                                    <i class="fas fa-chart-line me-2"></i> Experience Level
                                </label>
                            </div>

                            <div id="experience_fields" class="row g-3 px-3 w-100 mt-2" style="display: none;">
                                <div class="col-sm-6">
                                    <div class="form-group-floating">
                                        <input type="number" class="form-control-custom" id="{{ form.min_years_required.id_for_label }}" name="{{ form.min_years_required.name }}" value="{{ form.min_years_required.value|default:'' }}" min="0" step="1" disabled>
                                        <label for="{{ form.min_years_required.id_for_label }}">
                                            <i class="fas fa-sort-numeric-up me-2"></i> Min. Years
                                        </label>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="form-group-floating">
                                        <input type="number" class="form-control-custom" id="{{ form.max_years_required.id_for_label }}" name="{{ form.max_years_required.name }}" value="{{ form.max_years_required.value|default:'' }}" min="0" step="1" disabled>
                                        <label for="{{ form.max_years_required.id_for_label }}">
                                            <i class="fas fa-sort-numeric-down me-2"></i> Max. Years
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between mt-4">
                                <button class="btn btn-secondary" type="button" id="backStepBtn">
                                    <i class="fas fa-arrow-left me-2"></i> Back
                                </button>
                                <button type="submit" class="btn btn-secondary">
                                    <i class="fas fa-magic me-2"></i> Advance ATS
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="col">
            <div class="content-section-card pdf-preview-section h-100">
                <ul class="nav nav-pills nav-fill mb-3" id="filePills" role="tablist" style="display: none;">
                    </ul>
                
                <embed id="pdfEmbed" class="pdf-embed" type="application/pdf"
                       style="display: {% if all_resume_previews %}block{% else %}none{% endif %};"
                       {% if all_resume_previews %}src="{{ all_resume_previews.0.url }}#toolbar=0&navpanes=0"{% endif %}>

                <div class="pdf-placeholder" id="pdfPlaceholder"
                     style="display: {% if all_resume_previews %}none{% else %}flex{% endif %}; margin-top:-50px;">
                    <i class="fas fa-file-pdf fa-4x mb-3"></i>
                    <p class="message" id="pdfPlaceholderMessage">
                        {% if all_analysis_results %}{{ all_analysis_results|length }} Resumes Analysed{% else %}Upload one or more PDF Resumes{% endif %}
                    </p>
                    <p class="sub-message">The AI analysis will begin shortly after.</p>
                    <p class="error-message" id="pdfErrorMessage" style="display: none;"></p>
                </div>
            </div>
        </div>
    </div>

    {% if all_analysis_results %}
        <div class="content-section-card results-section show" data-analysis-loaded="true">
            <h2 class="section-title">AI Analysis for <span class="text-primary">{{ all_analysis_results|length }} Candidate(s)</span></h2>
            
            <ul class="nav nav-tabs mb-4" id="candidateTabs" role="tablist">
                {% for analysis_result in all_analysis_results %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if forloop.first %}active{% endif %}" 
                            id="candidate-{{ forloop.counter }}-tab" 
                            data-bs-toggle="tab" 
                            data-bs-target="#candidate-{{ forloop.counter }}" 
                            type="button" 
                            role="tab" 
                            aria-controls="candidate-{{ forloop.counter }}" 
                            aria-selected="{% if forloop.first %}true{% else %}false{% endif %}"
                            
                            data-pdf-url="{% with preview=all_resume_previews|slice:forloop.counter0|first %}{% if preview %}{{ preview.url }}#toolbar=0&navpanes=0{% endif %}{% endwith %}"
                            data-candidate-name="{{ analysis_result.full_name|default:'Candidate '|add:forloop.counter }}">
                        <i class="fas fa-user me-2"></i> 
                        {{ analysis_result.full_name|default:forloop.counter }}
                    </button>
                </li>
                {% endfor %}
            </ul>
            <div class="tab-content" id="allCandidateAnalysisContent">
                
                {% for analysis_result in all_analysis_results %}
                <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" 
                     id="candidate-{{ forloop.counter }}" 
                     role="tabpanel" 
                     aria-labelledby="candidate-{{ forloop.counter }}-tab">
                    
                    <ul class="nav nav-tabs" id="analysisTabs-{{ forloop.counter }}" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="summary-tab-{{ forloop.counter }}" data-bs-toggle="tab" data-bs-target="#summary-{{ forloop.counter }}" type="button" role="tab" aria-controls="summary-{{ forloop.counter }}" aria-selected="true">
                                <i class="fas fa-chart-pie me-2"></i> Summary
                            </button>
                        </li>
                        
                        {% if analysis_result.mode != 'basic_ats'  or analysis_mode != 'basic_ats'%}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="contact-tab-{{ forloop.counter }}" data-bs-toggle="tab" data-bs-target="#contact-{{ forloop.counter }}" type="button" role="tab" aria-controls="contact-{{ forloop.counter }}" aria-selected="false">
                                <i class="fas fa-address-book me-2"></i> Contact Info
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="details-tab-{{ forloop.counter }}" data-bs-toggle="tab" data-bs-target="#details-{{ forloop.counter }}" type="button" role="tab" aria-controls="details-{{ forloop.counter }}" aria-selected="false">
                                <i class="fas fa-info-circle me-2"></i> Detailed Analysis
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="skills-projects-tab-{{ forloop.counter }}" data-bs-toggle="tab" data-bs-target="#skills-projects-{{ forloop.counter }}" type="button" role="tab" aria-controls="skills-projects-{{ forloop.counter }}" aria-selected="false">
                                <i class="fas fa-code me-2"></i> Skills & Projects
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="recommendations-tab-{{ forloop.counter }}" data-bs-toggle="tab" data-bs-target="#recommendations-{{ forloop.counter }}" type="button" role="tab" aria-controls="recommendations-{{ forloop.counter }}" aria-selected="false">
                                <i class="fas fa-lightbulb me-2"></i> Recommendations
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="questions-tab-{{ forloop.counter }}" data-bs-toggle="tab" data-bs-target="#questions-{{ forloop.counter }}" type="button" role="tab" aria-controls="questions-{{ forloop.counter }}" aria-selected="false">
                                <i class="fas fa-question-circle me-2"></i> Interview Questions
                            </button>
                        </li>
                        {% endif %}
                        </ul>
                        <div class="tab-content" id="analysisTabContent-{{ forloop.counter }}">
                            <div class="tab-pane fade show active" id="summary-{{ forloop.counter }}" role="tabpanel" aria-labelledby="summary-tab-{{ forloop.counter }}">
                                <div class="row g-4 mb-4">
                                    <div class="col-md-3 col-sm-6">
                                        <div class="summary-tile fade-in-item">
                                            <h6><i class="fas fa-briefcase me-2"></i> Job Role</h6>
                                            <p>{{ form.job_role.value|default:"N/A" }}</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-sm-6">
                                        <div class="summary-tile fade-in-item">
                                            <h6><i class="fas fa-chart-line me-2"></i> Overall Experience</h6>
                                            <p>{{ analysis_result.overall_experience|default:"N/A" }}</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-sm-6">
                                        <div class="summary-tile fade-in-item">
                                            <h6><i class="fas fa-thumbs-up me-2"></i> Hiring Recommendation</h6>
                                            <p class="
                                                {% if analysis_result.hiring_recommendation == 'Hire' or analysis_result.hiring_recommendation == 'Strong Hire' %}text-success
                                                {% elif analysis_result.hiring_recommendation == 'Reject' %}text-danger
                                                {% else %}text-warning{% endif %}">
                                                {{ analysis_result.hiring_recommendation|default:"N/A" }}
                                            </p>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-sm-6">
                                        <div class="summary-tile fade-in-item">
                                            <h6><i class="fas fa-percentage me-2"></i> Experience Match</h6>
                                            <p class="text-success">{{ analysis_result.experience_match|default:"N/A" }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="row g-4 mb-4">
                                    <div class="col-md-6">
                                        <div class="fitment-verdict-box shadow-sm rounded-4 p-4 fade-in-item bg-white">
                                            <h5 class="text-primary fw-bold d-flex align-items-center mb-3">
                                                <i class="fas fa-shield-alt me-2 text-primary"></i> Candidate Fitment Verdict
                                            </h5>

                                            <div class="text-center">
                                                <span class="badge verdict-badge px-4 py-2 fs-6
                                                    {% if analysis_result.fitment_verdict == 'SELECTED' %} bg-success text-white
                                                    {% elif analysis_result.fitment_verdict == 'MARGINALLY FIT' %} bg-warning text-dark
                                                    {% else %} bg-danger text-white
                                                    {% endif %}">
                                                    {{ analysis_result.fitment_verdict|default:"N/A" }}
                                                </span>
                                            </div>

                                            <p class="mt-3 text-muted small text-center">
                                                This verdict is based on AI-powered candidate evaluation.
                                            </p>
                                        </div>
                                    </div>

                                    <style>
                                        .fitment-verdict-box {
                                            transition: all 0.3s ease-in-out;
                                        }
                                        .fitment-verdict-box:hover {
                                            transform: translateY(-3px);
                                            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.08);
                                        }
                                        .verdict-badge {
                                            border-radius: 30px;
                                            font-weight: 700;
                                            letter-spacing: 0.5px;
                                            text-transform: uppercase;
                                        }
                                    </style>

                                    <div class="col-md-6">
                                        <div class="content-box fade-in-item">
                                            <h6><i class="fas fa-sitemap me-2"></i> Strategic Alignment</h6>
                                            <p>{% if analysis_result.mode == 'advanced_ai' %}{{ analysis_result.candidate_fitment_analysis.strategic_alignment|default:"N/A" }}{% else %}{{ analysis_result.strategic_alignment|default:"N/A" }}{% endif %}</p>
                                        </div>
                                    </div>
                                </div>

                                {% if analysis_result.mode == 'basic_ats' or analysis_mode == 'basic_ats' %}
                                    <h4 class="section-title mt-5">Basic ATS Report & Contact Details</h4>
                                    <div class="row g-4 mb-4">
                                        <div class="col-md-4 col-sm-6">
                                            <div class="summary-tile fade-in-item">
                                                <h6><i class="fas fa-user me-2"></i> Full Name</h6>
                                                <p>{{ analysis_result.full_name|default:"N/A" }}</p>
                                            </div>
                                        </div>
                                        <div class="col-md-4 col-sm-6">
                                            <div class="summary-tile fade-in-item">
                                                <h6><i class="fas fa-envelope me-2"></i> Email Address</h6>
                                                <p>{{ analysis_result.email|default:"N/A" }}</p>
                                            </div>
                                        </div>
                                        <div class="col-md-4 col-sm-6">
                                            <div class="summary-tile fade-in-item">
                                                <h6><i class="fas fa-phone me-2"></i> Contact Number</h6>
                                                <p>{{ analysis_result.contact_number|default:"N/A" }}</p>
                                            </div>
                                        </div>
                                        <div class="col-md-4 col-sm-6">
                                            <div class="summary-tile fade-in-item">
                                                <h6><i class="fas fa-percentage me-2"></i> Aggregate Score</h6>
                                                <p class="text-info">{{ analysis_result.aggregate_score|default:"N/A" }}%</p>
                                            </div>
                                        </div>
                                        <div class="col-md-8 col-sm-6">
                                            <div class="summary-tile fade-in-item">
                                                <h6><i class="fas fa-tags me-2"></i> Analysis Summary</h6>

                                                {% if analysis_result.semantic_score or analysis_result.keyword_score or analysis_result.final_scaled_score %}
                                                    <p class="text-break mb-1">
                                                        <strong>Semantic Score:</strong> &nbsp; <span style="color: orangered;">{{ analysis_result.semantic_score }}</span>
                                                    <strong>Keyword Score:</strong> &nbsp; <span style="color: orangered;">{{ analysis_result.keyword_score }}</span>
                                                    <strong>Final Scaled Score:</strong> &nbsp; <span style="color: orangered;">{{ analysis_result.final_scaled_score }}</span>
                                                    </p>
                                                {% else %}
                                                    <p>No detailed summary provided by Basic ATS. Check log data for raw output.</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>

                                    <h5 class="section-sub-title mt-4"><i class="fas fa-file-alt me-2"></i> Candidate Overview</h5>
                                    <div class="content-box fade-in-item mb-4">
                                        <p class="text-break" style="font-size: 17px;">{{ analysis_result.candidate_overview|linebreaksbr }}</p>
                                        </div>
                                {% endif %}
                            {% if analysis_result.mode != 'basic_ats' or analysis_mode != 'basic_ats' %}
                            <h4 class="section-title mt-5">Core Competency Assessment</h4>
                            <div class="row g-4 mb-4">
                                {% if analysis_result.core_competencies_assessment %}
                                    {% for competency in analysis_result.core_competencies_assessment %}
                                        <div class="col-md-3 col-sm-6">
                                            <div class="summary-tile fade-in-item">
                                                <h6><i class="fas fa-star me-2"></i> {{ competency.competency|default:"N/A" }}</h6>
                                                <p class="
                                                    {% if competency.level == 'Excellent' or competency.level == 'Advanced' %}text-success
                                                    {% elif competency.level == 'Proficient' %}text-primary
                                                    {% elif competency.level == 'Intermediate' %}text-warning
                                                    {% else %}text-muted{% endif %}
                                                ">
                                                    {{ competency.level|default:"N/A" }}
                                                </p>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="col-12">
                                        <div class="content-box text-center text-muted fade-in-item">
                                            <p>No core competency assessment data available.</p>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                            {% endif %}
                            </div>

                        {% if analysis_result.mode != 'basic_ats' or analysis_mode != 'basic_ats' %}
                        
                        <div class="tab-pane fade" id="contact-{{ forloop.counter }}" role="tabpanel" aria-labelledby="contact-tab-{{ forloop.counter }}">
                            <h4 class="section-title">Candidate Contact Information</h4>
                            <div class="row g-4 mb-4">
                                <div class="col-md-4 col-sm-6">
                                    <div class="summary-tile fade-in-item">
                                        <h6><i class="fas fa-user me-2"></i> Full Name</h6>
                                        <p>{{ analysis_result.full_name|default:"N/A" }}</p>
                                    </div>
                                </div>
                                <div class="col-md-4 col-sm-6">
                                    <div class="summary-tile fade-in-item">
                                        <h6><i class="fas fa-phone me-2"></i> Phone Number</h6>
                                        <p>{{ analysis_result.phone_no|default:"N/A" }}</p>
                                    </div>
                                </div>
                                <div class="col-md-4 col-sm-6">
                                    <div class="summary-tile fade-in-item">
                                        <h6><i class="fas fa-envelope me-2"></i> Email Address</h6>
                                        <p>{{ analysis_result.email|default:"N/A" }}</p>
                                    </div>
                                </div>
                                <div class="col-md-4 col-sm-6">
                                    <div class="summary-tile fade-in-item">
                                        <h6><i class="fab fa-linkedin me-2"></i> LinkedIn Profile</h6>
                                        {% if analysis_result.linkedin_url %}
                                            <p><a href="{{ analysis_result.linkedin_url }}" target="_blank" class="text-primary">{{ analysis_result.linkedin_url|truncatechars:30 }}</a></p>
                                        {% else %}
                                            <p>N/A</p>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4 col-sm-6">
                                    <div class="summary-tile fade-in-item">
                                        <h6><i class="fab fa-github me-2"></i> GitHub Profile</h6>
                                        {% if analysis_result.github_url %}
                                            <p><a href="{{ analysis_result.github_url }}" target="_blank" class="text-primary">{{ analysis_result.github_url|truncatechars:30 }}</a></p>
                                        {% else %}
                                            <p>N/A</p>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4 col-sm-6">
                                    <div class="summary-tile fade-in-item">
                                        <h6><i class="fas fa-map-marker-alt me-2"></i> Current Company Address</h6>
                                        <p>{{ analysis_result.current_company_address|default:"N/A" }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="details-{{ forloop.counter }}" role="tabpanel" aria-labelledby="details-tab-{{ forloop.counter }}">
                            <h4 class="section-title">Deep-Dive Scoring Matrix</h4>
                            <div class="table-responsive fade-in-item">
                                <table class="table table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>Evaluation Dimension</th>
                                            <th>Weight</th>
                                            <th>Score</th>
                                            <th>Evidence-Based Justification</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in analysis_result.scoring_matrix %}
                                            <tr>
                                                <td class="fw-bold">{{ item.dimension|default:"N/A" }}</td>
                                                <td>{{ item.weight|default:"N/A" }}</td>
                                                <td>{{ item.score|default:"N/A" }}</td>
                                                <td>{{ item.justification|default:"N/A" }}</td>
                                            </tr>
                                        {% empty %}
                                            <tr>
                                                <td colspan="4" class="text-center text-muted">No scoring matrix data available.</td>
                                            </tr>
                                        {% endfor %}
                                        <tr>
                                            <td class="fw-bold">âž¤ Aggregate Score</td>
                                            <td>100%</td>
                                            <td class="fw-bold">{{ analysis_result.aggregate_score|default:"N/A" }}</td>
                                            <td></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <h4 class="section-title mt-5">Detailed Analysis Summary</h4>
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="content-box fade-in-item">
                                        <h6><i class="fas fa-user-circle me-2 text-primary"></i> Candidate Overview</h6>
                                        <p>{{ analysis_result.analysis_summary.candidate_overview|default:"No candidate overview provided." }}</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                            <div class="content-box fade-in-item">
                                <h6><i class="fas fa-chart-line me-2 text-success"></i> Quantifiable Impact</h6>
                                <p>{{ analysis_result.candidate_fitment_analysis.quantifiable_impact|default:"N/A" }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="content-box fade-in-item">
                                <h6><i class="fas fa-exclamation-triangle me-2 text-danger"></i> Potential Gaps & Risks</h6>
                                <p>{{ analysis_result.candidate_fitment_analysis.potential_gaps_risks|default:"N/A" }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="content-box fade-in-item">
                                <h6><i class="fas fa-briefcase me-2 text-info"></i> Comparable Experience</h6>
                                <p>{{ analysis_result.candidate_fitment_analysis.comparable_experience_analysis|default:"N/A" }}</p>
                            </div>
                        </div>
                                <div class="col-12">
                                    <div class="content-box fade-in-item">
                                        <h6><i class="fas fa-check-circle me-2 text-secondary"></i> Conclusion</h6>
                                        <p>{{ analysis_result.analysis_summary.conclusion|default:"No conclusion provided." }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="skills-projects-{{ forloop.counter }}" role="tabpanel" aria-labelledby="skills-projects-tab-{{ forloop.counter }}">
                            <h4 class="section-title">Technical Skills & Education</h4>
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="content-box fade-in-item">
                                        <h6><i class="fas fa-laptop-code me-2 text-primary"></i> Technical Prowess</h6>
                                        <ul>
                                            {% for skill_category, skills in analysis_result.analysis_summary.technical_prowess.items %}
                                                <li><strong>{{ skill_category }}:</strong> {{ skills|join:", " }}</li>
                                            {% empty %}
                                                <li>No technical skills identified.</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="content-box fade-in-item">
                                        <h6><i class="fas fa-graduation-cap me-2 text-primary"></i> Education & Certifications</h6>
                                        <ul>
                                            {% for edu in analysis_result.analysis_summary.education_certifications.education %}
                                                <li>{{ edu }}</li>
                                            {% empty %}
                                                <li>No education details provided.</li>
                                            {% endfor %}
                                            {% for cert in analysis_result.analysis_summary.education_certifications.certifications %}
                                                <li>{{ cert }}</li>
                                            {% empty %}
                                                <li>No certifications provided.</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <h4 class="section-title mt-5">Project Impact & Achievements</h4>
                            <div class="row g-4">
                                {% for project in analysis_result.analysis_summary.project_impact %}
                                    <div class="col-12">
                                        <div class="content-box fade-in-item">
                                            <h6><i class="fas fa-project-diagram me-2 text-warning"></i> {{ project.title|default:"Project Title N/A" }}</h6>
                                            <p><strong>Company:</strong> {{ project.company|default:"N/A" }}</p>
                                            <p><strong>Role:</strong> {{ project.role|default:"N/A" }}</p>
                                            <p><strong>Achievements:</strong></p>
                                            <ul>
                                                {% for achievement in project.achievements %}
                                                    <li>{{ achievement }}</li>
                                                {% empty %}
                                                    <li>No specific achievements listed.</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                {% empty %}
                                    <div class="col-12">
                                        <div class="content-box text-muted fade-in-item">
                                            <p>No project impact or achievements found.</p>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="tab-pane fade" id="recommendations-{{ forloop.counter }}" role="tabpanel" aria-labelledby="recommendations-tab-{{ forloop.counter }}">
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="content-box fade-in-item">
                                        <h6><i class="fas fa-tasks me-2 text-primary"></i> Bench & Alternative Roles</h6>
                                        <p><strong>Retain for future consideration?</strong> {{ analysis_result.bench_recommendation.retain|default:"N/A" }}</p>
                                        <p><strong>Ideal Future Role(s):</strong> {{ analysis_result.bench_recommendation.ideal_future_roles|join:", "|default:"N/A" }}</p>
                                        <p><strong>Justification:</strong> {{ analysis_result.bench_recommendation.justification|default:"N/A" }}</p>
                                        <h6 class="mt-4"><i class="fas fa-exchange-alt me-2 text-info"></i> Alternative Role Recommendations</h6>
                                        <ul>
                                            {% for role in analysis_result.alternative_role_recommendations %}
                                                <li><strong>{{ role.role|default:"N/A" }}:</strong> {{ role.explanation|default:"N/A" }}</li>
                                            {% empty %}
                                                <li>No alternative roles suggested.</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="content-box fade-in-item">
                                        <h6><i class="fas fa-lightbulb me-2 text-warning"></i> Automated Recruiter Insights</h6>
                                        <p><strong>Red Flag Detection:</strong> {{ analysis_result.automated_recruiter_insights.red_flag_detection|default:"None" }}</p>
                                        <p><strong>Growth Indicators:</strong> {{ analysis_result.automated_recruiter_insights.growth_indicators|default:"None" }}</p>
                                        <p><strong>Cross-Industry Potential:</strong> {{ analysis_result.automated_recruiter_insights.cross_industry_potential|default:"None" }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="questions-{{ forloop.counter }}" role="tabpanel" aria-labelledby="questions-tab-{{ forloop.counter }}">
                            <h4 class="section-title">Suggested Interview Questions for <span class="text-primary">{{ analysis_result.full_name|default:"the Candidate" }}</span></h4>
                            <ul class="questions-list">
                                {% for question in analysis_result.interview_questions %}
                                    <li class="fade-in-item">{{ question }}</li>
                                {% empty %}
                                    <li class="text-muted fade-in-item">No specific questions were generated.</li>
                                {% endfor %}
                            </ul>
                            <div class="d-flex justify-content-end mt-4 pt-3 border-top fade-in-item">
                                </div>
                        </div>
                        
                        {% endif %}
                        </div>
                </div>
                {% endfor %}
                </div>
            
        </div>
    {% endif %}
    <div class="content-section-card" style="margin-top: 20px;">
        <h4 class="text-center mb-4"><i class="fas fa-gem me-2"></i> Choose Your ATS Plan & Mode</h4>
        <div class="row g-4 justify-content-center">
            
            <div class="col-md-6 position-relative">
                <div class="plan-block basic-plan">
                    <span class="current-badge">YOUR CURRENT PLAN</span>
                    <h5 class="text-success mt-2">Basic ATS</h5>
                    <p class="text-muted small">Keyword Matching & Unlimited Usage</p>
                    <ul class="feature-list list-unstyled text-start mx-auto" style="max-width: 500px;">
                        <li><i class="fas fa-check-circle feature-check me-2"></i> **Daily Process Limit:** No Limitation</li>
                        <li><i class="fas fa-check-circle feature-check me-2"></i> **Batch Upload:** Multiple Resumes Allowed</li>
                        <li><i class="fas fa-times-circle text-danger me-2"></i> **AI Insight:** Basic (Non-LLM)</li>
                    </ul>
                    <button type="button" class="btn btn-success btn-sm w-75 mt-3 mode-btn active" data-mode="basic_ats" id="basic-ats-btn1">
                        <i class="fas fa-check me-2"></i> Use Basic ATS Mode
                    </button>
                </div>
            </div>

            <div class="col-md-6 position-relative">
                <div class="plan-block advanced-plan upgrade-needed">
                    <h5 class="text-danger">Advanced ATS</h5>
                    <p class="text-muted small">LLM-Driven Deep Analysis</p>
                    <ul class="feature-list list-unstyled text-start mx-auto" style="max-width: 500px;">
                        <li><i class="fas fa-times-circle feature-limit me-2"></i> **Daily Limit:** Only **5 processes** per day</li>
                        <li><i class="fas fa-times-circle feature-limit me-2"></i> **Batch Upload:** Max **5 resumes** per upload</li>
                        <li><i class="fas fa-check-circle text-primary me-2"></i> **AI Insight:** Advanced (LLM-Driven)</li>
                    </ul>
                    <button type="button" class="btn btn-outline-danger btn-sm w-75 mt-3 mode-btn" data-mode="advanced_ai" id="advanced-ai-btn1">
                        <i class="fas fa-arrow-up me-2"></i> Upgrade to Unlock
                    </button>
                </div>
            </div>
        </div>
        <input type="hidden" id="analysis_mode" name="analysis_mode" value="{{ analysis_mode|default:'basic_ats' }}">
    </div>
    </div>

<div id="preloader">
    <div class="spinner"></div>
    <div class="preloader-progress">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    <p class="preloader-text" id="preloaderMessage">Preparing to process...</p>

    <div class="preloader-steps-container">
        <h5 class="text-center text-muted mb-3" style="font-size: 1rem;">Individual Resume Status:</h5>
        <div id="fileStatusList">
            </div>
    </div>
    </div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const nextStepBtn = document.getElementById('nextStepBtn');
        const backStepBtn = document.getElementById('backStepBtn');
        const step1Tab = document.getElementById('step1-tab');
        const step2Tab = document.getElementById('step2-tab');
        
        // --- NEW MODE SELECTOR LOGIC START ---
        const modeInput = document.getElementById('analysis_mode');
        const modeButtons = document.querySelectorAll('.mode-btn');
        const submitBtn = document.querySelector('button[type="submit"]');

        function updateButtonStyles(activeMode) {
            modeButtons.forEach(button => {
                const buttonMode = button.getAttribute('data-mode');
                
                // Remove all mode-related styling classes first
                button.classList.remove('active', 'btn-success', 'btn-secondary', 'btn-outline-secondary');

                if (buttonMode === activeMode) {
                    // Set active style
                    button.classList.add('active');
                    // Add a default Bootstrap class for styling convenience, though CSS handles the final look
                    if (buttonMode === 'advanced_ai') {
                        button.classList.add('btn-success'); 
                    } else {
                        button.classList.add('btn-secondary');
                    }
                } else {
                    // Set inactive style
                    button.classList.add('btn-outline-secondary');
                }
            });

            // Update submit button text and style based on mode
            if (submitBtn) {
                submitBtn.classList.remove('btn-primary-custom', 'btn-secondary', 'btn-primary'); // Clear old classes
                if (activeMode === 'advanced_ai') {
                    submitBtn.innerHTML = '<i class="fas fa-magic me-2"></i> Advance ATS';
                    submitBtn.classList.add('btn-secondary'); // Use the custom prominent style
                } else {
                    submitBtn.innerHTML = '<i class="fas fa-file-invoice me-2"></i> Basic ATS';
                    submitBtn.classList.add('btn-secondary'); // Use a standard secondary style for less emphasis
                }
            }
        }

        modeButtons.forEach(button => {
            button.addEventListener('click', function() {
                const selectedMode = this.getAttribute('data-mode');
                // 1. Update hidden input value (Crucial for the POST request)
                if (modeInput) {
                    modeInput.value = selectedMode;
                }
                
                // 2. Update button styles and submit button
                updateButtonStyles(selectedMode);
            });
        });

        // Initialize button state based on the hidden input's current value (from context)
        if (modeInput) {
            updateButtonStyles(modeInput.value);
        }
        // --- NEW MODE SELECTOR LOGIC END ---


        if (nextStepBtn) {
            nextStepBtn.addEventListener('click', function() {
                const step2TabInstance = new bootstrap.Tab(step2Tab);
                step2Tab.removeAttribute('disabled'); // Enable step 2
                step2TabInstance.show();
            });
        }
        
        if (backStepBtn) {
            backStepBtn.addEventListener('click', function() {
                const step1TabInstance = new bootstrap.Tab(step1Tab);
                step1TabInstance.show();
            });
        }

        const selectJdRadio = document.getElementById('selectJdRadio');
        const uploadJdRadio = document.getElementById('uploadJdRadio');
        const selectJdSection = document.getElementById('selectJdSection');
        const uploadJdSection = document.getElementById('uploadJdSection');
        const jobDescriptionSelect = document.getElementById('jobDescriptionSelect');
        const jobDescriptionInput = document.getElementById('jobDescriptionInput');
        
        function toggleJdSourceSection() {
            if (selectJdRadio.checked) {
                selectJdSection.style.display = 'block';
                uploadJdSection.style.display = 'none';
                jobDescriptionSelect.setAttribute('required', 'required');
                jobDescriptionInput.removeAttribute('required');
            } else {
                selectJdSection.style.display = 'none';
                uploadJdSection.style.display = 'block';
                jobDescriptionInput.setAttribute('required', 'required');
                jobDescriptionSelect.removeAttribute('required');
            }
        }
        
        if (selectJdRadio && uploadJdRadio) {
            selectJdRadio.addEventListener('change', toggleJdSourceSection);
            uploadJdRadio.addEventListener('change', toggleJdSourceSection);
            toggleJdSourceSection();
        }

        const resumeFileInput = document.getElementById('resumeInput');
        const resumeFileNameSpan = document.getElementById('resumeFileName');
        const jobDescriptionFileInput = document.getElementById('jobDescriptionInput');
        const jobDescriptionFileNameSpan = document.getElementById('jobDescriptionFileName');
        const pdfEmbed = document.getElementById('pdfEmbed');
        const pdfPlaceholder = document.getElementById('pdfPlaceholder');
        const pdfErrorMessage = document.getElementById('pdfErrorMessage');
        const pdfPlaceholderMessage = document.getElementById('pdfPlaceholderMessage');
        const filePills = document.getElementById('filePills'); // NEW: Get the pill container
        const MAX_TOTAL_FILE_SIZE_MB = 50; 
        const MAX_FILE_SIZE_MB = 10; // Individual file size limit
        const MAX_RESUMES = 5; // *** NEW LIMIT: Maximum 5 resumes ***
        
        // Initial check for PDF preview
        const hasPreviews = {{ all_resume_previews|length|default:0 }} > 0;
        if (pdfEmbed && pdfEmbed.src && pdfEmbed.src !== window.location.href + '#toolbar=0&navpanes=0' && hasPreviews) {
            pdfEmbed.style.display = 'block';
            if (pdfPlaceholder) pdfPlaceholder.style.display = 'none';
        } else {
            if (pdfEmbed) pdfEmbed.style.display = 'none';
            if (pdfPlaceholder) pdfPlaceholder.style.display = 'flex';
        }

        if (resumeFileInput) {
            resumeFileInput.addEventListener('change', function () {
                const files = Array.from(this.files); // Convert FileList to Array
                pdfErrorMessage.style.display = 'none';
                filePills.innerHTML = ''; // Clear previous pills
                filePills.style.display = 'none';
                
                let totalFileSize = 0;
                let validPdfFiles = [];
                let firstPdfUrl = null;
                const errors = [];
                
                // *** NEW RESUME COUNT VALIDATION ***
                if (files.length > MAX_RESUMES) {
                    errors.push(`You can upload a maximum of ${MAX_RESUMES} resumes at once. You selected ${files.length}.`);
                    this.setCustomValidity(`Maximum ${MAX_RESUMES} files allowed.`);
                    resumeFileNameSpan.textContent = `Error: Too many files selected (Max ${MAX_RESUMES}).`;
                    pdfErrorMessage.textContent = errors.join(' | ');
                    pdfErrorMessage.style.display = 'block';
                    this.value = ''; // Clear the file list
                    
                    // Reset placeholder state
                    pdfEmbed.src = '';
                    pdfEmbed.style.display = 'none';
                    pdfPlaceholder.style.display = 'flex';
                    pdfPlaceholderMessage.textContent = "Upload one or more PDF Resumes";

                    return; // Stop processing further
                }

                // 1. Validate files and generate URLs
                files.forEach(file => {
                    const fileSizeMB = file.size / (1024 * 1024);
                    totalFileSize += file.size; // Track total size
                    
                    if (file.type !== 'application/pdf') {
                        errors.push(`'${file.name}' has an invalid file type. Only PDF files are supported.`);
                    } else if (fileSizeMB > MAX_FILE_SIZE_MB) {
                        errors.push(`'${file.name}' is too large (Max size: ${MAX_FILE_SIZE_MB} MB).`);
                    } else {
                        const fileURL = URL.createObjectURL(file);
                        validPdfFiles.push({ name: file.name, url: fileURL });
                        if (firstPdfUrl === null) {
                            firstPdfUrl = fileURL;
                        }
                    }
                });

                const totalFileSizeMB = totalFileSize / (1024 * 1024);
                if (totalFileSizeMB > MAX_TOTAL_FILE_SIZE_MB) {
                    errors.push(`Total size (${totalFileSizeMB.toFixed(2)} MB) exceeds limit (${MAX_TOTAL_FILE_SIZE_MB} MB).`);
                }


                // 2. Update File Name Span and input validity
                if (files.length > 0) {
                    if (errors.length > 0) {
                        resumeFileNameSpan.textContent = `Error(s) detected.`;
                        pdfErrorMessage.textContent = errors.join(' | ');
                        pdfErrorMessage.style.display = 'block';
                        this.setCustomValidity("Errors detected in uploaded files.");
                        
                        // Clear the input if file validation failed
                        if (validPdfFiles.length === 0 || totalFileSizeMB > MAX_TOTAL_FILE_SIZE_MB) {
                            this.value = ''; 
                            validPdfFiles = []; 
                        }
                    } else if (validPdfFiles.length > 0) {
                        resumeFileNameSpan.textContent = `${validPdfFiles.length} PDF(s) selected.`;
                        this.setCustomValidity(""); // Clear file input error
                    }
                } else {
                    // No files selected
                    resumeFileNameSpan.textContent = 'Click to upload 1-5 PDF resumes';
                    this.setCustomValidity("Please upload at least one resume.");
                }

                // 3. Update Preview Panel
                if (validPdfFiles.length > 0) {
                    pdfEmbed.style.display = 'block';
                    pdfPlaceholder.style.display = 'none';
                    pdfEmbed.src = firstPdfUrl + '#toolbar=0&navpanes=0'; // Set the first PDF as the initial preview
                    pdfPlaceholderMessage.textContent = `Previewing: ${validPdfFiles[0].name}`;
                    
                    if (validPdfFiles.length > 1) {
                        // Display pills for selection
                        filePills.style.display = 'flex';
                        validPdfFiles.forEach((file, index) => {
                            const isActive = index === 0;
                            const li = document.createElement('li');
                            li.className = 'nav-item';
                            li.role = 'presentation';
                            
                            li.innerHTML = `
                                <button class="nav-link ${isActive ? 'active' : ''}" type="button" 
                                        data-pdf-url="${file.url}#toolbar=0&navpanes=0"
                                        data-bs-toggle="pill">
                                    <i class="fas fa-file-pdf me-2"></i> ${file.name}
                                </button>
                            `;
                            // Add click handler to change the PDF source
                            li.querySelector('button').addEventListener('click', function() {
                                pdfEmbed.src = this.getAttribute('data-pdf-url');
                                pdfPlaceholderMessage.textContent = `Previewing: ${file.name}`; // Update placeholder message
                                // Ensure only the clicked pill is active
                                filePills.querySelectorAll('.nav-link').forEach(btn => btn.classList.remove('active'));
                                this.classList.add('active');
                            });
                            filePills.appendChild(li);
                        });

                    } else {
                        filePills.style.display = 'none';
                    }
                } else {
                    // No valid files: show placeholder
                    pdfEmbed.src = '';
                    pdfEmbed.style.display = 'none';
                    pdfPlaceholder.style.display = 'flex';
                    pdfPlaceholderMessage.textContent = "Upload one or more PDF Resumes";
                }
            });
        }
        
        if (jobDescriptionFileInput) {
            jobDescriptionFileInput.addEventListener('change', function () {
                const file = this.files[0];
                if (file) {
                    jobDescriptionFileNameSpan.textContent = file.name;
                } else {
                    jobDescriptionFileNameSpan.textContent = 'No file chosen';
                }
            });
        }

        const experienceTypeSelect = document.getElementById('{{ form.target_experience_type.id_for_label }}');
        const experienceFieldsDiv = document.getElementById('experience_fields');
        const minYearsInput = document.getElementById('{{ form.min_years_required.id_for_label }}');
        const maxYearsInput = document.getElementById('{{ form.max_years_required.id_for_label }}');

        function toggleExperienceFields() {
            if (!experienceTypeSelect || !experienceFieldsDiv || !minYearsInput || !maxYearsInput) {
                return;
            }
            const selectedValue = experienceTypeSelect.value;
            experienceFieldsDiv.style.display = 'none';
            minYearsInput.setAttribute('disabled', 'disabled');
            minYearsInput.removeAttribute('required');
            minYearsInput.value = '';
            maxYearsInput.setAttribute('disabled', 'disabled');
            maxYearsInput.removeAttribute('required');
            maxYearsInput.value = '';
            if (selectedValue === 'Specific Range (Years)') {
                experienceFieldsDiv.style.display = 'flex';
                minYearsInput.removeAttribute('disabled');
                minYearsInput.setAttribute('required', 'required');
                maxYearsInput.removeAttribute('disabled');
                maxYearsInput.setAttribute('required', 'required');
            } else if (selectedValue === 'Minimum Years Required') {
                experienceFieldsDiv.style.display = 'flex';
                minYearsInput.removeAttribute('disabled');
                minYearsInput.setAttribute('required', 'required');
            }
            updateFloatingLabel(experienceTypeSelect);
            updateFloatingLabel(minYearsInput);
            updateFloatingLabel(maxYearsInput);
        }

        if (experienceTypeSelect) {
            toggleExperienceFields();
            experienceTypeSelect.addEventListener('change', toggleExperienceFields);
        }

        // --- NEW COMPLEX PRELOADER LOGIC START ---
        const resumeForm = document.getElementById('resumeForm');
        const preloader = document.getElementById('preloader');
        const preloaderMessage = document.getElementById('preloaderMessage');
        const progressBar = document.getElementById('progressBar');
        const fileStatusList = document.getElementById('fileStatusList'); // NEW: Status list container
        const resultsSection = document.querySelector('.results-section');


        if (resumeForm) {
            resumeForm.addEventListener('submit', function(event) {
                const submitButton = this.querySelector('button[type="submit"]');

                // 1. Perform client-side validation check just before submission
                if (!this.checkValidity()) {
                    event.preventDefault();
                    // Optional: Scroll to the error or trigger browser validation display
                    return; 
                }
                
                // Prevent the default submission now
                event.preventDefault();

                // Get the list of files for the detailed status
                const filesToAnalyze = Array.from(document.getElementById('resumeInput').files);
                if (filesToAnalyze.length === 0) {
                    // This should be caught by checkValidity/required attribute, but good to have a fail-safe
                    alert('Please upload at least one resume.');
                    return;
                }

                // 2. CRITICAL: Disable button and show initial loading state
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Processing...';
                }
                
                // 3. Clear previous status and show preloader
                fileStatusList.innerHTML = '';
                progressBar.style.width = '0%';
                preloader.classList.add('show');
                preloaderMessage.textContent = 'Starting Batch Analysis...';


                // 4. Initialize status elements for each file
                const fileStatuses = filesToAnalyze.map(file => {
                    const item = document.createElement('div');
                    item.className = 'file-status-item pending';
                    item.innerHTML = `
                        <span class="file-name">${file.name}</span>
                        <span class="status-badge bg-secondary text-white">
                            <i class="fas fa-hourglass-start me-1"></i> Pending
                        </span>
                    `;
                    fileStatusList.appendChild(item);
                    return { element: item, name: file.name, status: 'pending' };
                });

                const totalFiles = fileStatuses.length;
                // Total steps: 1 (Initial Setup) + 3 steps per file
                const totalSteps = 1 + (totalFiles * 3); 
                let currentStep = 0;

                const startAnalysis = async () => {
                    
                    // --- Initial Step: Uploading/Setup ---
                    currentStep++;
                    preloaderMessage.textContent = `${currentStep}/${totalSteps}: Uploading files and setting up the analysis environment...`;
                    progressBar.style.width = `${(currentStep / totalSteps) * 100}%`;
                    await new Promise(resolve => setTimeout(resolve, 1000)); 

                    // --- Sequential processing of each file ---
                    for (let i = 0; i < totalFiles; i++) {
                        const fileStatus = fileStatuses[i];
                        const element = fileStatus.element;
                        
                        // --- Step 1: Parsing/Extraction ---
                        currentStep++;
                        element.classList.remove('pending');
                        element.classList.add('processing');
                        element.querySelector('.status-badge').className = 'status-badge bg-warning';
                        element.querySelector('.status-badge').innerHTML = `<span class="spinner-border spinner-border-sm spinner-sm me-1" role="status" aria-hidden="true"></span> Parsing Data`;
                        preloaderMessage.textContent = `${currentStep}/${totalSteps}: Extracting key data from ${fileStatus.name}...`;
                        progressBar.style.width = `${(currentStep / totalSteps) * 100}%`;
                        await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate time

                        // --- Step 2: LLM Analysis (The longest step) ---
                        currentStep++;
                        element.querySelector('.status-badge').innerHTML = `<span class="spinner-border spinner-border-sm spinner-sm me-1" role="status" aria-hidden="true"></span> AI Analysis`;
                        preloaderMessage.textContent = `${currentStep}/${totalSteps}: Running LLM analysis and scoring for ${fileStatus.name}...`;
                        progressBar.style.width = `${(currentStep / totalSteps) * 100}%`;
                        await new Promise(resolve => setTimeout(resolve, 3000)); // Simulate LLM time
                        
                        // --- Step 3: Finalizing Report ---
                        currentStep++;
                        element.querySelector('.status-badge').className = 'status-badge bg-success text-white'; // Change color to primary/info for reporting
                        element.querySelector('.status-badge').innerHTML = `<i class="fas fa-check-circle me-1"></i> Completed`;
                        element.classList.remove('processing');
                        element.classList.add('completed');
                        preloaderMessage.textContent = `${currentStep}/${totalSteps}: Finalizing report for ${fileStatus.name} (${i + 1} of ${totalFiles})...`;
                        progressBar.style.width = `${(currentStep / totalSteps) * 100}%`;

                        // Add a short delay before moving to the next file
                        if (i < totalFiles - 1) {
                             await new Promise(resolve => setTimeout(resolve, 500)); 
                        }
                    }

                    // --- Final Completion ---
                    preloaderMessage.textContent = `Batch Analysis Complete! Submitting data...`;
                    progressBar.style.width = '100%';
                    
                    // Final submission after the simulation
                    setTimeout(() => {
                        // Submit the form for real
                        resumeForm.submit();
                    }, 500); 
                };

                startAnalysis();
            });
        }
        // --- NEW COMPLEX PRELOADER LOGIC END ---


        if (resultsSection && resultsSection.dataset.analysisLoaded) {
            resultsSection.classList.add('show');
            const fadeInItems = document.querySelectorAll('.results-section .fade-in-item');
            fadeInItems.forEach((item, index) => {
                item.style.animationDelay = `${index * 0.1}s`;
                item.classList.add('show-animation');
            });
        }
        
        // Dynamic PDF Preview Switcher for POST-ANALYSIS tabs
        const candidateTabsContainer = document.getElementById('candidateTabs');
        if (candidateTabsContainer) {
            candidateTabsContainer.addEventListener('show.bs.tab', function (event) {
                const newTab = event.target;
                let pdfUrl = newTab.getAttribute('data-pdf-url');
                const candidateName = newTab.getAttribute('data-candidate-name');

                if (pdfUrl && pdfEmbed && pdfPlaceholder) {
                    // FIX: Append a unique query parameter to the PDF URL to bypass browser caching
                    const cacheBustingUrl = pdfUrl.includes('?') ? `${pdfUrl}&t=${Date.now()}` : `${pdfUrl}?t=${Date.now()}`;
                    pdfEmbed.src = cacheBustingUrl; 
                    
                    pdfEmbed.style.display = 'block';
                    pdfPlaceholder.style.display = 'none';
                    pdfPlaceholderMessage.textContent = `Previewing resume for ${candidateName}.`;
                } else if (pdfPlaceholder) {
                    // Fallback if URL is missing for some reason
                    pdfEmbed.style.display = 'none';
                    pdfPlaceholder.style.display = 'flex';
                    pdfPlaceholderMessage.textContent = `Resume preview not available for ${candidateName}.`;
                }
            });
        }


        function updateFloatingLabel(input) {
            const isSelectAndHasValue = input.tagName === 'SELECT' && input.value !== '';
            if (input.value || input === document.activeElement || isSelectAndHasValue) {
                input.classList.add('has-value');
            } else {
                input.classList.remove('has-value');
            }
        }
        
        // Initialize floating labels and attach event listeners
        document.querySelectorAll('.form-group-floating .form-control-custom, .form-group-floating .form-select-custom').forEach(input => {
            input.addEventListener('focus', () => updateFloatingLabel(input));
            input.addEventListener('blur', () => updateFloatingLabel(input));
            input.addEventListener('change', () => updateFloatingLabel(input));
            updateFloatingLabel(input);
        });
        
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
{% endblock %}