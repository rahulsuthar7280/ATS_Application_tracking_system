{% extends 'base.html' %}

{% block title %}Resume Analysis{% endblock %}
{% block page_heading %}AI Agent-Based Resume Screening and Evaluation{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap">
<link rel="stylesheet" href="../static/css/style_ats.css">

<style>
    /* Custom CSS to improve layout and design */

    :root {
        --primary-color: #007bff; /* Blue */
        --secondary-color: #6c757d; /* Gray */
        --background-color: #f8f9fa; /* Light Gray */
        --card-bg-color: #ffffff; /* White */
        --border-color: #e0e0e0; /* Light Gray Border */
        --shadow-color: rgba(0, 0, 0, 0.08); /* Soft Shadow */
        --text-color-primary: #343a40; /* Dark Gray */
        --text-color-secondary: #6c757d; /* Gray */
    }

    body {
        font-family: 'Inter', sans-serif;
        background-color: var(--background-color);
        color: var(--text-color-primary);
    }

    .container-main {
        max-width: 1400px;
        padding-top: 2rem;
        padding-bottom: 2rem;
    }

    .content-section-card {
        background-color: var(--card-bg-color);
        border-radius: 12px;
        padding: 2.5rem;
        box-shadow: 0 4px 15px var(--shadow-color);
        border: 1px solid var(--border-color);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .content-section-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
    }

    .section-title {
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }

    .section-description {
        color: var(--text-color-secondary);
        font-size: 0.95rem;
    }

    .nav-pills .nav-link {
        font-weight: 600;
        color: var(--text-color-secondary);
        border-radius: 8px;
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    .nav-pills .nav-link.active,
    .nav-pills .nav-link:hover {
        background-color: var(--primary-color);
        color: #fff;
    }

    .btn-file-upload {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem 1.5rem;
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        cursor: pointer;
        transition: border-color 0.3s ease, background-color 0.3s ease;
        color: var(--secondary-color);
    }

    .btn-file-upload:hover {
        border-color: var(--primary-color);
        background-color: #f0f8ff;
    }

    .form-group-floating label {
        color: var(--text-color-secondary);
        font-size: 0.9rem;
    }

    .form-control-custom, .form-select-custom {
        border-radius: 8px;
        border: 1px solid var(--border-color);
        padding: 0.75rem 1rem;
    }

    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        padding: 0.75rem 2rem;
        font-weight: 600;
        border-radius: 8px;
        transition: background-color 0.3s ease;
    }

    .btn-primary:hover {
        background-color: #0056b3;
        border-color: #0056b3;
    }

    /* Results section improvements */
    .results-section {
        margin-top: 3rem;
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.5s ease, transform 0.5s ease;
    }

    .results-section.show {
        opacity: 1;
        transform: translateY(0);
    }

    .summary-tile {
        padding: 1.5rem;
        background-color: #f0f2f5;
        border-radius: 10px;
        text-align: center;
        transition: transform 0.3s ease;
        border: 1px solid var(--border-color);
    }

    .summary-tile:hover {
        transform: translateY(-3px);
    }

    .summary-tile h6 {
        font-weight: 600;
        color: var(--primary-color);
    }

    .summary-tile p {
        font-size: 1.5rem;
        font-weight: 700;
        margin-top: 0.5rem;
    }
    
    .fitment-verdict {
        font-weight: 800;
        font-size: 1.5rem;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        display: inline-block;
        color: #fff;
    }

    .fitment-verdict.selected { background-color: #28a745; }
    .fitment-verdict.rejected { background-color: #dc3545; }
    .fitment-verdict.marginal { background-color: #ffc107; }

    .content-box {
        background-color: #f0f2f5;
        border-left: 4px solid var(--primary-color);
        padding: 1.5rem;
        border-radius: 8px;
        transition: transform 0.3s ease;
    }
    
    .content-box:hover {
        transform: scale(1.02);
    }

    .nav-tabs .nav-link {
        font-weight: 600;
        color: var(--secondary-color);
    }

    .nav-tabs .nav-link.active {
        color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .questions-list li {
        background-color: #f8f9fa;
        padding: 1rem 1.5rem;
        margin-bottom: 1rem;
        border-radius: 8px;
        border-left: 4px solid var(--primary-color);
    }

    /* New preloader styling */
    #preloader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background-color: rgba(240, 242, 245, 0.95);
        z-index: 1050;
        transition: opacity 0.3s ease;
        opacity: 0;
    }

    #preloader.show {
        display: flex;
        opacity: 1;
    }

    .spinner {
        width: 60px;
        height: 60px;
        border: 4px solid var(--primary-color);
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        position: relative;
    }

    .spinner::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80px;
        height: 80px;
        border: 4px solid rgba(0, 123, 255, 0.3);
        border-radius: 50%;
        animation: pulse 1.5s ease-out infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes pulse {
        0% { transform: scale(0.8); opacity: 1; }
        50% { transform: scale(1.2); opacity: 0; }
        100% { transform: scale(0.8); opacity: 1; }
    }
    
    .preloader-text {
        color: var(--text-color-primary);
        font-size: 1.2rem;
        font-weight: 500;
        margin-top: 2rem;
        animation: fadeIn 1s ease-in-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

<div class="container container-main">
    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="content-section-card h-100">
                <h2 class="section-title mb-1">Resume & Job Analysis</h2>
                <p class="section-description mb-4">
                    Follow these steps to upload candidate details and get a comprehensive AI analysis.
                </p>

                <form method="post" enctype="multipart/form-data" id="resumeForm">
                    {% csrf_token %}

                    <ul class="nav nav-pills nav-fill mb-4" id="formStepsTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="step1-tab" data-bs-toggle="pill" data-bs-target="#step1" type="button" role="tab" aria-controls="step1" aria-selected="true">
                                <i class="fas fa-1 me-2"></i> Resume
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="step2-tab" data-bs-toggle="pill" data-bs-target="#step2" type="button" role="tab" aria-controls="step2" aria-selected="false">
                                <i class="fas fa-2 me-2"></i> Job Details
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="formStepsTabContent">
                        <div class="tab-pane fade show active" id="step1" role="tabpanel" aria-labelledby="step1-tab">
                            <h5 class="section-sub-title mb-3"><i class="fas fa-file-pdf me-2"></i> Upload Candidate Resume</h5>
                            <div class="file-input-wrapper file-input-lg">
                                <input type="file" id="resumeInput" name="{{ form.resume_pdf.name }}" accept="application/pdf" multiple required>
                                <div class="btn-file-upload">
                                    <i class="fas fa-cloud-upload-alt fa-2x"></i>
                                    <span id="resumeFileName" class="ms-3">Click to upload a PDF resume</span>
                                </div>
                            </div>
                            <div class="d-flex justify-content-end mt-4">
                                <button class="btn btn-secondary" type="button" id="nextStepBtn">
                                    Next Step <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="step2" role="tabpanel" aria-labelledby="step2-tab">
                            <h5 class="section-sub-title mb-3"><i class="fas fa-briefcase me-2"></i> Job Requirements</h5>

                            <div class="mb-4">
                                <label class="form-label">Job Description Source</label>
                                <div class="btn-group w-100" role="group" aria-label="Job Description Source">
                                    <input type="radio" class="btn-check" name="jdSource" id="selectJdRadio" value="select" autocomplete="off" checked>
                                    <label class="btn btn-outline-primary" for="selectJdRadio">Select Existing</label>
                                    <input type="radio" class="btn-check" name="jdSource" id="uploadJdRadio" value="upload" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="uploadJdRadio">Upload New</label>
                                </div>
                            </div>
                            <div id="jdSourceFields">
                                <div id="selectJdSection">
                                    <div class="form-group-floating mb-4">
                                        <select class="form-select-custom" id="jobDescriptionSelect" name="job_description_id" required>
                                            <option value="">-- Select an Existing Job Description --</option>
                                            {% for doc in job_description_documents %}
                                            <option value="{{ doc.id }}">{{ doc.title }}</option>
                                            {% endfor %}
                                        </select>
                                        <label for="jobDescriptionSelect">Select Existing JD</label>
                                    </div>
                                </div>
                                <div id="uploadJdSection" style="display: none;">
                                    <div class="file-input-wrapper mb-4">
                                        <input type="file" id="jobDescriptionInput" name="{{ form.job_description.name }}" accept=".pdf,.doc,.docx,.txt">
                                        <div class="btn-file-upload">
                                            <i class="fas fa-file-word fa-2x"></i>
                                            <span id="jobDescriptionFileName" class="ms-3">No file chosen</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group-floating mb-4">
                                <input type="text" class="form-control-custom" id="{{ form.job_role.id_for_label }}" name="{{ form.job_role.name }}" value="{{ form.job_role.value|default:'' }}" {% if form.job_role.field.required %}required{% endif %}>
                                <label for="{{ form.job_role.id_for_label }}">
                                    <i class="fas fa-tag me-2"></i> Job Role
                                </label>
                            </div>

                            <div class="form-group-floating mb-4">
                                <select class="form-select-custom" id="{{ form.target_experience_type.id_for_label }}" name="{{ form.target_experience_type.name }}" {% if form.target_experience_type.field.required %}required{% endif %}>
                                    {% for value, label in form.target_experience_type.field.choices %}
                                    <option value="{{ value }}" {% if form.target_experience_type.value == value %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                                <label for="{{ form.target_experience_type.id_for_label }}">
                                    <i class="fas fa-chart-line me-2"></i> Experience Level
                                </label>
                            </div>

                            <div id="experience_fields" class="row g-3 px-3 w-100 mt-2" style="display: none;">
                                <div class="col-sm-6">
                                    <div class="form-group-floating">
                                        <input type="number" class="form-control-custom" id="{{ form.min_years_required.id_for_label }}" name="{{ form.min_years_required.name }}" value="{{ form.min_years_required.value|default:'' }}" min="0" step="1">
                                        <label for="{{ form.min_years_required.id_for_label }}">
                                            <i class="fas fa-sort-numeric-up me-2"></i> Min. Years
                                        </label>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="form-group-floating">
                                        <input type="number" class="form-control-custom" id="{{ form.max_years_required.id_for_label }}" name="{{ form.max_years_required.name }}" value="{{ form.max_years_required.value|default:'' }}" min="0" step="1">
                                        <label for="{{ form.max_years_required.id_for_label }}">
                                            <i class="fas fa-sort-numeric-down me-2"></i> Max. Years
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between mt-4">
                                <button class="btn btn-secondary" type="button" id="backStepBtn">
                                    <i class="fas fa-arrow-left me-2"></i> Back
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-magic me-2"></i> Analyse Resume
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="col-md-6">
            <div class="content-section-card pdf-preview-section h-100">
                <embed id="pdfEmbed" class="pdf-embed" type="application/pdf"
                       style="display: {% if resume_url %}block{% else %}none{% endif %};"
                       {% if resume_url %}src="{{ resume_url }}#toolbar=0&navpanes=0"{% endif %}>

                <div class="pdf-placeholder" id="pdfPlaceholder"
                     style="display: {% if resume_url %}none{% else %}flex{% endif %};">
                    <i class="fas fa-file-pdf fa-4x mb-3"></i>
                    <p class="message" id="pdfPlaceholderMessage">Upload a PDF Resume to Preview</p>
                    <p class="sub-message">The AI analysis will begin shortly after.</p>
                    <p class="error-message" id="pdfErrorMessage" style="display: none;"></p>
                </div>
            </div>
        </div>
    </div>

    {% if analysis_result %}
        <div class="content-section-card results-section show" data-analysis-loaded="true">
            <h2 class="section-title">AI Analysis for <span class="text-primary">{{ analysis_result.full_name|default:"Candidate" }}</span></h2>
            
            <ul class="nav nav-tabs" id="analysisTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab" aria-controls="summary" aria-selected="true">
                        <i class="fas fa-chart-pie me-2"></i> Summary
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact" type="button" role="tab" aria-controls="contact" aria-selected="false">
                        <i class="fas fa-address-book me-2"></i> Contact Info
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab" aria-controls="details" aria-selected="false">
                        <i class="fas fa-info-circle me-2"></i> Detailed Analysis
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="skills-projects-tab" data-bs-toggle="tab" data-bs-target="#skills-projects" type="button" role="tab" aria-controls="skills-projects" aria-selected="false">
                        <i class="fas fa-code me-2"></i> Skills & Projects
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="recommendations-tab" data-bs-toggle="tab" data-bs-target="#recommendations" type="button" role="tab" aria-controls="recommendations" aria-selected="false">
                        <i class="fas fa-lightbulb me-2"></i> Recommendations
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="questions-tab" data-bs-toggle="tab" data-bs-target="#questions" type="button" role="tab" aria-controls="questions" aria-selected="false">
                        <i class="fas fa-question-circle me-2"></i> Interview Questions
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="analysisTabContent">
                <div class="tab-pane fade show active" id="summary" role="tabpanel" aria-labelledby="summary-tab">
                    <div class="row g-4 mb-4">
                        <div class="col-md-3 col-sm-6">
                            <div class="summary-tile fade-in-item">
                                <h6><i class="fas fa-briefcase me-2"></i> Job Role</h6>
                                <p>{{ form.job_role.value|default:"N/A" }}</p>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="summary-tile fade-in-item">
                                <h6><i class="fas fa-chart-line me-2"></i> Overall Experience</h6>
                                <p>{{ analysis_result.overall_experience|default:"N/A" }}</p>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="summary-tile fade-in-item">
                                <h6><i class="fas fa-thumbs-up me-2"></i> Hiring Recommendation</h6>
                                <p class="
                                    {% if analysis_result.hiring_recommendation == 'Hire' or analysis_result.hiring_recommendation == 'Strong Hire' %}text-success
                                    {% elif analysis_result.hiring_recommendation == 'Reject' %}text-danger
                                    {% else %}text-warning{% endif %}">
                                    {{ analysis_result.hiring_recommendation|default:"N/A" }}
                                </p>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="summary-tile fade-in-item">
                                <h6><i class="fas fa-percentage me-2"></i> Experience Match</h6>
                                <p class="text-success">{{ analysis_result.experience_match|default:"N/A" }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="row g-4 mb-4">
                        <div class="col-md-6">
                            <div class="fitment-verdict-box fade-in-item">
                                <h5 class="text-primary"><i class="fas fa-shield-alt me-2"></i> Candidate Fitment Verdict</h5>
                                <p class="fitment-verdict mt-3 
                                        {% if analysis_result.fitment_verdict == 'SELECTED' %}selected
                                        {% elif analysis_result.fitment_verdict == 'MARGINALLY FIT' %}marginal
                                        {% else %}rejected{% endif %}">
                                    {{ analysis_result.fitment_verdict|default:"N/A" }}
                                </p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="content-box fade-in-item">
                                <h6><i class="fas fa-sitemap me-2"></i> Strategic Alignment</h6>
                                <p>{{ analysis_result.candidate_fitment_analysis.strategic_alignment|default:"N/A" }}</p>
                            </div>
                        </div>
                    </div>
                    <h4 class="section-title mt-5">Core Competency Assessment</h4>
                    <div class="row g-4 mb-4">
                        {% if analysis_result.core_competencies_assessment %}
                            {% for competency in analysis_result.core_competencies_assessment %}
                                <div class="col-md-3 col-sm-6">
                                    <div class="summary-tile fade-in-item">
                                        <h6><i class="fas fa-star me-2"></i> {{ competency.competency|default:"N/A" }}</h6>
                                        <p class="
                                            {% if competency.level == 'Excellent' or competency.level == 'Advanced' %}text-success
                                            {% elif competency.level == 'Proficient' %}text-primary
                                            {% elif competency.level == 'Intermediate' %}text-warning
                                            {% else %}text-muted{% endif %}
                                        ">
                                            {{ competency.level|default:"N/A" }}
                                        </p>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="col-12">
                                <div class="content-box text-center text-muted fade-in-item">
                                    <p>No core competency assessment data available.</p>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">
                    <h4 class="section-title">Candidate Contact Information</h4>
                    <div class="row g-4 mb-4">
                        <div class="col-md-4 col-sm-6">
                            <div class="summary-tile fade-in-item">
                                <h6><i class="fas fa-user me-2"></i> Full Name</h6>
                                <p>{{ analysis_result.full_name|default:"N/A" }}</p>
                            </div>
                        </div>
                        <div class="col-md-4 col-sm-6">
                            <div class="summary-tile fade-in-item">
                                <h6><i class="fas fa-phone me-2"></i> Phone Number</h6>
                                <p>{{ analysis_result.phone_no|default:"N/A" }}</p>
                            </div>
                        </div>
                        <div class="col-md-4 col-sm-6">
                            <div class="summary-tile fade-in-item">
                                <h6><i class="fas fa-envelope me-2"></i> Email Address</h6>
                                <p>{{ analysis_result.email|default:"N/A" }}</p>
                            </div>
                        </div>
                        <div class="col-md-4 col-sm-6">
                            <div class="summary-tile fade-in-item">
                                <h6><i class="fab fa-linkedin me-2"></i> LinkedIn Profile</h6>
                                {% if analysis_result.linkedin_url %}
                                    <p><a href="{{ analysis_result.linkedin_url }}" target="_blank" class="text-primary">{{ analysis_result.linkedin_url|truncatechars:30 }}</a></p>
                                {% else %}
                                    <p>N/A</p>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4 col-sm-6">
                            <div class="summary-tile fade-in-item">
                                <h6><i class="fab fa-github me-2"></i> GitHub Profile</h6>
                                {% if analysis_result.github_url %}
                                    <p><a href="{{ analysis_result.github_url }}" target="_blank" class="text-primary">{{ analysis_result.github_url|truncatechars:30 }}</a></p>
                                {% else %}
                                    <p>N/A</p>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4 col-sm-6">
                            <div class="summary-tile fade-in-item">
                                <h6><i class="fas fa-map-marker-alt me-2"></i> Current Company Address</h6>
                                <p>{{ analysis_result.current_company_address|default:"N/A" }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="details" role="tabpanel" aria-labelledby="details-tab">
                    <h4 class="section-title">Deep-Dive Scoring Matrix</h4>
                    <div class="table-responsive fade-in-item">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Evaluation Dimension</th>
                                    <th>Weight</th>
                                    <th>Score</th>
                                    <th>Evidence-Based Justification</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in analysis_result.scoring_matrix %}
                                    <tr>
                                        <td class="fw-bold">{{ item.dimension|default:"N/A" }}</td>
                                        <td>{{ item.weight|default:"N/A" }}</td>
                                        <td>{{ item.score|default:"N/A" }}</td>
                                        <td>{{ item.justification|default:"N/A" }}</td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">No scoring matrix data available.</td>
                                    </tr>
                                {% endfor %}
                                <tr>
                                    <td class="fw-bold">âž¤ Aggregate Score</td>
                                    <td>100%</td>
                                    <td class="fw-bold">{{ analysis_result.aggregate_score|default:"N/A" }}</td>
                                    <td></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h4 class="section-title mt-5">Detailed Analysis Summary</h4>
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="content-box fade-in-item">
                                <h6><i class="fas fa-user-circle me-2 text-primary"></i> Candidate Overview</h6>
                                <p>{{ analysis_result.analysis_summary.candidate_overview|default:"No candidate overview provided." }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="content-box fade-in-item">
                                <h6><i class="fas fa-chart-line me-2 text-success"></i> Quantifiable Impact</h6>
                                <p>{{ analysis_result.candidate_fitment_analysis.quantifiable_impact|default:"N/A" }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="content-box fade-in-item">
                                <h6><i class="fas fa-exclamation-triangle me-2 text-danger"></i> Potential Gaps & Risks</h6>
                                <p>{{ analysis_result.candidate_fitment_analysis.potential_gaps_risks|default:"N/A" }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="content-box fade-in-item">
                                <h6><i class="fas fa-briefcase me-2 text-info"></i> Comparable Experience</h6>
                                <p>{{ analysis_result.candidate_fitment_analysis.comparable_experience_analysis|default:"N/A" }}</p>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="content-box fade-in-item">
                                <h6><i class="fas fa-check-circle me-2 text-secondary"></i> Conclusion</h6>
                                <p>{{ analysis_result.analysis_summary.conclusion|default:"No conclusion provided." }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="skills-projects" role="tabpanel" aria-labelledby="skills-projects-tab">
                    <h4 class="section-title">Technical Skills & Education</h4>
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="content-box fade-in-item">
                                <h6><i class="fas fa-laptop-code me-2 text-primary"></i> Technical Prowess</h6>
                                <ul>
                                    {% for skill_category, skills in analysis_result.analysis_summary.technical_prowess.items %}
                                        <li><strong>{{ skill_category }}:</strong> {{ skills|join:", " }}</li>
                                    {% empty %}
                                        <li>No technical skills identified.</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="content-box fade-in-item">
                                <h6><i class="fas fa-graduation-cap me-2 text-primary"></i> Education & Certifications</h6>
                                <ul>
                                    {% for edu in analysis_result.analysis_summary.education_certifications.education %}
                                        <li>{{ edu }}</li>
                                    {% empty %}
                                        <li>No education details provided.</li>
                                    {% endfor %}
                                    {% for cert in analysis_result.analysis_summary.education_certifications.certifications %}
                                        <li>{{ cert }}</li>
                                    {% empty %}
                                        <li>No certifications provided.</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <h4 class="section-title mt-5">Project Impact & Achievements</h4>
                    <div class="row g-4">
                        {% for project in analysis_result.analysis_summary.project_impact %}
                            <div class="col-12">
                                <div class="content-box fade-in-item">
                                    <h6><i class="fas fa-project-diagram me-2 text-warning"></i> {{ project.title|default:"Project Title N/A" }}</h6>
                                    <p><strong>Company:</strong> {{ project.company|default:"N/A" }}</p>
                                    <p><strong>Role:</strong> {{ project.role|default:"N/A" }}</p>
                                    <p><strong>Achievements:</strong></p>
                                    <ul>
                                        {% for achievement in project.achievements %}
                                            <li>{{ achievement }}</li>
                                        {% empty %}
                                            <li>No specific achievements listed.</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        {% empty %}
                            <div class="col-12">
                                <div class="content-box text-muted fade-in-item">
                                    <p>No project impact or achievements found.</p>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="tab-pane fade" id="recommendations" role="tabpanel" aria-labelledby="recommendations-tab">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="content-box fade-in-item">
                                <h6><i class="fas fa-tasks me-2 text-primary"></i> Bench & Alternative Roles</h6>
                                <p><strong>Retain for future consideration?</strong> {{ analysis_result.bench_recommendation.retain|default:"N/A" }}</p>
                                <p><strong>Ideal Future Role(s):</strong> {{ analysis_result.bench_recommendation.ideal_future_roles|join:", "|default:"N/A" }}</p>
                                <p><strong>Justification:</strong> {{ analysis_result.bench_recommendation.justification|default:"N/A" }}</p>
                                <h6 class="mt-4"><i class="fas fa-exchange-alt me-2 text-info"></i> Alternative Role Recommendations</h6>
                                <ul>
                                    {% for role in analysis_result.alternative_role_recommendations %}
                                        <li><strong>{{ role.role|default:"N/A" }}:</strong> {{ role.explanation|default:"N/A" }}</li>
                                    {% empty %}
                                        <li>No alternative roles suggested.</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="content-box fade-in-item">
                                <h6><i class="fas fa-lightbulb me-2 text-warning"></i> Automated Recruiter Insights</h6>
                                <p><strong>Red Flag Detection:</strong> {{ analysis_result.automated_recruiter_insights.red_flag_detection|default:"None" }}</p>
                                <p><strong>Growth Indicators:</strong> {{ analysis_result.automated_recruiter_insights.growth_indicators|default:"None" }}</p>
                                <p><strong>Cross-Industry Potential:</strong> {{ analysis_result.automated_recruiter_insights.cross_industry_potential|default:"None" }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="questions" role="tabpanel" aria-labelledby="questions-tab">
                    <h4 class="section-title">Suggested Interview Questions for <span class="text-primary">{{ analysis_result.full_name|default:"the Candidate" }}</span></h4>
                    <ul class="questions-list">
                        {% for question in analysis_result.interview_questions %}
                            <li class="fade-in-item">{{ question }}</li>
                        {% empty %}
                            <li class="text-muted fade-in-item">No specific questions were generated.</li>
                        {% endfor %}
                    </ul>
                    <div class="d-flex justify-content-end mt-4 pt-3 border-top fade-in-item">
                        {% if analysis_result.id %}
                            <a href="{% url 'interview_status' candidate_id=analysis_result.id %}" class="btn btn-primary-custom btn-lg">
                                Next step <i class="fas fa-arrow-right btn-icon-right"></i>
                            </a>
                        {% else %}
                            <button type="button" class="btn btn-secondary btn-lg" disabled>
                                Proceed to Interview (No Candidate ID) <i class="fas fa-arrow-right btn-icon-right"></i>
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        {% endif %}
</div>

<div id="preloader">
    <div class="spinner"></div>
    <p class="preloader-text" id="preloaderMessage">Analyzing Resume...</p>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const nextStepBtn = document.getElementById('nextStepBtn');
        const backStepBtn = document.getElementById('backStepBtn');
        const step1Tab = document.getElementById('step1-tab');
        const step2Tab = document.getElementById('step2-tab');

        if (nextStepBtn) {
            nextStepBtn.addEventListener('click', function() {
                const step2TabInstance = new bootstrap.Tab(step2Tab);
                step2TabInstance.show();
            });
        }
        
        if (backStepBtn) {
            backStepBtn.addEventListener('click', function() {
                const step1TabInstance = new bootstrap.Tab(step1Tab);
                step1TabInstance.show();
            });
        }

        const selectJdRadio = document.getElementById('selectJdRadio');
        const uploadJdRadio = document.getElementById('uploadJdRadio');
        const selectJdSection = document.getElementById('selectJdSection');
        const uploadJdSection = document.getElementById('uploadJdSection');
        const jobDescriptionSelect = document.getElementById('jobDescriptionSelect');
        const jobDescriptionInput = document.getElementById('jobDescriptionInput');

        function toggleJdSection() {
            if (selectJdRadio.checked) {
                selectJdSection.style.display = 'block';
                uploadJdSection.style.display = 'none';
                jobDescriptionSelect.setAttribute('required', 'required'); 
                jobDescriptionInput.removeAttribute('required');
            } else {
                selectJdSection.style.display = 'none';
                uploadJdSection.style.display = 'block';
                jobDescriptionInput.setAttribute('required', 'required');
                jobDescriptionSelect.removeAttribute('required');
            }
        }

        if (selectJdRadio && uploadJdRadio) {
            selectJdRadio.addEventListener('change', toggleJdSection);
            uploadJdRadio.addEventListener('change', toggleJdSection);
            toggleJdSection();
        }

        const resumeFileInput = document.getElementById('resumeInput');
        const resumeFileNameSpan = document.getElementById('resumeFileName');
        const jobDescriptionFileInput = document.getElementById('jobDescriptionInput');
        const jobDescriptionFileNameSpan = document.getElementById('jobDescriptionFileName');
        const pdfEmbed = document.getElementById('pdfEmbed');
        const pdfPlaceholder = document.getElementById('pdfPlaceholder');
        const pdfErrorMessage = document.getElementById('pdfErrorMessage');
        const pdfPlaceholderMessage = document.getElementById('pdfPlaceholderMessage');


        if (pdfEmbed && pdfEmbed.src && pdfEmbed.src !== window.location.href + '#toolbar=0&navpanes=0') {
            pdfEmbed.style.display = 'block';
            if (pdfPlaceholder) pdfPlaceholder.style.display = 'none';
        } else {
            if (pdfEmbed) pdfEmbed.style.display = 'none';
            if (pdfPlaceholder) pdfPlaceholder.style.display = 'flex';
        }

        if (resumeFileInput) {
            resumeFileInput.addEventListener('change', function () {
                const files = this.files;
                if (files.length > 0) {
                    if (files.length > 10) {
                        resumeFileNameSpan.textContent = "Error: Please select a maximum of 10 files.";
                        this.value = ''; // Clear the selected files
                        pdfEmbed.style.display = 'none';
                        pdfPlaceholder.style.display = 'flex';
                        pdfPlaceholderMessage.textContent = "Upload a PDF Resume to Preview";
                        pdfErrorMessage.style.display = 'block';
                        return;
                    }

                    if (files.length === 1) {
                        const file = files[0];
                        if (file.type === 'application/pdf') {
                            resumeFileNameSpan.textContent = file.name;
                            const fileURL = URL.createObjectURL(file);
                            pdfEmbed.src = fileURL + '#toolbar=0&navpanes=0';
                            pdfEmbed.style.display = 'block';
                            pdfPlaceholder.style.display = 'none';
                            pdfErrorMessage.style.display = 'none';
                        } else {
                            resumeFileNameSpan.textContent = "Invalid file type. Please upload a PDF.";
                            pdfEmbed.src = '';
                            pdfEmbed.style.display = 'none';
                            pdfPlaceholder.style.display = 'flex';
                            pdfErrorMessage.textContent = "Please upload a valid PDF file for resume preview.";
                            pdfErrorMessage.style.display = 'block';
                        }
                    } else {
                        resumeFileNameSpan.textContent = files.length + " files selected";
                        pdfEmbed.style.display = 'none';
                        pdfPlaceholder.style.display = 'flex';
                        pdfPlaceholderMessage.textContent = "Preview is available for single PDF uploads only.";
                        pdfErrorMessage.style.display = 'none';
                    }
                } else {
                    resumeFileNameSpan.textContent = 'Click to upload a PDF resume';
                    pdfEmbed.src = '';
                    pdfEmbed.style.display = 'none';
                    pdfPlaceholder.style.display = 'flex';
                    pdfPlaceholderMessage.textContent = "Upload a PDF Resume to Preview";
                    pdfErrorMessage.style.display = 'none';
                }
            });
        }

        if (jobDescriptionFileInput) {
            jobDescriptionFileInput.addEventListener('change', function () {
                const file = this.files[0];
                if (file) {
                    jobDescriptionFileNameSpan.textContent = file.name;
                } else {
                    jobDescriptionFileNameSpan.textContent = 'No file chosen';
                }
            });
        }

        const experienceTypeSelect = document.getElementById('{{ form.target_experience_type.id_for_label }}');
        const experienceFieldsDiv = document.getElementById('experience_fields');
        const minYearsInput = document.getElementById('{{ form.min_years_required.id_for_label }}');
        const maxYearsInput = document.getElementById('{{ form.max_years_required.id_for_label }}');

        function toggleExperienceFields() {
            if (!experienceTypeSelect || !experienceFieldsDiv || !minYearsInput || !maxYearsInput) {
                return;
            }
            const selectedValue = experienceTypeSelect.value;
            experienceFieldsDiv.style.display = 'none';
            minYearsInput.setAttribute('disabled', 'disabled');
            minYearsInput.value = '';
            maxYearsInput.setAttribute('disabled', 'disabled');
            maxYearsInput.value = '';
            if (selectedValue === 'Specific Range (Years)' || selectedValue === 'Minimum Years Required') {
                experienceFieldsDiv.style.display = 'flex';
                minYearsInput.removeAttribute('disabled');
                if (selectedValue === 'Specific Range (Years)') {
                    maxYearsInput.removeAttribute('disabled');
                }
            }
            updateFloatingLabel(experienceTypeSelect);
        }

        if (experienceTypeSelect) {
            toggleExperienceFields();
            experienceTypeSelect.addEventListener('change', toggleExperienceFields);
        }

        const resumeForm = document.getElementById('resumeForm');
        const preloader = document.getElementById('preloader');
        const preloaderMessage = document.getElementById('preloaderMessage');
        const resultsSection = document.querySelector('.results-section');

        if (resumeForm) {
            resumeForm.addEventListener('submit', function(event) {
                if (!resumeFileInput.files.length || resumeFileInput.files[0].type !== 'application/pdf') {
                    return; 
                }
                
                event.preventDefault();
                
                preloader.classList.add('show');
                this.submit();
            });
        }

        if (resultsSection && resultsSection.dataset.analysisLoaded) {
            resultsSection.classList.add('show');
            const fadeInItems = document.querySelectorAll('.results-section .fade-in-item');
            fadeInItems.forEach((item, index) => {
                item.style.animationDelay = `${index * 0.1}s`;
                item.classList.add('show-animation');
            });
        }

        function updateFloatingLabel(input) {
            const isSelectAndHasValue = input.tagName === 'SELECT' && input.value !== '';
            if (input.value || input === document.activeElement || isSelectAndHasValue) {
                input.classList.add('has-value');
            } else {
                input.classList.remove('has-value');
            }
        }

        document.querySelectorAll('.form-group-floating .form-control-custom, .form-group-floating .form-select-custom').forEach(input => {
            input.addEventListener('focus', () => updateFloatingLabel(input));
            input.addEventListener('blur', () => updateFloatingLabel(input));
            input.addEventListener('change', () => updateFloatingLabel(input));
            updateFloatingLabel(input);
        });
    });
</script>
{% endblock %}